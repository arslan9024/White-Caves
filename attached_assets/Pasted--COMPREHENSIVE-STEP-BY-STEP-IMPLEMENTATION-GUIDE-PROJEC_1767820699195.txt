
## **COMPREHENSIVE STEP-BY-STEP IMPLEMENTATION GUIDE**

### **ðŸ“‹ PROJECT OVERVIEW**
**Project:** White Caves Real Estate LLC Web Application  
**Developer:** Arslan Malik  
**Assistant:** Linda (AI Assistant)  
**Tech Stack:** MERN (MongoDB, Express, React, Node.js) with UAE-specific features

White Caves Real Estate LLC
Luxury Real Estate Platform - Dubai, UAE
White Caves Real Estate LLC is a comprehensive digital platform specializing in the Dubai luxury real estate market. Our platform provides end-to-end solutions for property sales, rentals, and management with AI-powered automation.

Company Information
White Caves Real Estate LLC
Location: Dubai, United Arab Emirates
Contact: +971 56 361 6136
Email:admin@whitecaves.com
Website: whitecaves.com


## **âœ… PHASE 1: SETUP & ENVIRONMENT CONFIGURATION**

### **Step 1.1: Project Structure Setup**
```bash
# Create project structure
mkdir white-caves-realestate
cd white-caves-realestate
mkdir client server shared scripts
```

### **Step 1.2: Environment Files Setup**
**Create these files:**

**`.env.template` (Root directory):**
```env
# === MANDATORY FOR VERCEL ===
REACT_APP_API_URL=https://your-domain.vercel.app/api
REACT_APP_PUBLIC_URL=https://your-domain.vercel.app
NODE_ENV=production

# === MONGODB ===
MONGODB_URI=your_mongodb_connection_string
MONGODB_DB=whitecaves_realestate

# === AUTHENTICATION ===
JWT_SECRET=your_jwt_secret_min_32_chars
JWT_EXPIRE=7d

# === GOOGLE INTEGRATION ===
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_CALLBACK_URL=https://your-domain.vercel.app/api/auth/google/callback

# === WHATSAPP BUSINESS API ===
WHATSAPP_API_KEY=your_whatsapp_api_key
WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id

# === EMAIL ===
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your_app_password
```

**`.gitignore` (Root directory):**
```gitignore
# Environment files
.env
.env.local
.env.production.local

# Dependencies
node_modules/
client/node_modules/
server/node_modules/

# Build outputs
client/build/
server/dist/

# Logs
*.log
npm-debug.log*

# IDE files
.vscode/
.idea/
*.swp
*.swo

# OS files
.DS_Store
Thumbs.db
```

**`client/.env.production.local`:**
```env
REACT_APP_API_URL=https://your-domain.vercel.app/api
REACT_APP_PUBLIC_URL=https://your-domain.vercel.app
REACT_APP_NODE_ENV=production
```

### **Step 1.3: Package.json Setup**
**Root `package.json`:**
```json
{
  "name": "white-caves-realestate",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "concurrently \"npm run dev:client\" \"npm run dev:server\"",
    "dev:client": "cd client && npm start",
    "dev:server": "cd server && npm run dev",
    "build": "npm run build:client && npm run build:server",
    "build:client": "cd client && CI=false npm run build",
    "build:server": "cd server && npm run build",
    "start": "cd server && npm start",
    "test": "npm run test:client && npm run test:server",
    "test:client": "cd client && npm test",
    "test:server": "cd server && npm test",
    "lint": "eslint . --ext js,jsx --fix",
    "clean": "rm -rf client/node_modules server/node_modules client/build",
    "setup": "npm run clean && npm install && cd client && npm install && cd ../server && npm install",
    "deploy": "vercel --prod"
  },
  "devDependencies": {
    "concurrently": "^8.0.0"
  },
  "engines": {
    "node": ">=18.0.0",
    "npm": ">=9.0.0"
  }
}
```

---

## **âœ… PHASE 2: DATABASE & CORE SCHEMAS**

### **Step 2.1: Enhanced Property Schema Implementation**
**File:** `server/models/Property.js`

```javascript
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const PropertySchema = new Schema({
  // Core Identification
  propertyCode: { type: String, unique: true, required: true },
  emirate: {
    type: String,
    enum: ['Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman', 'RAK', 'Fujairah', 'UQ'],
    required: true
  },
  
  // UAE Legal & Compliance
  legalDetails: {
    dldNumber: String,
    ejariNumber: String,
    dewaNumber: String,
    titleDeed: String,
    completionCertificate: String,
    nocFromDeveloper: Boolean
  },
  
  // Property Specifications
  specifications: {
    propertyType: {
      type: String,
      enum: ['Apartment', 'Villa', 'Townhouse', 'Penthouse', 'Office', 'Warehouse', 'Land', 'Commercial']
    },
    bedrooms: Number,
    bathrooms: Number,
    builtUpArea: Number,
    plotArea: Number,
    maidRoom: { type: Boolean, default: false }
  },
  
  // Pricing & Financials
  pricing: {
    amount: { type: Number, required: true },
    currency: { type: String, default: 'AED', enum: ['AED', 'USD', 'EUR'] },
    type: { type: String, enum: ['sale', 'rent'] },
    paymentTerms: {
      rental: ['1 Cheque', '2 Cheques', '4 Cheques', '12 Cheques'],
      sale: ['Cash', 'Mortgage', 'Installments']
    }
  },
  
  // Status Tracking
  status: {
    current: {
      type: String,
      enum: ['available', 'reserved', 'under_contract', 'sold', 'rented', 'off_market'],
      default: 'available'
    },
    history: [{
      status: String,
      changedBy: { type: Schema.Types.ObjectId, ref: 'User' },
      timestamp: { type: Date, default: Date.now },
      notes: String
    }]
  },
  
  // Timestamps
  createdAt: { type: Date, default: Date.now },
  updatedAt: Date,
  listedDate: Date
}, {
  timestamps: true,
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// Indexes for performance
PropertySchema.index({ propertyCode: 1 });
PropertySchema.index({ emirate: 1, status: 1 });
PropertySchema.index({ 'pricing.amount': 1 });
PropertySchema.index({ 'specifications.propertyType': 1 });

module.exports = mongoose.model('Property', PropertySchema);
```

### **Step 2.2: Arabic/English Language System**
**File:** `client/src/utils/languageConfig.js`

```javascript
const languageConfig = {
  // Storage configuration
  storage: {
    key: 'whitecaves_language',
    default: 'en',
    supported: ['en', 'ar']
  },
  
  // RTL configuration
  rtl: {
    ar: {
      direction: 'rtl',
      fontFamily: "'Cairo', 'Noto Sans Arabic', sans-serif",
      textAlign: 'right'
    },
    en: {
      direction: 'ltr',
      fontFamily: "'Inter', -apple-system, sans-serif",
      textAlign: 'left'
    }
  },
  
  // Translations
  translations: {
    common: {
      en: {
        search: 'Search Properties',
        filter: 'Filter',
        viewDetails: 'View Details',
        contactAgent: 'Contact Agent',
        price: 'Price',
        bedrooms: 'Bedrooms',
        bathrooms: 'Bathrooms'
      },
      ar: {
        search: 'Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø§Ø±Ø§Øª',
        filter: 'ØªØµÙÙŠØ©',
        viewDetails: 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„',
        contactAgent: 'Ø§ØªØµÙ„ Ø¨Ø§Ù„ÙˆÙƒÙŠÙ„',
        price: 'Ø§Ù„Ø³Ø¹Ø±',
        bedrooms: 'ØºØ±Ù Ù†ÙˆÙ…',
        bathrooms: 'Ø­Ù…Ø§Ù…Ø§Øª'
      }
    },
    
    propertyTypes: {
      en: ['Apartment', 'Villa', 'Townhouse', 'Penthouse', 'Office', 'Warehouse'],
      ar: ['Ø´Ù‚Ø©', 'ÙÙŠÙ„Ø§', 'ØªØ§ÙˆÙ† Ù‡Ø§ÙˆØ³', 'Ø¨Ù†ØªÙ‡Ø§ÙˆØ³', 'Ù…ÙƒØªØ¨', 'Ù…Ø³ØªÙˆØ¯Ø¹']
    },
    
    emirates: {
      en: ['Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman', 'RAK', 'Fujairah'],
      ar: ['Ø¯Ø¨ÙŠ', 'Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ', 'Ø§Ù„Ø´Ø§Ø±Ù‚Ø©', 'Ø¹Ø¬Ù…Ø§Ù†', 'Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©', 'Ø§Ù„ÙØ¬ÙŠØ±Ø©']
    }
  }
};

export default languageConfig;
```

---

## **âœ… PHASE 3: AI CHATBOT & WHATSAPP INTEGRATION**

### **Step 3.1: Chatbot Training Data**
**File:** `server/data/chatbotTraining.js`

```javascript
const chatbotTraining = {
  intents: [
    {
      name: "property_inquiry",
      examples: {
        en: [
          "Looking for 2 bedroom apartment in Dubai Marina",
          "Show me villas for rent in Arabian Ranches",
          "Properties for sale in Business Bay under 2M AED"
        ],
        ar: [
          "Ø£Ø¨Ø­Ø« Ø¹Ù† Ø´Ù‚Ø© ØºØ±ÙØªÙŠÙ† ÙÙŠ Ø¯Ø¨ÙŠ Ù…Ø§Ø±ÙŠÙ†Ø§",
          "Ø£Ø±ØºØ¨ ÙÙŠ ÙÙŠÙ„Ø§Øª Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± ÙÙŠ Ø§Ù„Ø±Ø§Ù†Ø´ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
          "Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù„Ø¨ÙŠØ¹ ÙÙŠ Ø¨ÙŠØ²Ù†Ø³ Ø¨Ø§ÙŠ Ø¨Ø£Ù‚Ù„ Ù…Ù† Ù¢ Ù…Ù„ÙŠÙˆÙ† Ø¯Ø±Ù‡Ù…"
        ]
      },
      responses: {
        en: [
          "I found {count} properties in {location}. What's your budget range?",
          "Great! I have {count} {property_type} options in {location}. When would you like to view?"
        ],
        ar: [
          "ÙˆØ¬Ø¯Øª {count} Ø¹Ù‚Ø§Ø± ÙÙŠ {location}. Ù…Ø§ Ù‡Ùˆ Ù†Ø·Ø§Ù‚ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒØŸ",
          "Ù…Ù…ØªØ§Ø²! Ù„Ø¯ÙŠ {count} Ø®ÙŠØ§Ø± {property_type} ÙÙŠ {location}. Ù…ØªÙ‰ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©ØŸ"
        ]
      }
    }
  ],
  
  entities: {
    location: {
      type: "list",
      values: [
        { value: "Dubai Marina", synonyms: ["Marina", "Ø¯Ø¨ÙŠ Ù…Ø§Ø±ÙŠÙ†Ø§"] },
        { value: "Palm Jumeirah", synonyms: ["Palm", "Ù†Ø®Ù„Ø© Ø¬Ù…ÙŠØ±Ø§"] }
      ]
    },
    property_type: {
      type: "list",
      values: [
        { value: "apartment", synonyms: ["flat", "unit", "Ø´Ù‚Ø©"] },
        { value: "villa", synonyms: ["house", "ÙÙŠÙ„Ø§", "Ù…Ù†Ø²Ù„"] }
      ]
    }
  }
};

module.exports = chatbotTraining;
```

### **Step 3.2: WhatsApp Integration Setup**
**File:** `server/services/whatsappService.js`

```javascript
const axios = require('axios');

class WhatsAppService {
  constructor() {
    this.baseURL = 'https://graph.facebook.com/v17.0';
    this.accessToken = process.env.WHATSAPP_API_KEY;
    this.phoneNumberId = process.env.WHATSAPP_PHONE_NUMBER_ID;
  }

  async sendMessage(to, message) {
    try {
      const response = await axios.post(
        `${this.baseURL}/${this.phoneNumberId}/messages`,
        {
          messaging_product: "whatsapp",
          recipient_type: "individual",
          to: to,
          type: "text",
          text: { body: message }
        },
        {
          headers: {
            'Authorization': `Bearer ${this.accessToken}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      return response.data;
    } catch (error) {
      console.error('WhatsApp send error:', error.response?.data || error.message);
      throw error;
    }
  }

  async processIncomingMessage(webhookData) {
    // Process incoming WhatsApp messages
    const message = webhookData.entry?.[0]?.changes?.[0]?.value?.messages?.[0];
    
    if (!message) return null;
    
    return {
      from: message.from,
      message: message.text?.body,
      timestamp: message.timestamp,
      messageId: message.id
    };
  }
}

module.exports = WhatsAppService;
```

---

## **âœ… PHASE 4: AGENT ASSIGNMENT ENGINE**

### **Step 4.1: AI Agent Assignment Algorithm**
**File:** `server/services/agentAssignment.js`

```javascript
class AgentAssignmentEngine {
  constructor() {
    this.weights = {
      expertise: 0.35,
      availability: 0.25,
      performance: 0.20,
      proximity: 0.10,
      clientMatch: 0.10
    };
  }

  async assignAgent(property, client, agents) {
    const scores = await Promise.all(
      agents.map(async agent => {
        const scoreBreakdown = {
          expertise: await this.calculateExpertiseScore(agent, property),
          availability: await this.calculateAvailabilityScore(agent),
          performance: this.calculatePerformanceScore(agent),
          proximity: await this.calculateProximityScore(agent, property),
          clientMatch: this.calculateClientMatchScore(agent, client)
        };

        // Calculate weighted total
        const totalScore = Object.keys(scoreBreakdown).reduce((sum, key) => {
          return sum + (scoreBreakdown[key] * this.weights[key]);
        }, 0);

        return {
          agentId: agent._id,
          name: agent.name,
          totalScore: parseFloat(totalScore.toFixed(2)),
          breakdown: scoreBreakdown,
          recommendation: this.getRecommendation(totalScore)
        };
      })
    );

    // Sort by score descending
    return scores.sort((a, b) => b.totalScore - a.totalScore);
  }

  calculateExpertiseScore(agent, property) {
    let score = 0;
    const maxScore = 100;
    
    // Property Type Expertise
    const propertyTypeExpertise = agent.expertise?.propertyTypes || [];
    if (propertyTypeExpertise.includes(property.specifications.propertyType)) {
      score += 40;
    }
    
    // Location Expertise
    const locationExpertise = agent.expertise?.locations || [];
    if (locationExpertise.includes(property.emirate)) {
      score += 30;
    }
    
    // Price Range Expertise
    const priceRangeExpertise = agent.expertise?.priceRanges || [];
    const propertyPrice = property.pricing.amount;
    const matchingRange = priceRangeExpertise.find(range => 
      propertyPrice >= range.min && propertyPrice <= range.max
    );
    if (matchingRange) score += 20;
    
    // Client Type Expertise
    const clientTypeExpertise = agent.expertise?.clientTypes || [];
    if (clientTypeExpertise.includes(property.client?.type)) {
      score += 10;
    }
    
    return Math.min(score, maxScore) / maxScore;
  }

  getRecommendation(score) {
    if (score >= 0.8) return 'Highly Recommended';
    if (score >= 0.6) return 'Recommended';
    if (score >= 0.4) return 'Suitable';
    return 'Not Recommended';
  }
}

module.exports = AgentAssignmentEngine;
```

---

## **âœ… PHASE 5: REAL-TIME DASHBOARD & ANALYTICS**

### **Step 5.1: Dashboard Component**
**File:** `client/src/components/dashboard/Dashboard.js`

```javascript
import React, { useState, useEffect } from 'react';
import { Card, Row, Col, Statistic, Table, Chart } from 'antd';
import { 
  PropertySafetyOutlined, 
  TeamOutlined, 
  DollarOutlined,
  MessageOutlined 
} from '@ant-design/icons';
import axios from 'axios';

const Dashboard = () => {
  const [dashboardData, setDashboardData] = useState({
    summary: {},
    recentProperties: [],
    agentPerformance: [],
    marketAnalytics: {}
  });

  useEffect(() => {
    fetchDashboardData();
  }, []);

  const fetchDashboardData = async () => {
    try {
      const response = await axios.get('/api/dashboard/summary');
      setDashboardData(response.data);
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
    }
  };

  const statCards = [
    {
      title: 'Total Properties',
      value: dashboardData.summary?.totalProperties || 0,
      icon: <PropertySafetyOutlined />,
      color: '#1890ff',
      change: '+12%'
    },
    {
      title: 'Active Agents',
      value: dashboardData.summary?.activeAgents || 0,
      icon: <TeamOutlined />,
      color: '#52c41a',
      change: '+5%'
    },
    {
      title: 'Monthly Revenue',
      value: `AED ${(dashboardData.summary?.monthlyRevenue || 0).toLocaleString()}`,
      icon: <DollarOutlined />,
      color: '#faad14',
      change: '+18%'
    },
    {
      title: 'WhatsApp Leads',
      value: dashboardData.summary?.whatsappLeads || 0,
      icon: <MessageOutlined />,
      color: '#722ed1',
      change: '+25%'
    }
  ];

  const columns = [
    {
      title: 'Property',
      dataIndex: 'propertyCode',
      key: 'propertyCode',
    },
    {
      title: 'Type',
      dataIndex: 'type',
      key: 'type',
    },
    {
      title: 'Location',
      dataIndex: 'location',
      key: 'location',
    },
    {
      title: 'Price',
      dataIndex: 'price',
      key: 'price',
      render: (price) => `AED ${price.toLocaleString()}`
    },
    {
      title: 'Status',
      dataIndex: 'status',
      key: 'status',
      render: (status) => (
        <span className={`status-badge status-${status}`}>
          {status}
        </span>
      )
    }
  ];

  return (
    <div className="dashboard-container">
      <h1>Real Estate Dashboard</h1>
      
      {/* Stats Row */}
      <Row gutter={[16, 16]} className="stats-row">
        {statCards.map((stat, index) => (
          <Col xs={24} sm={12} lg={6} key={index}>
            <Card>
              <Statistic
                title={stat.title}
                value={stat.value}
                prefix={stat.icon}
                valueStyle={{ color: stat.color }}
              />
              <div className="stat-change">
                <span style={{ color: stat.change.startsWith('+') ? '#52c41a' : '#ff4d4f' }}>
                  {stat.change}
                </span>
                <span> from last month</span>
              </div>
            </Card>
          </Col>
        ))}
      </Row>

      {/* Charts Row */}
      <Row gutter={[16, 16]} className="charts-row">
        <Col xs={24} lg={12}>
          <Card title="Property Distribution by Emirates">
            <Chart
              type="pie"
              data={dashboardData.marketAnalytics?.emiratesDistribution || []}
              height={300}
            />
          </Card>
        </Col>
        <Col xs={24} lg={12}>
          <Card title="Monthly Performance">
            <Chart
              type="line"
              data={dashboardData.marketAnalytics?.monthlyPerformance || []}
              height={300}
            />
          </Card>
        </Col>
      </Row>

      {/* Recent Properties Table */}
      <Card title="Recent Properties" className="properties-table">
        <Table
          columns={columns}
          dataSource={dashboardData.recentProperties}
          pagination={{ pageSize: 5 }}
          rowKey="propertyCode"
        />
      </Card>

      {/* Agent Performance */}
      <Card title="Top Performing Agents">
        <Table
          columns={[
            { title: 'Agent', dataIndex: 'name', key: 'name' },
            { title: 'Deals Closed', dataIndex: 'dealsClosed', key: 'dealsClosed' },
            { title: 'Total Value', dataIndex: 'totalValue', key: 'totalValue', render: v => `AED ${v.toLocaleString()}` },
            { title: 'Rating', dataIndex: 'rating', key: 'rating', render: r => `${r}/5` }
          ]}
          dataSource={dashboardData.agentPerformance}
          pagination={{ pageSize: 5 }}
          rowKey="agentId"
        />
      </Card>
    </div>
  );
};

export default Dashboard;
```

---

## **âœ… PHASE 6: THEME & DESIGN INTEGRATION**

### **Step 6.1: Global Theme Configuration**
**File:** `client/src/styles/theme.js`

```javascript
const theme = {
  // Colors
  colors: {
    primary: '#1a365d', // Deep blue
    secondary: '#2d3748', // Dark gray
    accent: '#e53e3e', // Red accent
    success: '#38a169', // Green
    warning: '#d69e2e', // Yellow
    error: '#e53e3e', // Red
    info: '#3182ce', // Blue
    
    // UAE Theme Colors
    uae: {
      red: '#ce1126',
      green: '#009739',
      white: '#FFFFFF',
      black: '#000000'
    },
    
    // Real Estate Specific
    property: {
      forSale: '#e53e3e',
      forRent: '#3182ce',
      sold: '#38a169',
      reserved: '#d69e2e'
    }
  },
  
  // Typography
  typography: {
    fontFamily: {
      english: "'Inter', -apple-system, sans-serif",
      arabic: "'Cairo', 'Noto Sans Arabic', sans-serif"
    },
    fontSize: {
      xs: '0.75rem',
      sm: '0.875rem',
      base: '1rem',
      lg: '1.125rem',
      xl: '1.25rem',
      '2xl': '1.5rem',
      '3xl': '1.875rem',
      '4xl': '2.25rem'
    }
  },
  
  // Spacing
  spacing: {
    0: '0',
    1: '0.25rem',
    2: '0.5rem',
    3: '0.75rem',
    4: '1rem',
    5: '1.25rem',
    6: '1.5rem',
    8: '2rem',
    10: '2.5rem',
    12: '3rem',
    16: '4rem'
  },
  
  // Breakpoints
  breakpoints: {
    sm: '640px',
    md: '768px',
    lg: '1024px',
    xl: '1280px'
  },
  
  // Shadows
  shadows: {
    sm: '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
    md: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
    lg: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
    xl: '0 20px 25px -5px rgba(0, 0, 0, 0.1)'
  },
  
  // Border Radius
  borderRadius: {
    none: '0',
    sm: '0.125rem',
    md: '0.375rem',
    lg: '0.5rem',
    xl: '0.75rem',
    full: '9999px'
  }
};

export default theme;
```

### **Step 6.2: Global Styles with RTL Support**
**File:** `client/src/styles/global.css`

```css
/* Global Styles with RTL Support */

:root {
  /* Theme Variables */
  --color-primary: #1a365d;
  --color-secondary: #2d3748;
  --color-accent: #e53e3e;
  --color-success: #38a169;
  --color-warning: #d69e2e;
  --color-error: #e53e3e;
  
  /* Spacing */
  --spacing-1: 0.25rem;
  --spacing-2: 0.5rem;
  --spacing-4: 1rem;
  --spacing-8: 2rem;
  
  /* Typography */
  --font-english: 'Inter', -apple-system, sans-serif;
  --font-arabic: 'Cairo', 'Noto Sans Arabic', sans-serif;
}

/* Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
}

body {
  font-family: var(--font-english);
  line-height: 1.6;
  color: var(--color-secondary);
  background-color: #f7fafc;
}

/* RTL Support */
[dir="rtl"] {
  font-family: var(--font-arabic);
  text-align: right;
}

[dir="rtl"] .text-left {
  text-align: right;
}

[dir="rtl"] .text-right {
  text-align: left;
}

[dir="rtl"] .mr-2 {
  margin-right: 0;
  margin-left: var(--spacing-2);
}

[dir="rtl"] .ml-2 {
  margin-left: 0;
  margin-right: var(--spacing-2);
}

/* Utility Classes */
.container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 var(--spacing-4);
}

.card {
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  padding: var(--spacing-4);
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-weight: 500;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background-color: var(--color-primary);
  color: white;
}

.btn-primary:hover {
  background-color: #2d3748;
}

.btn-secondary {
  background-color: white;
  color: var(--color-primary);
  border: 1px solid #e2e8f0;
}

.btn-secondary:hover {
  background-color: #f7fafc;
}

/* Property Status Badges */
.status-badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 500;
}

.status-available {
  background-color: #c6f6d5;
  color: #22543d;
}

.status-sold {
  background-color: #fed7d7;
  color: #742a2a;
}

.status-reserved {
  background-color: #feebc8;
  color: #744210;
}

/* Responsive Design */
@media (max-width: 768px) {
  .container {
    padding: 0 var(--spacing-2);
  }
  
  .hide-mobile {
    display: none;
  }
}

/* Loading States */
.loading-spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid var(--color-primary);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Form Styles */
.form-group {
  margin-bottom: var(--spacing-4);
}

.form-label {
  display: block;
  margin-bottom: var(--spacing-2);
  font-weight: 500;
}

.form-input {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #e2e8f0;
  border-radius: 0.375rem;
  font-size: 1rem;
}

.form-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

/* Table Styles */
.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table th {
  background-color: #f7fafc;
  padding: 0.75rem 1rem;
  text-align: left;
  font-weight: 600;
  color: var(--color-secondary);
  border-bottom: 1px solid #e2e8f0;
}

.data-table td {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #e2e8f0;
}

.data-table tr:hover {
  background-color: #f7fafc;
}
```

---

## **âœ… PHASE 7: VERCEL DEPLOYMENT CONFIGURATION**

### **Step 7.1: Vercel Configuration Files**
**`vercel.json` (Root directory):**
```json
{
  "version": 2,
  "builds": [
    {
      "src": "client/package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "build"
      }
    },
    {
      "src": "server/api/**/*.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/server/api/$1"
    },
    {
      "src": "/static/(.*)",
      "headers": {
        "cache-control": "public, max-age=31536000, immutable"
      }
    },
    {
      "src": "/(.*)",
      "dest": "/client/build/$1"
    }
  ],
  "env": {
    "NODE_ENV": "production"
  },
  "regions": ["dub1"],
  "github": {
    "silent": true
  }
}
```

**`client/vercel.json`:**
```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "build"
      }
    }
  ],
  "routes": [
    {
      "src": "/static/(.*)",
      "headers": {
        "cache-control": "public, max-age=31536000, immutable"
      }
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ]
}
```

### **Step 7.2: Deployment Verification Script**
**File:** `scripts/verify-deployment.js`

```javascript
#!/usr/bin/env node
const https = require('https');
const { execSync } = require('child_process');

console.log('ðŸ” Verifying Production Deployment\n');

const checks = [
  { url: 'https://your-domain.vercel.app', name: 'Homepage' },
  { url: 'https://your-domain.vercel.app/api/health', name: 'API Health' },
  { url: 'https://your-domain.vercel.app/robots.txt', name: 'Static Files' }
];

async function checkURL(url, name) {
  return new Promise((resolve) => {
    const req = https.get(url, (res) => {
      resolve({
        name,
        url,
        status: res.statusCode === 200 ? 'âœ… UP' : `âŒ DOWN (${res.statusCode})`,
        statusCode: res.statusCode
      });
    });
    
    req.on('error', () => {
      resolve({ name, url, status: 'âŒ ERROR', statusCode: 0 });
    });
    
    req.setTimeout(10000, () => {
      req.destroy();
      resolve({ name, url, status: 'âŒ TIMEOUT', statusCode: 0 });
    });
  });
}

async function runChecks() {
  console.log('Running deployment checks...\n');
  
  const results = await Promise.all(
    checks.map(check => checkURL(check.url, check.name))
  );
  
  results.forEach(result => {
    console.log(`${result.name}: ${result.status}`);
  });
  
  const homepage = results[0];
  if (homepage.statusCode === 200) {
    console.log('\nâœ… Deployment successful! Homepage is loading correctly.');
    
    // Test additional features
    console.log('\nðŸ§ª Testing additional features...');
    try {
      // Test API endpoints
      execSync('curl -s https://your-domain.vercel.app/api/properties | head -c 100', { stdio: 'pipe' });
      console.log('âœ… API endpoints are working');
      
      // Check build folder
      const buildFiles = execSync('ls -la client/build/').toString();
      if (buildFiles.includes('index.html')) {
        console.log('âœ… Build folder contains all necessary files');
      }
      
    } catch (error) {
      console.log('âš ï¸  Some features need attention');
    }
  } else {
    console.log('\nâŒ Deployment failed. Check the following:');
    console.log('1. Environment variables in Vercel dashboard');
    console.log('2. Build command in package.json');
    console.log('3. API routes configuration');
    console.log('4. CORS settings on server');
  }
}

runChecks();
```

---

## **âœ… ERROR CHECKING & VALIDATION STEPS**

### **Step 8.1: Code Validation Script**
**File:** `scripts/validate-code.js`

```javascript
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

console.log('ðŸ” Validating Code Structure\n');

const validationRules = [
  {
    name: 'Environment Files',
    check: () => {
      const requiredEnvFiles = ['.env.template', '.gitignore', 'client/.env.production.local'];
      const missing = requiredEnvFiles.filter(file => !fs.existsSync(file));
      return missing.length === 0 ? 'âœ… All environment files exist' : `âŒ Missing: ${missing.join(', ')}`;
    }
  },
  {
    name: 'Package.json Files',
    check: () => {
      const requiredPkgFiles = ['package.json', 'client/package.json', 'server/package.json'];
      const missing = requiredPkgFiles.filter(file => !fs.existsSync(file));
      return missing.length === 0 ? 'âœ… All package.json files exist' : `âŒ Missing: ${missing.join(', ')}`;
    }
  },
  {
    name: 'Deprecated Packages',
    check: () => {
      const deprecatedPackages = ['crypto', 'node-domexception'];
      let foundDeprecated = false;
      
      ['client/package.json', 'server/package.json'].forEach(pkgFile => {
        if (fs.existsSync(pkgFile)) {
          const pkg = JSON.parse(fs.readFileSync(pkgFile, 'utf8'));
          const allDeps = { ...pkg.dependencies, ...pkg.devDependencies };
          
          deprecatedPackages.forEach(deprecated => {
            if (allDeps[deprecated]) {
              console.log(`   âŒ Found deprecated package: ${deprecated} in ${pkgFile}`);
              foundDeprecated = true;
            }
          });
        }
      });
      
      return foundDeprecated ? 'âŒ Remove deprecated packages' : 'âœ… No deprecated packages found';
    }
  },
  {
    name: 'Hardcoded URLs',
    check: () => {
      const hardcodedPatterns = ['http://localhost', 'localhost:5000', 'localhost:3000'];
      let foundHardcoded = false;
      
      function checkFile(filePath) {
        if (fs.existsSync(filePath)) {
          const content = fs.readFileSync(filePath, 'utf8');
          hardcodedPatterns.forEach(pattern => {
            if (content.includes(pattern)) {
              console.log(`   âŒ Found hardcoded URL in: ${filePath}`);
              foundHardcoded = true;
            }
          });
        }
      }
      
      // Check
I'll add a comprehensive module and feature catalog for your White Caves Real Estate project.

## **ðŸ“ PROJECT MODULES & FEATURES CATALOG**

### **ðŸ¢ MODULE 1: PROPERTY MANAGEMENT SYSTEM**
**Files:** `server/models/Property.js`, `client/src/components/properties/`
```
â”œâ”€â”€ Property Listing & Search
â”‚   â”œâ”€â”€ Advanced Property Search
â”‚   â”œâ”€â”€ Filter by Emirates (7 Emirates)
â”‚   â”œâ”€â”€ Filter by Property Type (8 Types)
â”‚   â”œâ”€â”€ Price Range Filter
â”‚   â”œâ”€â”€ Bedrooms/Bathrooms Filter
â”‚   â”œâ”€â”€ Amenities Filter
â”‚   â””â”€â”€ Map View Integration
â”‚
â”œâ”€â”€ Property Details
â”‚   â”œâ”€â”€ Comprehensive Property Info
â”‚   â”œâ”€â”€ UAE-Specific Fields (DLD, Ejari, DEWA)
â”‚   â”œâ”€â”€ Document Management
â”‚   â”œâ”€â”€ Photo Gallery (Multiple Images)
â”‚   â”œâ”€â”€ Virtual Tour Integration
â”‚   â”œâ”€â”€ Floor Plans
â”‚   â””â”€â”€ Nearby Amenities
â”‚
â”œâ”€â”€ Property Status Management
â”‚   â”œâ”€â”€ Available for Rent/Sale
â”‚   â”œâ”€â”€ Reserved Status
â”‚   â”œâ”€â”€ Under Contract
â”‚   â”œâ”€â”€ Sold/Rented Status
â”‚   â”œâ”€â”€ Off-Market Status
â”‚   â””â”€â”€ Status History Tracking
â”‚
â””â”€â”€ Property Analytics
    â”œâ”€â”€ Views Counter
    â”œâ”€â”€ Inquiry Tracking
    â”œâ”€â”€ Price History
    â”œâ”€â”€ Time on Market
    â””â”€â”€ Performance Metrics
```

### **ðŸ¢ MODULE 2: USER MANAGEMENT & ROLES**
**Files:** `server/models/User.js`, `server/middleware/auth.js`

#### **ðŸ‘¥ USER ROLES & PERMISSIONS (5 Roles)**
```
â”œâ”€â”€ Role 1: SUPER ADMIN (1 User Maximum)
â”‚   â”œâ”€â”€ Full System Access
â”‚   â”œâ”€â”€ Manage All Users
â”‚   â”œâ”€â”€ System Configuration
â”‚   â”œâ”€â”€ Database Management
â”‚   â””â”€â”€ Backup/Restore
â”‚
â”œâ”€â”€ Role 2: COMPANY OWNER (1-3 Users)
â”‚   â”œâ”€â”€ View All Properties
â”‚   â”œâ”€â”€ Financial Reports
â”‚   â”œâ”€â”€ Agent Performance
â”‚   â”œâ”€â”€ Inventory Management
â”‚   â”œâ”€â”€ Commission Tracking
â”‚   â””â”€â”€ Market Analytics
â”‚
â”œâ”€â”€ Role 3: BRANCH MANAGER (Per Branch)
â”‚   â”œâ”€â”€ Manage Branch Agents
â”‚   â”œâ”€â”€ Approve Property Listings
â”‚   â”œâ”€â”€ View Branch Reports
â”‚   â”œâ”€â”€ Manage Viewings
â”‚   â””â”€â”€ Client Assignments
â”‚
â”œâ”€â”€ Role 4: REAL ESTATE AGENT (Unlimited)
â”‚   â”œâ”€â”€ Add/Edit Own Properties
â”‚   â”œâ”€â”€ Manage Own Clients
â”‚   â”œâ”€â”€ Schedule Viewings
â”‚   â”œâ”€â”€ Track Commissions
â”‚   â”œâ”€â”€ Communication Tools
â”‚   â””â”€â”€ Performance Dashboard
â”‚
â””â”€â”€ Role 5: CLIENT/TENANT (Public)
    â”œâ”€â”€ Browse Properties
    â”œâ”€â”€ Save Favorites
    â”œâ”€â”€ Submit Inquiries
    â”œâ”€â”€ Schedule Viewings
    â”œâ”€â”€ Document Upload
    â””â”€â”€ Contract Management
```

#### **ðŸ‘¤ USER COUNT ESTIMATE**
```
Total Users: 50-500+ (Scalable)
â”œâ”€â”€ Super Admin: 1 user
â”œâ”€â”€ Company Owner: 1-3 users
â”œâ”€â”€ Branch Managers: 5-10 users (1 per emirate)
â”œâ”€â”€ Real Estate Agents: 20-100+ users
â””â”€â”€ Clients/Tenants: Unlimited public users
```

### **ðŸ¢ MODULE 3: AI CHATBOT SYSTEM**
**Files:** `server/services/chatbotService.js`, `client/src/components/chatbot/`
```
â”œâ”€â”€ Natural Language Processing
â”‚   â”œâ”€â”€ Intent Classification (3 Main Intents)
â”‚   â”œâ”€â”€ Entity Extraction
â”‚   â”œâ”€â”€ Context Management
â”‚   â””â”€â”€ Conversation Flow
â”‚
â”œâ”€â”€ Bilingual Support
â”‚   â”œâ”€â”€ English Chat Interface
â”‚   â”œâ”€â”€ Arabic Chat Interface
â”‚   â”œâ”€â”€ Auto Language Detection
â”‚   â””â”€â”€ RTL Support for Arabic
â”‚
â”œâ”€â”€ Property Matching
â”‚   â”œâ”€â”€ Understand Requirements
â”‚   â”œâ”€â”€ Match with Database
â”‚   â”œâ”€â”€ Show Relevant Properties
â”‚   â””â”€â”€ Schedule Viewings
â”‚
â””â”€â”€ Lead Management
    â”œâ”€â”€ Lead Scoring Algorithm
    â”œâ”€â”€ Quality Assessment
    â”œâ”€â”€ Priority Classification
    â””â”€â”€ Auto Assignment
```

### **ðŸ¢ MODULE 4: WHATSAPP BUSINESS INTEGRATION**
**Files:** `server/services/whatsappService.js`, `client/src/components/whatsapp/`
```
â”œâ”€â”€ WhatsApp Business API
â”‚   â”œâ”€â”€ Meta Business Setup
â”‚   â”œâ”€â”€ Webhook Configuration
â”‚   â”œâ”€â”€ Message Templates
â”‚   â””â”€â”€ Media Sharing
â”‚
â”œâ”€â”€ Chat Integration
â”‚   â”œâ”€â”€ WhatsApp Chat Interface
â”‚   â”œâ”€â”€ Message History
â”‚   â”œâ”€â”€ Auto-Responses
â”‚   â””â”€â”€ File Sharing
â”‚
â”œâ”€â”€ Lead Capture
â”‚   â”œâ”€â”€ WhatsApp Number Capture
â”‚   â”œâ”€â”€ Property Links via WhatsApp
â”‚   â”œâ”€â”€ Viewing Confirmations
â”‚   â””â”€â”€ Follow-up Reminders
â”‚
â””â”€â”€ Analytics
    â”œâ”€â”€ Message Metrics
    â”œâ”€â”€ Response Times
    â”œâ”€â”€ Conversion Tracking
    â””â”€â”€ ROI Calculation
```

### **ðŸ¢ MODULE 5: AGENT ASSIGNMENT ENGINE**
**Files:** `server/services/agentAssignment.js`
```
â”œâ”€â”€ AI Scoring Algorithm (5 Factors)
â”‚   â”œâ”€â”€ Expertise Match (35% weight)
â”‚   â”‚   â””â”€â”€ Property Type Experience
â”‚   â”‚   â””â”€â”€ Location Knowledge
â”‚   â”‚   â””â”€â”€ Price Range Experience
â”‚   â”‚   â””â”€â”€ Client Type Experience
â”‚   â”‚
â”‚   â”œâ”€â”€ Availability (25% weight)
â”‚   â”‚   â””â”€â”€ Current Workload
â”‚   â”‚   â””â”€â”€ Calendar Availability
â”‚   â”‚   â””â”€â”€ Response Time History
â”‚   â”‚
â”‚   â”œâ”€â”€ Performance Metrics (20% weight)
â”‚   â”‚   â””â”€â”€ Closure Rate
â”‚   â”‚   â””â”€â”€ Client Ratings
â”‚   â”‚   â””â”€â”€ Average Deal Size
â”‚   â”‚   â””â”€â”€ Response Time Average
â”‚   â”‚
â”‚   â”œâ”€â”€ Proximity (10% weight)
â”‚   â”‚   â””â”€â”€ Distance to Property
â”‚   â”‚   â””â”€â”€ Area Familiarity
â”‚   â”‚   â””â”€â”€ Travel Time
â”‚   â”‚
â”‚   â””â”€â”€ Client Match (10% weight)
â”‚       â””â”€â”€ Language Preference
â”‚       â””â”€â”€ Previous Interactions
â”‚       â””â”€â”€ Client Rating of Agent
â”‚
â””â”€â”€ Recommendation System
    â”œâ”€â”€ Score Calculation (0-100)
    â”œâ”€â”€ Recommendation Levels
    â”‚   â”œâ”€â”€ Highly Recommended (80-100)
    â”‚   â”œâ”€â”€ Recommended (60-79)
    â”‚   â”œâ”€â”€ Suitable (40-59)
    â”‚   â””â”€â”€ Not Recommended (0-39)
    â”‚
    â””â”€â”€ Assignment Tracking
        â”œâ”€â”€ Assignment History
        â”œâ”€â”€ Performance Feedback
        â”œâ”€â”€ Success Rate Tracking
        â””â”€â”€ Continuous Learning
```

### **ðŸ¢ MODULE 6: GOOGLE WORKSPACE INTEGRATION**
**Files:** `server/services/googleService.js`
```
â”œâ”€â”€ Google Calendar Integration
â”‚   â”œâ”€â”€ OAuth 2.0 Authentication
â”‚   â”œâ”€â”€ Automatic Event Creation
â”‚   â”œâ”€â”€ Viewing Schedule Management
â”‚   â”œâ”€â”€ Reminder Notifications
â”‚   â””â”€â”€ Calendar Sync
â”‚
â”œâ”€â”€ Google Tasks Integration
â”‚   â”œâ”€â”€ Task Auto-Creation
â”‚   â”œâ”€â”€ Follow-up Task Management
â”‚   â”œâ”€â”€ Priority Setting
â”‚   â””â”€â”€ Completion Tracking
â”‚
â””â”€â”€ Google Contacts Sync
    â”œâ”€â”€ Client Contact Management
    â”œâ”€â”€ Import/Export Contacts
    â”œâ”€â”€ Contact History
    â””â”€â”€ Communication Tracking
```

### **ðŸ¢ MODULE 7: TENANCY CONTRACT WORKFLOW**
**Files:** `server/models/Contract.js`, `client/src/components/contracts/`
```
â”œâ”€â”€ Tenant Verification (6 Mandatory Items)
â”‚   â”œâ”€â”€ 1. Mobile Number Verification (UAE Format)
â”‚   â”œâ”€â”€ 2. Email Verification
â”‚   â”œâ”€â”€ 3. Emirates ID Validation + OCR
â”‚   â”œâ”€â”€ 4. Passport Copy with Signature
â”‚   â”œâ”€â”€ 5. UAE Residence Permit
â”‚   â”œâ”€â”€ 6. Bank Account & Cheque Confirmation
â”‚   â””â”€â”€ Additional Documents
â”‚
â”œâ”€â”€ Landlord Verification
â”‚   â”œâ”€â”€ Title Deed Verification
â”‚   â”œâ”€â”€ Passport Copy
â”‚   â”œâ”€â”€ DEWA Bill Proof
â”‚   â”œâ”€â”€ Emirates ID (if resident)
â”‚   â”œâ”€â”€ NOC from Bank (if mortgaged)
â”‚   â””â”€â”€ Vacancy Status Confirmation
â”‚
â”œâ”€â”€ Contract Generation
â”‚   â”œâ”€â”€ UAE Standard Tenancy Contract
â”‚   â”œâ”€â”€ Custom Clauses
â”‚   â”œâ”€â”€ Bilingual Contract (EN/AR)
â”‚   â”œâ”€â”€ Ejari Compliance
â”‚   â””â”€â”€ Legal Clause Library
â”‚
â””â”€â”€ E-Signing & Management
    â”œâ”€â”€ Digital Signature Integration
    â”œâ”€â”€ Multiple Party Signing
    â”œâ”€â”€ Contract Status Tracking
    â”œâ”€â”€ Ejari Registration Assistance
    â””â”€â”€ Document Storage
```

### **ðŸ¢ MODULE 8: INVENTORY MANAGEMENT**
**Files:** `server/models/Inventory.js`, `client/src/components/inventory/`
```
â”œâ”€â”€ Multi-Source Inventory Tracking
â”‚   â”œâ”€â”€ Company-Owned Properties
â”‚   â”œâ”€â”€ Other Agencies Listings
â”‚   â”œâ”€â”€ Freelance Agent Properties
â”‚   â”œâ”€â”€ Owner-Direct Listings
â”‚   â”œâ”€â”€ Joint Venture Properties
â”‚   â””â”€â”€ Portal-Sourced Properties
â”‚
â”œâ”€â”€ Inventory Categories (9 Statuses)
â”‚   â”œâ”€â”€ Available for Rent
â”‚   â”œâ”€â”€ Available for Sale
â”‚   â”œâ”€â”€ Tenant Occupied
â”‚   â”œâ”€â”€ Owner Occupied
â”‚   â”œâ”€â”€ Future Available
â”‚   â”œâ”€â”€ Under Maintenance
â”‚   â”œâ”€â”€ Off-Market
â”‚   â”œâ”€â”€ Reserved
â”‚   â””â”€â”€ Under Contract
â”‚
â”œâ”€â”€ Commission Tracking
â”‚   â”œâ”€â”€ Commission Structures
â”‚   â”œâ”€â”€ Payment Tracking
â”‚   â”œâ”€â”€ Source Performance
â”‚   â”œâ”€â”€ Split Commission Management
â”‚   â””â”€â”€ Invoice Generation
â”‚
â””â”€â”€ Owner-Exclusive Features
    â”œâ”€â”€ Real-time Inventory Dashboard
    â”œâ”€â”€ Financial Analytics
    â”œâ”€â”€ Portfolio Valuation
    â”œâ”€â”€ ROI Tracking
    â””â”€â”€ Market Comparison
```

### **ðŸ¢ MODULE 9: ANALYTICS & DASHBOARD**
**Files:** `server/controllers/analytics.js`, `client/src/components/dashboard/`
```
â”œâ”€â”€ Real-time Dashboard
â”‚   â”œâ”€â”€ Live Property Updates
â”‚   â”œâ”€â”€ Agent Activity Feed
â”‚   â”œâ”€â”€ Lead Conversion Tracking
â”‚   â”œâ”€â”€ Revenue Dashboard
â”‚   â””â”€â”€ Performance Metrics
â”‚
â”œâ”€â”€ UAE Market Analytics
â”‚   â”œâ”€â”€ Emirates Breakdown
â”‚   â”œâ”€â”€ Property Type Distribution
â”‚   â”œâ”€â”€ Price Trends Analysis
â”‚   â”œâ”€â”€ Demand Heat Maps
â”‚   â””â”€â”€ Competitor Analysis
â”‚
â”œâ”€â”€ Agent Performance
â”‚   â”œâ”€â”€ Leaderboards
â”‚   â”œâ”€â”€ Individual Metrics
â”‚   â”œâ”€â”€ Commission Tracking
â”‚   â”œâ”€â”€ Client Ratings
â”‚   â””â”€â”€ Improvement Suggestions
â”‚
â””â”€â”€ Financial Reports
    â”œâ”€â”€ Monthly Revenue Reports
    â”œâ”€â”€ Commission Reports
    â”œâ”€â”€ Expense Tracking
    â”œâ”€â”€ ROI Calculation
    â””â”€â”€ Tax Preparation Data
```

### **ðŸ¢ MODULE 10: FRONTEND & UX COMPONENTS**
**Files:** `client/src/components/`, `client/src/styles/`
```
â”œâ”€â”€ Bilingual UI System
â”‚   â”œâ”€â”€ Language Toggle (EN/AR)
â”‚   â”œâ”€â”€ RTL/LTR Layout Switching
â”‚   â”œâ”€â”€ Arabic Number Formatting
â”‚   â”œâ”€â”€ Hijri/Gregorian Dates
â”‚   â””â”€â”€ Font Management
â”‚
â”œâ”€â”€ Responsive Design
â”‚   â”œâ”€â”€ Mobile-First Approach
â”‚   â”œâ”€â”€ Tablet Optimization
â”‚   â”œâ”€â”€ Desktop Experience
â”‚   â”œâ”€â”€ Touch-Friendly Interfaces
â”‚   â””â”€â”€ Cross-Browser Compatibility
â”‚
â”œâ”€â”€ Theme System
â”‚   â”œâ”€â”€ Color Palettes (UAE Theme)
â”‚   â”œâ”€â”€ Dark/Light Mode
â”‚   â”œâ”€â”€ Custom Branding
â”‚   â”œâ”€â”€ Component Library
â”‚   â””â”€â”€ Animation System
â”‚
â””â”€â”€ Accessibility Features
    â”œâ”€â”€ Screen Reader Support
    â”œâ”€â”€ Keyboard Navigation
    â”œâ”€â”€ High Contrast Mode
    â”œâ”€â”€ Font Size Adjustment
    â””â”€â”€ ARIA Labels
```

### **ðŸ¢ MODULE 11: BACKEND SERVICES**
**Files:** `server/services/`, `server/middleware/`
```
â”œâ”€â”€ Authentication System
â”‚   â”œâ”€â”€ JWT Token Management
â”‚   â”œâ”€â”€ Role-Based Access Control
â”‚   â”œâ”€â”€ Session Management
â”‚   â”œâ”€â”€ OAuth Integration (Google)
â”‚   â””â”€â”€ Password Security
â”‚
â”œâ”€â”€ File Management
â”‚   â”œâ”€â”€ Document Upload/Storage
â”‚   â”œâ”€â”€ Image Processing
â”‚   â”œâ”€â”€ PDF Generation
â”‚   â”œâ”€â”€ Cloud Storage (AWS S3)
â”‚   â””â”€â”€ File Validation
â”‚
â”œâ”€â”€ Email & Notification System
â”‚   â”œâ”€â”€ Transactional Emails
â”‚   â”œâ”€â”€ SMS Notifications
â”‚   â”œâ”€â”€ WhatsApp Messages
â”‚   â”œâ”€â”€ Push Notifications
â”‚   â””â”€â”€ Notification Preferences
â”‚
â””â”€â”€ API Management
    â”œâ”€â”€ RESTful API Design
    â”œâ”€â”€ Rate Limiting
    â”œâ”€â”€ Request Validation
    â”œâ”€â”€ Error Handling
    â””â”€â”€ API Documentation
```

### **ðŸ¢ MODULE 12: DEPLOYMENT & DEVOPS**
**Files:** `vercel.json`, `scripts/`, `Dockerfile`
```
â”œâ”€â”€ Vercel Deployment
â”‚   â”œâ”€â”€ Production Configuration
â”‚   â”œâ”€â”€ Environment Variables
â”‚   â”œâ”€â”€ Build Optimization
â”‚   â”œâ”€â”€ CDN Configuration
â”‚   â””â”€â”€ Domain Management
â”‚
â”œâ”€â”€ Database Management
â”‚   â”œâ”€â”€ MongoDB Atlas Setup
â”‚   â”œâ”€â”€ Database Migration
â”‚   â”œâ”€â”€ Backup Strategy
â”‚   â”œâ”€â”€ Index Optimization
â”‚   â””â”€â”€ Performance Monitoring
â”‚
â”œâ”€â”€ Security Implementation
â”‚   â”œâ”€â”€ SSL/TLS Configuration
â”‚   â”œâ”€â”€ CORS Settings
â”‚   â”œâ”€â”€ Input Validation
â”‚   â”œâ”€â”€ SQL Injection Prevention
â”‚   â””â”€â”€ XSS Protection
â”‚
â””â”€â”€ Monitoring & Logging
    â”œâ”€â”€ Error Tracking
    â”œâ”€â”€ Performance Monitoring
    â”œâ”€â”€ User Analytics
    â”œâ”€â”€ Audit Logs
    â””â”€â”€ Health Checks
```

## **ðŸ“Š FEATURE SUMMARY BY MODULE**

### **TOTAL FEATURES: 150+**

#### **Core Property Features: 25**
- Property listing, search, filtering, management
- UAE-specific fields and compliance
- Document management and verification
- Multi-language property descriptions

#### **User Management Features: 20**
- 5 User roles with granular permissions
- Multi-branch support
- Agent performance tracking
- Client relationship management

#### **AI & Automation Features: 15**
- Intelligent chatbot with NLP
- AI agent assignment engine
- Lead scoring and prioritization
- Automated follow-up system

#### **Communication Features: 12**
- WhatsApp Business integration
- Email/SMS notifications
- Internal messaging system
- Appointment scheduling

#### **Contract Management Features: 10**
- Complete tenancy workflow
- E-signature integration
- Document generation
- Ejari registration assistance

#### **Analytics & Reporting Features: 18**
- Real-time dashboards
- Financial reporting
- Market analytics
- Performance metrics

#### **Inventory Management Features: 15**
- Multi-source tracking
- Commission management
- Owner-exclusive portal
- Financial forecasting

#### **Integration Features: 10**
- Google Workspace integration
- Payment gateway integration
- Map API integration
- Third-party portal sync

#### **UI/UX Features: 15**
- Bilingual interface (EN/AR)
- RTL/LTR support
- Responsive design
- Accessibility features

#### **Backend Features: 10**
- Secure authentication
- File management
- API management
- Background jobs

## **ðŸ‘¥ USER ROLES & ASSOCIATED FEATURES**

### **SUPER ADMIN (Full Access)**
**Permissions:** All features in all modules
**Access Level:** System-wide
**Dashboard:** Complete admin panel

### **COMPANY OWNER**
**Property Management:** View all properties, edit company-owned
**Financial:** Revenue reports, commission tracking, ROI analysis
**Analytics:** Market trends, agent performance, inventory valuation
**Inventory:** Complete inventory management, multi-source tracking
**Settings:** Company configuration, branch management

### **BRANCH MANAGER (Per Emirate)**
**Property Management:** Approve listings, manage branch properties
**Agent Management:** Assign agents, monitor performance
**Client Management:** Oversee client relationships
**Reports:** Branch-level analytics and reporting
**Viewings:** Schedule and manage property viewings

### **REAL ESTATE AGENT**
**Properties:** Add/edit own listings, track performance
**Clients:** Manage assigned clients, communication history
**Viewings:** Schedule and conduct property viewings
**Commissions:** Track earnings and pending payments
**Tools:** WhatsApp integration, document management

### **CLIENT/TENANT (Public User)**
**Properties:** Browse, search, save favorites
**Inquiries:** Submit property inquiries via chat/forms
**Viewings:** Schedule property viewings
**Documents:** Upload verification documents
**Contracts:** View and sign tenancy contracts
**Profile:** Manage personal information and preferences

## **ðŸ“ˆ SCALABILITY ESTIMATES**

### **Current Capacity:**
- **Properties:** 10,000+ listings
- **Users:** 500 concurrent users
- **Storage:** 100GB documents & images
- **Transactions:** 10,000 daily API calls

### **Future Scaling:**
- **Properties:** 100,000+ with sharding
- **Users:** 10,000+ with load balancing
- **Storage:** 1TB+ with CDN
- **Transactions:** 100,000+ with microservices

This comprehensive catalog provides a complete overview of all modules, features, user roles, and scalability options for your White Caves Real Estate project.

## **âœ… PHASE 8: ADVANCED AUTHENTICATION SYSTEM**

### **Step 8.1: Multi-Strategy Authentication Schema**
**File:** `server/models/User.js`

```javascript
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
const Schema = mongoose.Schema;

const UserSchema = new Schema({
  // Primary Identification
  email: { 
    type: String, 
    lowercase: true,
    trim: true,
    sparse: true
  },
  phone: {
    type: String,
    validate: {
      validator: function(v) {
        // UAE phone validation + international
        return /^(\+971|00971|0)?(5[0-9]{8})$/.test(v) || /^\+[1-9]\d{1,14}$/.test(v);
      },
      message: props => `${props.value} is not a valid phone number!`
    },
    sparse: true
  },
  
  // Authentication Methods
  authMethods: [{
    provider: {
      type: String,
      enum: ['local', 'google', 'apple', 'facebook', 'linkedin'],
      required: true
    },
    providerId: String, // Google ID, Apple ID, etc.
    verified: { type: Boolean, default: false },
    primary: { type: Boolean, default: false },
    lastUsed: Date
  }],
  
  // Local Auth (for email/phone login)
  localAuth: {
    password: { 
      type: String,
      select: false,
      minlength: 8
    },
    passwordResetToken: String,
    passwordResetExpires: Date,
    emailVerificationToken: String,
    emailVerified: { type: Boolean, default: false },
    phoneVerificationCode: String,
    phoneVerified: { type: Boolean, default: false },
    twoFactorEnabled: { type: Boolean, default: false },
    twoFactorSecret: { type: String, select: false }
  },
  
  // OAuth Profiles
  oauthProfiles: {
    google: {
      id: String,
      email: String,
      name: String,
      picture: String,
      locale: String
    },
    apple: {
      id: String,
      email: String,
      name: {
        firstName: String,
        lastName: String
      }
    }
  },
  
  // User Profile
  profile: {
    firstName: { type: String, trim: true },
    lastName: { type: String, trim: true },
    fullName: { type: String, trim: true },
    avatar: String,
    preferredLanguage: { 
      type: String, 
      enum: ['en', 'ar'], 
      default: 'en' 
    },
    timezone: { type: String, default: 'Asia/Dubai' },
    currency: { type: String, default: 'AED' },
    notificationPreferences: {
      email: { type: Boolean, default: true },
      sms: { type: Boolean, default: true },
      whatsapp: { type: Boolean, default: true },
      push: { type: Boolean, default: true }
    }
  },
  
  // UAE Specific
  uaeDetails: {
    emiratesId: {
      type: String,
      validate: {
        validator: function(v) {
          // Emirates ID validation: 784-YYYY-NNNNNNN-#
          return /^784-\d{4}-\d{7}-\d{1}$/.test(v);
        },
        message: props => `${props.value} is not a valid Emirates ID!`
      }
    },
    passportNumber: String,
    nationality: String,
    visaType: String,
    visaExpiry: Date
  },
  
  // Role & Permissions
  role: {
    type: String,
    enum: ['super_admin', 'company_owner', 'branch_manager', 'agent', 'client', 'tenant'],
    default: 'client'
  },
  permissions: [{
    module: String,
    actions: [String]
  }],
  
  // Security
  lastLogin: Date,
  loginHistory: [{
    timestamp: { type: Date, default: Date.now },
    ip: String,
    userAgent: String,
    location: String,
    method: String
  }],
  activeSessions: [{
    token: String,
    userAgent: String,
    ip: String,
    createdAt: { type: Date, default: Date.now },
    expiresAt: Date
  }],
  
  // Status
  status: {
    type: String,
    enum: ['active', 'inactive', 'suspended', 'pending_verification'],
    default: 'pending_verification'
  },
  verificationLevel: {
    type: String,
    enum: ['unverified', 'basic', 'verified', 'fully_verified'],
    default: 'unverified'
  },
  
  // Timestamps
  createdAt: { type: Date, default: Date.now },
  updatedAt: Date,
  lastActive: Date
}, {
  timestamps: true,
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// Indexes
UserSchema.index({ email: 1 }, { unique: true, sparse: true });
UserSchema.index({ phone: 1 }, { unique: true, sparse: true });
UserSchema.index({ 'oauthProfiles.google.id': 1 }, { sparse: true });
UserSchema.index({ 'oauthProfiles.apple.id': 1 }, { sparse: true });
UserSchema.index({ role: 1, status: 1 });
UserSchema.index({ 'uaeDetails.emiratesId': 1 }, { sparse: true });

// Password hashing middleware
UserSchema.pre('save', async function(next) {
  if (!this.isModified('localAuth.password')) return next();
  
  try {
    const salt = await bcrypt.genSalt(12);
    this.localAuth.password = await bcrypt.hash(this.localAuth.password, salt);
    next();
  } catch (error) {
    next(error);
  }
});

// Method to compare password
UserSchema.methods.comparePassword = async function(candidatePassword) {
  return await bcrypt.compare(candidatePassword, this.localAuth.password);
};

// Method to get primary contact
UserSchema.virtual('primaryContact').get(function() {
  const primaryMethod = this.authMethods.find(m => m.primary);
  if (primaryMethod?.provider === 'local') {
    return this.email || this.phone;
  }
  return this.email || this.phone;
});

module.exports = mongoose.model('User', UserSchema);
```

### **Step 8.2: Authentication Service**
**File:** `server/services/authService.js`

```javascript
const jwt = require('jsonwebtoken');
const crypto = require('crypto');
const { OAuth2Client } = require('google-auth-library');
const axios = require('axios');

class AuthService {
  constructor() {
    this.jwtSecret = process.env.JWT_SECRET;
    this.jwtExpire = process.env.JWT_EXPIRE || '7d';
    this.googleClient = new OAuth2Client(process.env.GOOGLE_CLIENT_ID);
  }

  // Generate JWT Token
  generateToken(user, deviceInfo = {}) {
    const payload = {
      userId: user._id,
      email: user.email,
      phone: user.phone,
      role: user.role,
      verificationLevel: user.verificationLevel,
      authMethods: user.authMethods
    };

    return jwt.sign(payload, this.jwtSecret, {
      expiresIn: this.jwtExpire,
      issuer: 'white-caves-realestate',
      audience: 'user'
    });
  }

  // Verify JWT Token
  verifyToken(token) {
    try {
      return jwt.verify(token, this.jwtSecret);
    } catch (error) {
      throw new Error('Invalid or expired token');
    }
  }

  // Google Authentication
  async verifyGoogleToken(token) {
    try {
      const ticket = await this.googleClient.verifyIdToken({
        idToken: token,
        audience: process.env.GOOGLE_CLIENT_ID
      });

      const payload = ticket.getPayload();
      
      return {
        providerId: payload.sub,
        email: payload.email,
        emailVerified: payload.email_verified,
        name: payload.name,
        firstName: payload.given_name,
        lastName: payload.family_name,
        picture: payload.picture,
        locale: payload.locale
      };
    } catch (error) {
      throw new Error('Invalid Google token');
    }
  }

  // Apple Authentication (simplified)
  async verifyAppleToken(identityToken) {
    // Note: Apple Sign-In requires additional setup with Apple Developer account
    // This is a simplified version
    try {
      // In production, verify with Apple's servers
      const response = await axios.get('https://appleid.apple.com/auth/keys');
      const keys = response.data.keys;
      
      // Verify JWT with Apple's public keys
      // Implementation depends on your Apple Developer setup
      
      return {
        provider: 'apple',
        // Extract claims from verified token
      };
    } catch (error) {
      throw new Error('Apple authentication failed');
    }
  }

  // Generate Verification Code
  generateVerificationCode(length = 6) {
    return crypto.randomInt(Math.pow(10, length - 1), Math.pow(10, length) - 1).toString();
  }

  // Generate Password Reset Token
  generatePasswordResetToken() {
    const resetToken = crypto.randomBytes(32).toString('hex');
    const hashedToken = crypto.createHash('sha256').update(resetToken).digest('hex');
    const expires = Date.now() + 10 * 60 * 1000; // 10 minutes
    
    return { resetToken, hashedToken, expires };
  }

  // Validate UAE Phone Number
  validateUAEPhone(phone) {
    const uaeRegex = /^(\+971|00971|0)?(5[0-9]{8})$/;
    return uaeRegex.test(phone);
  }

  // Format phone to international
  formatPhoneInternational(phone) {
    if (phone.startsWith('0')) {
      return '+971' + phone.substring(1);
    }
    if (phone.startsWith('00971')) {
      return '+971' + phone.substring(5);
    }
    return phone;
  }
}

module.exports = AuthService;
```

### **Step 8.3: Advanced Auth Context & Hook**
**File:** `client/src/contexts/AuthContext.js`

```javascript
import React, { createContext, useState, useContext, useEffect, useCallback } from 'react';
import axios from 'axios';
import { useNavigate, useLocation } from 'react-router-dom';
import { message, notification } from 'antd';
import { GoogleOAuthProvider, useGoogleLogin } from '@react-oauth/google';
import * as AppleAuthentication from 'expo-apple-authentication'; // For React Native, web alternative needed

const AuthContext = createContext({});

export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [authMethods, setAuthMethods] = useState([]);
  const [twoFactorRequired, setTwoFactorRequired] = useState(false);
  const [tempToken, setTempToken] = useState(null);
  
  const navigate = useNavigate();
  const location = useLocation();

  // Initialize auth state
  useEffect(() => {
    const initAuth = async () => {
      try {
        const token = localStorage.getItem('auth_token');
        const userData = localStorage.getItem('user_data');
        
        if (token && userData) {
          // Validate token with server
          const response = await axios.get('/api/auth/validate', {
            headers: { Authorization: `Bearer ${token}` }
          });
          
          if (response.data.valid) {
            setUser(JSON.parse(userData));
            setAuthMethods(response.data.authMethods || []);
            
            // Set default axios headers
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
          } else {
            logout();
          }
        }
      } catch (error) {
        console.error('Auth initialization error:', error);
        logout();
      } finally {
        setLoading(false);
      }
    };

    initAuth();
  }, []);

  // Enhanced Login Function
  const login = async (credentials, method = 'email') => {
    try {
      setLoading(true);
      
      let response;
      
      switch (method) {
        case 'email':
          response = await axios.post('/api/auth/login/email', {
            email: credentials.email,
            password: credentials.password,
            rememberMe: credentials.rememberMe
          });
          break;
          
        case 'phone':
          response = await axios.post('/api/auth/login/phone', {
            phone: credentials.phone,
            password: credentials.password,
            rememberMe: credentials.rememberMe
          });
          break;
          
        case 'google':
          response = await axios.post('/api/auth/login/google', {
            token: credentials.token
          });
          break;
          
        case 'apple':
          response = await axios.post('/api/auth/login/apple', {
            token: credentials.token,
            user: credentials.user
          });
          break;
          
        default:
          throw new Error('Invalid login method');
      }
      
      const { token, user: userData, requires2FA } = response.data;
      
      if (requires2FA) {
        setTwoFactorRequired(true);
        setTempToken(token);
        return { requires2FA: true };
      }
      
      // Complete login
      await completeLogin(token, userData);
      
      message.success(`Welcome back, ${userData.profile?.firstName || 'User'}!`);
      
      // Redirect to intended page or dashboard
      const from = location.state?.from?.pathname || '/dashboard';
      navigate(from, { replace: true });
      
      return { success: true };
      
    } catch (error) {
      const errorMsg = error.response?.data?.message || 'Login failed';
      message.error(errorMsg);
      throw error;
    } finally {
      setLoading(false);
    }
  };

  // Complete login process
  const completeLogin = async (token, userData) => {
    localStorage.setItem('auth_token', token);
    localStorage.setItem('user_data', JSON.stringify(userData));
    
    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
    
    setUser(userData);
    setTwoFactorRequired(false);
    setTempToken(null);
  };

  // Verify 2FA Code
  const verifyTwoFactor = async (code) => {
    try {
      const response = await axios.post('/api/auth/verify-2fa', {
        token: tempToken,
        code
      });
      
      await completeLogin(response.data.token, response.data.user);
      message.success('Two-factor authentication successful!');
      
      navigate('/dashboard');
      return { success: true };
      
    } catch (error) {
      message.error('Invalid verification code');
      throw error;
    }
  };

  // Registration Function
  const register = async (userData, method = 'email') => {
    try {
      setLoading(true);
      
      const endpoint = method === 'phone' ? '/api/auth/register/phone' : '/api/auth/register/email';
      
      const response = await axios.post(endpoint, userData);
      
      const { token, user: registeredUser, requiresVerification } = response.data;
      
      if (requiresVerification) {
        // Store temp data for verification
        localStorage.setItem('pending_verification', JSON.stringify({
          token,
          user: registeredUser,
          method
        }));
        
        navigate(`/verify/${method}`);
        return { requiresVerification: true };
      }
      
      // Auto-login if no verification required
      await completeLogin(token, registeredUser);
      
      message.success('Registration successful! Welcome aboard!');
      navigate('/dashboard');
      
      return { success: true };
      
    } catch (error) {
      const errorMsg = error.response?.data?.message || 'Registration failed';
      message.error(errorMsg);
      throw error;
    } finally {
      setLoading(false);
    }
  };

  // Logout Function
  const logout = async () => {
    try {
      await axios.post('/api/auth/logout');
    } catch (error) {
      // Silent fail on logout
    }
    
    // Clear local storage
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user_data');
    localStorage.removeItem('pending_verification');
    
    // Clear axios headers
    delete axios.defaults.headers.common['Authorization'];
    
    // Reset state
    setUser(null);
    setAuthMethods([]);
    setTwoFactorRequired(false);
    setTempToken(null);
    
    // Navigate to login
    navigate('/login');
    
    message.success('Logged out successfully');
  };

  // Send Verification Code
  const sendVerificationCode = async (contact, method = 'email') => {
    try {
      const endpoint = method === 'phone' 
        ? '/api/auth/verify/phone/send' 
        : '/api/auth/verify/email/send';
      
      await axios.post(endpoint, { [method]: contact });
      
      message.success(`Verification code sent to your ${method}`);
      return { success: true };
      
    } catch (error) {
      message.error(`Failed to send verification code`);
      throw error;
    }
  };

  // Verify Code
  const verifyCode = async (contact, code, method = 'email') => {
    try {
      const endpoint = method === 'phone'
        ? '/api/auth/verify/phone/confirm'
        : '/api/auth/verify/email/confirm';
      
      const response = await axios.post(endpoint, {
        [method]: contact,
        code
      });
      
      // Complete registration if pending
      const pending = localStorage.getItem('pending_verification');
      if (pending) {
        const { token, user: pendingUser } = JSON.parse(pending);
        await completeLogin(token, pendingUser);
        localStorage.removeItem('pending_verification');
      }
      
      message.success(`${method.charAt(0).toUpperCase() + method.slice(1)} verified successfully!`);
      return { success: true };
      
    } catch (error) {
      message.error('Invalid verification code');
      throw error;
    }
  };

  // Forgot Password
  const forgotPassword = async (contact, method = 'email') => {
    try {
      await axios.post('/api/auth/password/forgot', {
        [method]: contact
      });
      
      message.success(`Password reset instructions sent to your ${method}`);
      return { success: true };
      
    } catch (error) {
      message.error('Failed to send reset instructions');
      throw error;
    }
  };

  // Reset Password
  const resetPassword = async (token, newPassword) => {
    try {
      await axios.post('/api/auth/password/reset', {
        token,
        newPassword
      });
      
      message.success('Password reset successfully! Please login with new password.');
      navigate('/login');
      return { success: true };
      
    } catch (error) {
      message.error('Password reset failed');
      throw error;
    }
  };

  // Update Profile
  const updateProfile = async (profileData) => {
    try {
      const response = await axios.put('/api/auth/profile', profileData);
      setUser(response.data.user);
      localStorage.setItem('user_data', JSON.stringify(response.data.user));
      
      message.success('Profile updated successfully!');
      return { success: true };
      
    } catch (error) {
      message.error('Failed to update profile');
      throw error;
    }
  };

  // Add Authentication Method
  const addAuthMethod = async (method, credentials) => {
    try {
      const response = await axios.post('/api/auth/methods/add', {
        method,
        credentials
      });
      
      setAuthMethods(response.data.authMethods);
      message.success(`${method} authentication added successfully!`);
      return { success: true };
      
    } catch (error) {
      message.error('Failed to add authentication method');
      throw error;
    }
  };

  // Remove Authentication Method
  const removeAuthMethod = async (method) => {
    try {
      const response = await axios.delete(`/api/auth/methods/${method}`);
      
      setAuthMethods(response.data.authMethods);
      message.success(`${method} authentication removed`);
      return { success: true };
      
    } catch (error) {
      message.error('Failed to remove authentication method');
      throw error;
    }
  };

  // Check Authentication Status
  const isAuthenticated = () => {
    return !!user && !loading;
  };

  // Check Role
  const hasRole = (role) => {
    return user?.role === role;
  };

  // Check Permission
  const hasPermission = (module, action) => {
    if (!user?.permissions) return false;
    
    const modulePermissions = user.permissions.find(p => p.module === module);
    return modulePermissions?.actions?.includes(action) || false;
  };

  const value = {
    user,
    loading,
    authMethods,
    twoFactorRequired,
    tempToken,
    login,
    register,
    logout,
    verifyTwoFactor,
    sendVerificationCode,
    verifyCode,
    forgotPassword,
    resetPassword,
    updateProfile,
    addAuthMethod,
    removeAuthMethod,
    isAuthenticated,
    hasRole,
    hasPermission
  };

  return (
    <GoogleOAuthProvider clientId={process.env.REACT_APP_GOOGLE_CLIENT_ID}>
      <AuthContext.Provider value={value}>
        {children}
      </AuthContext.Provider>
    </GoogleOAuthProvider>
  );
};

// Custom hook for Google Login
export const useGoogleAuth = () => {
  const { login } = useAuth();
  
  const googleLogin = useGoogleLogin({
    onSuccess: async (tokenResponse) => {
      try {
        await login({ token: tokenResponse.access_token }, 'google');
      } catch (error) {
        console.error('Google login failed:', error);
      }
    },
    onError: (error) => {
      console.error('Google login error:', error);
    },
    flow: 'implicit'
  });

  return { googleLogin };
};

// Custom hook for Apple Login (simplified)
export const useAppleAuth = () => {
  const { login } = useAuth();
  
  const appleLogin = async () => {
    // Note: This is a simplified implementation
    // In production, use proper Apple Sign-In implementation
    try {
      // For web, you'd typically use Apple's JavaScript SDK
      // This is a placeholder implementation
      console.log('Apple login would be implemented here');
      
      // Simulating Apple login response
      const mockAppleResponse = {
        token: 'mock_apple_token',
        user: {
          email: 'user@example.com',
          name: { firstName: 'John', lastName: 'Doe' }
        }
      };
      
      await login(mockAppleResponse, 'apple');
      
    } catch (error) {
      console.error('Apple login failed:', error);
    }
  };

  return { appleLogin };
};
```

### **Step 8.4: Advanced Login Component**
**File:** `client/src/components/auth/Login.js`

```javascript
import React, { useState, useEffect } from 'react';
import { 
  Form, 
  Input, 
  Button, 
  Card, 
  Row, 
  Col, 
  Divider, 
  message, 
  Tabs, 
  Checkbox,
  Modal,
  Steps,
  Alert
} from 'antd';
import { 
  MailOutlined, 
  PhoneOutlined, 
  LockOutlined, 
  GoogleOutlined,
  AppleOutlined,
  FacebookOutlined,
  LinkedinOutlined,
  SafetyOutlined,
  EyeInvisibleOutlined,
  EyeTwoToneOutlined
} from '@ant-design/icons';
import { useAuth, useGoogleAuth, useAppleAuth } from '../../contexts/AuthContext';
import { Link, useNavigate, useSearchParams } from 'react-router-dom';
import PhoneInput from 'react-phone-number-input';
import 'react-phone-number-input/style.css';
import './AuthStyles.css';

const { TabPane } = Tabs;
const { Step } = Steps;

const Login = () => {
  const [form] = Form.useForm();
  const [activeTab, setActiveTab] = useState('email');
  const [loading, setLoading] = useState(false);
  const [showPassword, setShowPassword] = useState(false);
  const [showTwoFactorModal, setShowTwoFactorModal] = useState(false);
  const [verificationStep, setVerificationStep] = useState(0);
  const [phoneValue, setPhoneValue] = useState('');
  const [loginMethods, setLoginMethods] = useState([]);
  
  const { 
    login, 
    verifyTwoFactor, 
    twoFactorRequired,
    sendVerificationCode,
    verifyCode 
  } = useAuth();
  const { googleLogin } = useGoogleAuth();
  const { appleLogin } = useAppleAuth();
  
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  
  // Check for redirect params
  useEffect(() => {
    const redirect = searchParams.get('redirect');
    const method = searchParams.get('method');
    
    if (method && ['email', 'phone', 'google', 'apple'].includes(method)) {
      setActiveTab(method);
    }
  }, [searchParams]);

  // Handle Email Login
  const handleEmailLogin = async (values) => {
    try {
      setLoading(true);
      const result = await login({
        email: values.email,
        password: values.password,
        rememberMe: values.rememberMe
      }, 'email');
      
      if (result?.requires2FA) {
        setShowTwoFactorModal(true);
      }
    } catch (error) {
      console.error('Login error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Handle Phone Login
  const handlePhoneLogin = async (values) => {
    try {
      setLoading(true);
      const result = await login({
        phone: phoneValue,
        password: values.password,
        rememberMe: values.rememberMe
      }, 'phone');
      
      if (result?.requires2FA) {
        setShowTwoFactorModal(true);
      }
    } catch (error) {
      console.error('Login error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Handle Social Login
  const handleSocialLogin = async (provider) => {
    try {
      setLoading(true);
      
      switch (provider) {
        case 'google':
          googleLogin();
          break;
        case 'apple':
          appleLogin();
          break;
        case 'facebook':
          // Implement Facebook login
          message.info('Facebook login coming soon!');
          break;
        case 'linkedin':
          // Implement LinkedIn login
          message.info('LinkedIn login coming soon!');
          break;
        default:
          break;
      }
    } catch (error) {
      console.error('Social login error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Handle 2FA Verification
  const handleTwoFactorVerify = async (values) => {
    try {
      setLoading(true);
      await verifyTwoFactor(values.code);
      setShowTwoFactorModal(false);
    } catch (error) {
      console.error('2FA verification error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Send Verification Code
  const handleSendVerification = async (contact, method) => {
    try {
      await sendVerificationCode(contact, method);
      setVerificationStep(1);
      message.success(`Verification code sent to your ${method}`);
    } catch (error) {
      console.error('Failed to send verification:', error);
    }
  };

  // Render Login Form
  const renderEmailLoginForm = () => (
    <Form
      form={form}
      name="email-login"
      onFinish={handleEmailLogin}
      layout="vertical"
      initialValues={{ rememberMe: true }}
    >
      <Form.Item
        name="email"
        label="Email Address"
        rules={[
          { required: true, message: 'Please enter your email!' },
          { type: 'email', message: 'Please enter a valid email!' }
        ]}
      >
        <Input
          prefix={<MailOutlined />}
          placeholder="Enter your email"
          size="large"
          autoComplete="email"
        />
      </Form.Item>

      <Form.Item
        name="password"
        label="Password"
        rules={[{ required: true, message: 'Please enter your password!' }]}
      >
        <Input.Password
          prefix={<LockOutlined />}
          placeholder="Enter your password"
          size="large"
          autoComplete="current-password"
          iconRender={visible => (visible ? <EyeTwoToneOutlined /> : <EyeInvisibleOutlined />)}
        />
      </Form.Item>

      <Form.Item>
        <div className="form-options">
          <Form.Item name="rememberMe" valuePropName="checked" noStyle>
            <Checkbox>Remember me</Checkbox>
          </Form.Item>
          <Link to="/forgot-password" className="forgot-password">
            Forgot password?
          </Link>
        </div>
      </Form.Item>

      <Form.Item>
        <Button
          type="primary"
          htmlType="submit"
          size="large"
          loading={loading}
          block
          className="login-button"
        >
          Sign In with Email
        </Button>
      </Form.Item>
    </Form>
  );

  // Render Phone Login Form
  const renderPhoneLoginForm = () => (
    <Form
      form={form}
      name="phone-login"
      onFinish={handlePhoneLogin}
      layout="vertical"
      initialValues={{ rememberMe: true }}
    >
      <Form.Item
        label="Phone Number"
        required
        rules={[{ required: true, message: 'Please enter your phone number!' }]}
      >
        <PhoneInput
          international
          countryCallingCodeEditable={false}
          defaultCountry="AE"
          value={phoneValue}
          onChange={setPhoneValue}
          className="ant-input phone-input"
          placeholder="Enter UAE phone number"
        />
      </Form.Item>

      <Form.Item
        name="password"
        label="Password"
        rules={[{ required: true, message: 'Please enter your password!' }]}
      >
        <Input.Password
          prefix={<LockOutlined />}
          placeholder="Enter your password"
          size="large"
          autoComplete="current-password"
          iconRender={visible => (visible ? <EyeTwoToneOutlined /> : <EyeInvisibleOutlined />)}
        />
      </Form.Item>

      <Form.Item>
        <div className="form-options">
          <Form.Item name="rememberMe" valuePropName="checked" noStyle>
            <Checkbox>Remember me</Checkbox>
          </Form.Item>
          <Link to="/forgot-password?method=phone" className="forgot-password">
            Forgot password?
          </Link>
        </div>
      </Form.Item>

      <Form.Item>
        <Button
          type="primary"
          htmlType="submit"
          size="large"
          loading={loading}
          block
          className="login-button"
        >
          Sign In with Phone
        </Button>
      </Form.Item>
    </Form>
  );

  // Render Social Login Buttons
  const renderSocialLogin = () => (
    <div className="social-login-container">
      <div className="social-login-buttons">
        <Button
          size="large"
          icon={<GoogleOutlined />}
          onClick={() => handleSocialLogin('google')}
          className="social-button google"
          block
        >
          Continue with Google
        </Button>
        
        <Button
          size="large"
          icon={<AppleOutlined />}
          onClick={() => handleSocialLogin('apple')}
          className="social-button apple"
          block
        >
          Continue with Apple
        </Button>
        
        <Button
          size="large"
          icon={<FacebookOutlined />}
          onClick={() => handleSocialLogin('facebook')}
          className="social-button facebook"
          block
        >
          Continue with Facebook
        </Button>
        
        <Button
          size="large"
          icon={<LinkedinOutlined />}
          onClick={() => handleSocialLogin('linkedin')}
          className="social-button linkedin"
          block
        >
          Continue with LinkedIn
        </Button>
      </div>
      
      <Divider>or continue with</Divider>
    </div>
  );

  // 2FA Modal
  const TwoFactorModal = () => (
    <Modal
      title={
        <div className="two-factor-header">
          <SafetyOutlined style={{ color: '#1890ff', marginRight: 8 }} />
          Two-Factor Authentication
        </div>
      }
      visible={showTwoFactorModal}
      onCancel={() => setShowTwoFactorModal(false)}
      footer={null}
      centered
      className="two-factor-modal"
    >
      <Steps current={verificationStep} className="verification-steps">
        <Step title="Verify Identity" />
        <Step title="Enter Code" />
        <Step title="Complete" />
      </Steps>
      
      {verificationStep === 0 && (
        <div className="verification-step">
          <Alert
            message="Additional Security Required"
            description="For your security, we need to verify your identity. Choose how you want to receive your verification code."
            type="info"
            showIcon
          />
          
          <div className="verification-options">
            <Button
              type="primary"
              icon={<MailOutlined />}
              onClick={() => handleSendVerification(user?.email, 'email')}
              block
              size="large"
            >
              Send code via Email
            </Button>
            
            <Button
              type="default"
              icon={<PhoneOutlined />}
              onClick={() => handleSendVerification(user?.phone, 'phone')}
              block
              size="large"
            >
              Send code via SMS
            </Button>
          </div>
        </div>
      )}
      
      {verificationStep === 1 && (
        <div className="verification-step">
          <Form onFinish={handleTwoFactorVerify}>
            <Form.Item
              name="code"
              rules={[
                { required: true, message: 'Please enter the verification code!' },
                { pattern: /^\d{6}$/, message: 'Code must be 6 digits' }
              ]}
            >
              <Input.OTP length={6} />
            </Form.Item>
            
            <Form.Item>
              <Button type="primary" htmlType="submit" block loading={loading}>
                Verify Code
              </Button>
            </Form.Item>
          </Form>
          
          <div className="resend-code">
            Didn't receive a code?{' '}
            <Button type="link" onClick={() => setVerificationStep(0)}>
              Send again
            </Button>
          </div>
        </div>
      )}
    </Modal>
  );

  return (
    <div className="auth-container">
      <Row justify="center" align="middle" style={{ minHeight: '100vh' }}>
        <Col xs={24} sm={20} md={16} lg={12} xl={8}>
          <Card className="auth-card">
            <div className="auth-header">
              <h2>Welcome Back</h2>
              <p>Sign in to your White Caves Real Estate account</p>
            </div>
            
            {renderSocialLogin()}
            
            <Tabs 
              activeKey={activeTab} 
              onChange={setActiveTab}
              className="auth-tabs"
            >
              <TabPane tab={<span><MailOutlined /> Email</span>} key="email">
                {renderEmailLoginForm()}
              </TabPane>
              <TabPane tab={<span><PhoneOutlined /> Phone</span>} key="phone">
                {renderPhoneLoginForm()}
              </TabPane>
            </Tabs>
            
            <div className="auth-footer">
              <p>
                Don't have an account?{' '}
                <Link to="/register" className="auth-link">
                  Sign up here
                </Link>
              </p>
              
              <div className="quick-actions">
                <Link to="/demo-request" className="demo-link">
                  Request a Demo
                </Link>
                <span className="divider">|</span>
                <Link to="/contact" className="contact-link">
                  Contact Support
                </Link>
              </div>
            </div>
          </Card>
          
          {/* Security Notice */}
          <Alert
            message="Security Notice"
            description="We use industry-standard encryption to protect your data. Never share your password with anyone."
            type="info"
            showIcon
            className="security-notice"
          />
        </Col>
      </Row>
      
      <TwoFactorModal />
    </div>
  );
};

export default Login;
```

### **Step 8.5: Advanced Signup Component**
**File:** `client/src/components/auth/Signup.js`

```javascript
import React, { useState } from 'react';
import { 
  Form, 
  Input, 
  Button, 
  Card, 
  Row, 
  Col, 
  Steps, 
  Select, 
  Radio,
  Check

## **âœ… PHASE 8: ADVANCED AUTHENTICATION SYSTEM**

### **Step 8.1: Multi-Strategy Authentication Schema**
**File:** `server/models/User.js`

```javascript
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
const Schema = mongoose.Schema;

const UserSchema = new Schema({
  // Primary Identification
  email: { 
    type: String, 
    lowercase: true,
    trim: true,
    sparse: true
  },
  phone: {
    type: String,
    validate: {
      validator: function(v) {
        // UAE phone validation + international
        return /^(\+971|00971|0)?(5[0-9]{8})$/.test(v) || /^\+[1-9]\d{1,14}$/.test(v);
      },
      message: props => `${props.value} is not a valid phone number!`
    },
    sparse: true
  },
  
  // Authentication Methods
  authMethods: [{
    provider: {
      type: String,
      enum: ['local', 'google', 'apple', 'facebook', 'linkedin'],
      required: true
    },
    providerId: String, // Google ID, Apple ID, etc.
    verified: { type: Boolean, default: false },
    primary: { type: Boolean, default: false },
    lastUsed: Date
  }],
  
  // Local Auth (for email/phone login)
  localAuth: {
    password: { 
      type: String,
      select: false,
      minlength: 8
    },
    passwordResetToken: String,
    passwordResetExpires: Date,
    emailVerificationToken: String,
    emailVerified: { type: Boolean, default: false },
    phoneVerificationCode: String,
    phoneVerified: { type: Boolean, default: false },
    twoFactorEnabled: { type: Boolean, default: false },
    twoFactorSecret: { type: String, select: false }
  },
  
  // OAuth Profiles
  oauthProfiles: {
    google: {
      id: String,
      email: String,
      name: String,
      picture: String,
      locale: String
    },
    apple: {
      id: String,
      email: String,
      name: {
        firstName: String,
        lastName: String
      }
    }
  },
  
  // User Profile
  profile: {
    firstName: { type: String, trim: true },
    lastName: { type: String, trim: true },
    fullName: { type: String, trim: true },
    avatar: String,
    preferredLanguage: { 
      type: String, 
      enum: ['en', 'ar'], 
      default: 'en' 
    },
    timezone: { type: String, default: 'Asia/Dubai' },
    currency: { type: String, default: 'AED' },
    notificationPreferences: {
      email: { type: Boolean, default: true },
      sms: { type: Boolean, default: true },
      whatsapp: { type: Boolean, default: true },
      push: { type: Boolean, default: true }
    }
  },
  
  // UAE Specific
  uaeDetails: {
    emiratesId: {
      type: String,
      validate: {
        validator: function(v) {
          // Emirates ID validation: 784-YYYY-NNNNNNN-#
          return /^784-\d{4}-\d{7}-\d{1}$/.test(v);
        },
        message: props => `${props.value} is not a valid Emirates ID!`
      }
    },
    passportNumber: String,
    nationality: String,
    visaType: String,
    visaExpiry: Date
  },
  
  // Role & Permissions
  role: {
    type: String,
    enum: ['super_admin', 'company_owner', 'branch_manager', 'agent', 'client', 'tenant'],
    default: 'client'
  },
  permissions: [{
    module: String,
    actions: [String]
  }],
  
  // Security
  lastLogin: Date,
  loginHistory: [{
    timestamp: { type: Date, default: Date.now },
    ip: String,
    userAgent: String,
    location: String,
    method: String
  }],
  activeSessions: [{
    token: String,
    userAgent: String,
    ip: String,
    createdAt: { type: Date, default: Date.now },
    expiresAt: Date
  }],
  
  // Status
  status: {
    type: String,
    enum: ['active', 'inactive', 'suspended', 'pending_verification'],
    default: 'pending_verification'
  },
  verificationLevel: {
    type: String,
    enum: ['unverified', 'basic', 'verified', 'fully_verified'],
    default: 'unverified'
  },
  
  // Timestamps
  createdAt: { type: Date, default: Date.now },
  updatedAt: Date,
  lastActive: Date
}, {
  timestamps: true,
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// Indexes
UserSchema.index({ email: 1 }, { unique: true, sparse: true });
UserSchema.index({ phone: 1 }, { unique: true, sparse: true });
UserSchema.index({ 'oauthProfiles.google.id': 1 }, { sparse: true });
UserSchema.index({ 'oauthProfiles.apple.id': 1 }, { sparse: true });
UserSchema.index({ role: 1, status: 1 });
UserSchema.index({ 'uaeDetails.emiratesId': 1 }, { sparse: true });

// Password hashing middleware
UserSchema.pre('save', async function(next) {
  if (!this.isModified('localAuth.password')) return next();
  
  try {
    const salt = await bcrypt.genSalt(12);
    this.localAuth.password = await bcrypt.hash(this.localAuth.password, salt);
    next();
  } catch (error) {
    next(error);
  }
});

// Method to compare password
UserSchema.methods.comparePassword = async function(candidatePassword) {
  return await bcrypt.compare(candidatePassword, this.localAuth.password);
};

// Method to get primary contact
UserSchema.virtual('primaryContact').get(function() {
  const primaryMethod = this.authMethods.find(m => m.primary);
  if (primaryMethod?.provider === 'local') {
    return this.email || this.phone;
  }
  return this.email || this.phone;
});

module.exports = mongoose.model('User', UserSchema);
```

### **Step 8.2: Authentication Service**
**File:** `server/services/authService.js`

```javascript
const jwt = require('jsonwebtoken');
const crypto = require('crypto');
const { OAuth2Client } = require('google-auth-library');
const axios = require('axios');

class AuthService {
  constructor() {
    this.jwtSecret = process.env.JWT_SECRET;
    this.jwtExpire = process.env.JWT_EXPIRE || '7d';
    this.googleClient = new OAuth2Client(process.env.GOOGLE_CLIENT_ID);
  }

  // Generate JWT Token
  generateToken(user, deviceInfo = {}) {
    const payload = {
      userId: user._id,
      email: user.email,
      phone: user.phone,
      role: user.role,
      verificationLevel: user.verificationLevel,
      authMethods: user.authMethods
    };

    return jwt.sign(payload, this.jwtSecret, {
      expiresIn: this.jwtExpire,
      issuer: 'white-caves-realestate',
      audience: 'user'
    });
  }

  // Verify JWT Token
  verifyToken(token) {
    try {
      return jwt.verify(token, this.jwtSecret);
    } catch (error) {
      throw new Error('Invalid or expired token');
    }
  }

  // Google Authentication
  async verifyGoogleToken(token) {
    try {
      const ticket = await this.googleClient.verifyIdToken({
        idToken: token,
        audience: process.env.GOOGLE_CLIENT_ID
      });

      const payload = ticket.getPayload();
      
      return {
        providerId: payload.sub,
        email: payload.email,
        emailVerified: payload.email_verified,
        name: payload.name,
        firstName: payload.given_name,
        lastName: payload.family_name,
        picture: payload.picture,
        locale: payload.locale
      };
    } catch (error) {
      throw new Error('Invalid Google token');
    }
  }

  // Apple Authentication (simplified)
  async verifyAppleToken(identityToken) {
    // Note: Apple Sign-In requires additional setup with Apple Developer account
    // This is a simplified version
    try {
      // In production, verify with Apple's servers
      const response = await axios.get('https://appleid.apple.com/auth/keys');
      const keys = response.data.keys;
      
      // Verify JWT with Apple's public keys
      // Implementation depends on your Apple Developer setup
      
      return {
        provider: 'apple',
        // Extract claims from verified token
      };
    } catch (error) {
      throw new Error('Apple authentication failed');
    }
  }

  // Generate Verification Code
  generateVerificationCode(length = 6) {
    return crypto.randomInt(Math.pow(10, length - 1), Math.pow(10, length) - 1).toString();
  }

  // Generate Password Reset Token
  generatePasswordResetToken() {
    const resetToken = crypto.randomBytes(32).toString('hex');
    const hashedToken = crypto.createHash('sha256').update(resetToken).digest('hex');
    const expires = Date.now() + 10 * 60 * 1000; // 10 minutes
    
    return { resetToken, hashedToken, expires };
  }

  // Validate UAE Phone Number
  validateUAEPhone(phone) {
    const uaeRegex = /^(\+971|00971|0)?(5[0-9]{8})$/;
    return uaeRegex.test(phone);
  }

  // Format phone to international
  formatPhoneInternational(phone) {
    if (phone.startsWith('0')) {
      return '+971' + phone.substring(1);
    }
    if (phone.startsWith('00971')) {
      return '+971' + phone.substring(5);
    }
    return phone;
  }
}

module.exports = AuthService;
```

### **Step 8.3: Advanced Auth Context & Hook**
**File:** `client/src/contexts/AuthContext.js`

```javascript
import React, { createContext, useState, useContext, useEffect, useCallback } from 'react';
import axios from 'axios';
import { useNavigate, useLocation } from 'react-router-dom';
import { message, notification } from 'antd';
import { GoogleOAuthProvider, useGoogleLogin } from '@react-oauth/google';
import * as AppleAuthentication from 'expo-apple-authentication'; // For React Native, web alternative needed

const AuthContext = createContext({});

export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [authMethods, setAuthMethods] = useState([]);
  const [twoFactorRequired, setTwoFactorRequired] = useState(false);
  const [tempToken, setTempToken] = useState(null);
  
  const navigate = useNavigate();
  const location = useLocation();

  // Initialize auth state
  useEffect(() => {
    const initAuth = async () => {
      try {
        const token = localStorage.getItem('auth_token');
        const userData = localStorage.getItem('user_data');
        
        if (token && userData) {
          // Validate token with server
          const response = await axios.get('/api/auth/validate', {
            headers: { Authorization: `Bearer ${token}` }
          });
          
          if (response.data.valid) {
            setUser(JSON.parse(userData));
            setAuthMethods(response.data.authMethods || []);
            
            // Set default axios headers
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
          } else {
            logout();
          }
        }
      } catch (error) {
        console.error('Auth initialization error:', error);
        logout();
      } finally {
        setLoading(false);
      }
    };

    initAuth();
  }, []);

  // Enhanced Login Function
  const login = async (credentials, method = 'email') => {
    try {
      setLoading(true);
      
      let response;
      
      switch (method) {
        case 'email':
          response = await axios.post('/api/auth/login/email', {
            email: credentials.email,
            password: credentials.password,
            rememberMe: credentials.rememberMe
          });
          break;
          
        case 'phone':
          response = await axios.post('/api/auth/login/phone', {
            phone: credentials.phone,
            password: credentials.password,
            rememberMe: credentials.rememberMe
          });
          break;
          
        case 'google':
          response = await axios.post('/api/auth/login/google', {
            token: credentials.token
          });
          break;
          
        case 'apple':
          response = await axios.post('/api/auth/login/apple', {
            token: credentials.token,
            user: credentials.user
          });
          break;
          
        default:
          throw new Error('Invalid login method');
      }
      
      const { token, user: userData, requires2FA } = response.data;
      
      if (requires2FA) {
        setTwoFactorRequired(true);
        setTempToken(token);
        return { requires2FA: true };
      }
      
      // Complete login
      await completeLogin(token, userData);
      
      message.success(`Welcome back, ${userData.profile?.firstName || 'User'}!`);
      
      // Redirect to intended page or dashboard
      const from = location.state?.from?.pathname || '/dashboard';
      navigate(from, { replace: true });
      
      return { success: true };
      
    } catch (error) {
      const errorMsg = error.response?.data?.message || 'Login failed';
      message.error(errorMsg);
      throw error;
    } finally {
      setLoading(false);
    }
  };

  // Complete login process
  const completeLogin = async (token, userData) => {
    localStorage.setItem('auth_token', token);
    localStorage.setItem('user_data', JSON.stringify(userData));
    
    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
    
    setUser(userData);
    setTwoFactorRequired(false);
    setTempToken(null);
  };

  // Verify 2FA Code
  const verifyTwoFactor = async (code) => {
    try {
      const response = await axios.post('/api/auth/verify-2fa', {
        token: tempToken,
        code
      });
      
      await completeLogin(response.data.token, response.data.user);
      message.success('Two-factor authentication successful!');
      
      navigate('/dashboard');
      return { success: true };
      
    } catch (error) {
      message.error('Invalid verification code');
      throw error;
    }
  };

  // Registration Function
  const register = async (userData, method = 'email') => {
    try {
      setLoading(true);
      
      const endpoint = method === 'phone' ? '/api/auth/register/phone' : '/api/auth/register/email';
      
      const response = await axios.post(endpoint, userData);
      
      const { token, user: registeredUser, requiresVerification } = response.data;
      
      if (requiresVerification) {
        // Store temp data for verification
        localStorage.setItem('pending_verification', JSON.stringify({
          token,
          user: registeredUser,
          method
        }));
        
        navigate(`/verify/${method}`);
        return { requiresVerification: true };
      }
      
      // Auto-login if no verification required
      await completeLogin(token, registeredUser);
      
      message.success('Registration successful! Welcome aboard!');
      navigate('/dashboard');
      
      return { success: true };
      
    } catch (error) {
      const errorMsg = error.response?.data?.message || 'Registration failed';
      message.error(errorMsg);
      throw error;
    } finally {
      setLoading(false);
    }
  };

  // Logout Function
  const logout = async () => {
    try {
      await axios.post('/api/auth/logout');
    } catch (error) {
      // Silent fail on logout
    }
    
    // Clear local storage
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user_data');
    localStorage.removeItem('pending_verification');
    
    // Clear axios headers
    delete axios.defaults.headers.common['Authorization'];
    
    // Reset state
    setUser(null);
    setAuthMethods([]);
    setTwoFactorRequired(false);
    setTempToken(null);
    
    // Navigate to login
    navigate('/login');
    
    message.success('Logged out successfully');
  };

  // Send Verification Code
  const sendVerificationCode = async (contact, method = 'email') => {
    try {
      const endpoint = method === 'phone' 
        ? '/api/auth/verify/phone/send' 
        : '/api/auth/verify/email/send';
      
      await axios.post(endpoint, { [method]: contact });
      
      message.success(`Verification code sent to your ${method}`);
      return { success: true };
      
    } catch (error) {
      message.error(`Failed to send verification code`);
      throw error;
    }
  };

  // Verify Code
  const verifyCode = async (contact, code, method = 'email') => {
    try {
      const endpoint = method === 'phone'
        ? '/api/auth/verify/phone/confirm'
        : '/api/auth/verify/email/confirm';
      
      const response = await axios.post(endpoint, {
        [method]: contact,
        code
      });
      
      // Complete registration if pending
      const pending = localStorage.getItem('pending_verification');
      if (pending) {
        const { token, user: pendingUser } = JSON.parse(pending);
        await completeLogin(token, pendingUser);
        localStorage.removeItem('pending_verification');
      }
      
      message.success(`${method.charAt(0).toUpperCase() + method.slice(1)} verified successfully!`);
      return { success: true };
      
    } catch (error) {
      message.error('Invalid verification code');
      throw error;
    }
  };

  // Forgot Password
  const forgotPassword = async (contact, method = 'email') => {
    try {
      await axios.post('/api/auth/password/forgot', {
        [method]: contact
      });
      
      message.success(`Password reset instructions sent to your ${method}`);
      return { success: true };
      
    } catch (error) {
      message.error('Failed to send reset instructions');
      throw error;
    }
  };

  // Reset Password
  const resetPassword = async (token, newPassword) => {
    try {
      await axios.post('/api/auth/password/reset', {
        token,
        newPassword
      });
      
      message.success('Password reset successfully! Please login with new password.');
      navigate('/login');
      return { success: true };
      
    } catch (error) {
      message.error('Password reset failed');
      throw error;
    }
  };

  // Update Profile
  const updateProfile = async (profileData) => {
    try {
      const response = await axios.put('/api/auth/profile', profileData);
      setUser(response.data.user);
      localStorage.setItem('user_data', JSON.stringify(response.data.user));
      
      message.success('Profile updated successfully!');
      return { success: true };
      
    } catch (error) {
      message.error('Failed to update profile');
      throw error;
    }
  };

  // Add Authentication Method
  const addAuthMethod = async (method, credentials) => {
    try {
      const response = await axios.post('/api/auth/methods/add', {
        method,
        credentials
      });
      
      setAuthMethods(response.data.authMethods);
      message.success(`${method} authentication added successfully!`);
      return { success: true };
      
    } catch (error) {
      message.error('Failed to add authentication method');
      throw error;
    }
  };

  // Remove Authentication Method
  const removeAuthMethod = async (method) => {
    try {
      const response = await axios.delete(`/api/auth/methods/${method}`);
      
      setAuthMethods(response.data.authMethods);
      message.success(`${method} authentication removed`);
      return { success: true };
      
    } catch (error) {
      message.error('Failed to remove authentication method');
      throw error;
    }
  };

  // Check Authentication Status
  const isAuthenticated = () => {
    return !!user && !loading;
  };

  // Check Role
  const hasRole = (role) => {
    return user?.role === role;
  };

  // Check Permission
  const hasPermission = (module, action) => {
    if (!user?.permissions) return false;
    
    const modulePermissions = user.permissions.find(p => p.module === module);
    return modulePermissions?.actions?.includes(action) || false;
  };

  const value = {
    user,
    loading,
    authMethods,
    twoFactorRequired,
    tempToken,
    login,
    register,
    logout,
    verifyTwoFactor,
    sendVerificationCode,
    verifyCode,
    forgotPassword,
    resetPassword,
    updateProfile,
    addAuthMethod,
    removeAuthMethod,
    isAuthenticated,
    hasRole,
    hasPermission
  };

  return (
    <GoogleOAuthProvider clientId={process.env.REACT_APP_GOOGLE_CLIENT_ID}>
      <AuthContext.Provider value={value}>
        {children}
      </AuthContext.Provider>
    </GoogleOAuthProvider>
  );
};

// Custom hook for Google Login
export const useGoogleAuth = () => {
  const { login } = useAuth();
  
  const googleLogin = useGoogleLogin({
    onSuccess: async (tokenResponse) => {
      try {
        await login({ token: tokenResponse.access_token }, 'google');
      } catch (error) {
        console.error('Google login failed:', error);
      }
    },
    onError: (error) => {
      console.error('Google login error:', error);
    },
    flow: 'implicit'
  });

  return { googleLogin };
};

// Custom hook for Apple Login (simplified)
export const useAppleAuth = () => {
  const { login } = useAuth();
  
  const appleLogin = async () => {
    // Note: This is a simplified implementation
    // In production, use proper Apple Sign-In implementation
    try {
      // For web, you'd typically use Apple's JavaScript SDK
      // This is a placeholder implementation
      console.log('Apple login would be implemented here');
      
      // Simulating Apple login response
      const mockAppleResponse = {
        token: 'mock_apple_token',
        user: {
          email: 'user@example.com',
          name: { firstName: 'John', lastName: 'Doe' }
        }
      };
      
      await login(mockAppleResponse, 'apple');
      
    } catch (error) {
      console.error('Apple login failed:', error);
    }
  };

  return { appleLogin };
};
```

### **Step 8.4: Advanced Login Component**
**File:** `client/src/components/auth/Login.js`

```javascript
import React, { useState, useEffect } from 'react';
import { 
  Form, 
  Input, 
  Button, 
  Card, 
  Row, 
  Col, 
  Divider, 
  message, 
  Tabs, 
  Checkbox,
  Modal,
  Steps,
  Alert
} from 'antd';
import { 
  MailOutlined, 
  PhoneOutlined, 
  LockOutlined, 
  GoogleOutlined,
  AppleOutlined,
  FacebookOutlined,
  LinkedinOutlined,
  SafetyOutlined,
  EyeInvisibleOutlined,
  EyeTwoToneOutlined
} from '@ant-design/icons';
import { useAuth, useGoogleAuth, useAppleAuth } from '../../contexts/AuthContext';
import { Link, useNavigate, useSearchParams } from 'react-router-dom';
import PhoneInput from 'react-phone-number-input';
import 'react-phone-number-input/style.css';
import './AuthStyles.css';

const { TabPane } = Tabs;
const { Step } = Steps;

const Login = () => {
  const [form] = Form.useForm();
  const [activeTab, setActiveTab] = useState('email');
  const [loading, setLoading] = useState(false);
  const [showPassword, setShowPassword] = useState(false);
  const [showTwoFactorModal, setShowTwoFactorModal] = useState(false);
  const [verificationStep, setVerificationStep] = useState(0);
  const [phoneValue, setPhoneValue] = useState('');
  const [loginMethods, setLoginMethods] = useState([]);
  
  const { 
    login, 
    verifyTwoFactor, 
    twoFactorRequired,
    sendVerificationCode,
    verifyCode 
  } = useAuth();
  const { googleLogin } = useGoogleAuth();
  const { appleLogin } = useAppleAuth();
  
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  
  // Check for redirect params
  useEffect(() => {
    const redirect = searchParams.get('redirect');
    const method = searchParams.get('method');
    
    if (method && ['email', 'phone', 'google', 'apple'].includes(method)) {
      setActiveTab(method);
    }
  }, [searchParams]);

  // Handle Email Login
  const handleEmailLogin = async (values) => {
    try {
      setLoading(true);
      const result = await login({
        email: values.email,
        password: values.password,
        rememberMe: values.rememberMe
      }, 'email');
      
      if (result?.requires2FA) {
        setShowTwoFactorModal(true);
      }
    } catch (error) {
      console.error('Login error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Handle Phone Login
  const handlePhoneLogin = async (values) => {
    try {
      setLoading(true);
      const result = await login({
        phone: phoneValue,
        password: values.password,
        rememberMe: values.rememberMe
      }, 'phone');
      
      if (result?.requires2FA) {
        setShowTwoFactorModal(true);
      }
    } catch (error) {
      console.error('Login error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Handle Social Login
  const handleSocialLogin = async (provider) => {
    try {
      setLoading(true);
      
      switch (provider) {
        case 'google':
          googleLogin();
          break;
        case 'apple':
          appleLogin();
          break;
        case 'facebook':
          // Implement Facebook login
          message.info('Facebook login coming soon!');
          break;
        case 'linkedin':
          // Implement LinkedIn login
          message.info('LinkedIn login coming soon!');
          break;
        default:
          break;
      }
    } catch (error) {
      console.error('Social login error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Handle 2FA Verification
  const handleTwoFactorVerify = async (values) => {
    try {
      setLoading(true);
      await verifyTwoFactor(values.code);
      setShowTwoFactorModal(false);
    } catch (error) {
      console.error('2FA verification error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Send Verification Code
  const handleSendVerification = async (contact, method) => {
    try {
      await sendVerificationCode(contact, method);
      setVerificationStep(1);
      message.success(`Verification code sent to your ${method}`);
    } catch (error) {
      console.error('Failed to send verification:', error);
    }
  };

  // Render Login Form
  const renderEmailLoginForm = () => (
    <Form
      form={form}
      name="email-login"
      onFinish={handleEmailLogin}
      layout="vertical"
      initialValues={{ rememberMe: true }}
    >
      <Form.Item
        name="email"
        label="Email Address"
        rules={[
          { required: true, message: 'Please enter your email!' },
          { type: 'email', message: 'Please enter a valid email!' }
        ]}
      >
        <Input
          prefix={<MailOutlined />}
          placeholder="Enter your email"
          size="large"
          autoComplete="email"
        />
      </Form.Item>

      <Form.Item
        name="password"
        label="Password"
        rules={[{ required: true, message: 'Please enter your password!' }]}
      >
        <Input.Password
          prefix={<LockOutlined />}
          placeholder="Enter your password"
          size="large"
          autoComplete="current-password"
          iconRender={visible => (visible ? <EyeTwoToneOutlined /> : <EyeInvisibleOutlined />)}
        />
      </Form.Item>

      <Form.Item>
        <div className="form-options">
          <Form.Item name="rememberMe" valuePropName="checked" noStyle>
            <Checkbox>Remember me</Checkbox>
          </Form.Item>
          <Link to="/forgot-password" className="forgot-password">
            Forgot password?
          </Link>
        </div>
      </Form.Item>

      <Form.Item>
        <Button
          type="primary"
          htmlType="submit"
          size="large"
          loading={loading}
          block
          className="login-button"
        >
          Sign In with Email
        </Button>
      </Form.Item>
    </Form>
  );

  // Render Phone Login Form
  const renderPhoneLoginForm = () => (
    <Form
      form={form}
      name="phone-login"
      onFinish={handlePhoneLogin}
      layout="vertical"
      initialValues={{ rememberMe: true }}
    >
      <Form.Item
        label="Phone Number"
        required
        rules={[{ required: true, message: 'Please enter your phone number!' }]}
      >
        <PhoneInput
          international
          countryCallingCodeEditable={false}
          defaultCountry="AE"
          value={phoneValue}
          onChange={setPhoneValue}
          className="ant-input phone-input"
          placeholder="Enter UAE phone number"
        />
      </Form.Item>

      <Form.Item
        name="password"
        label="Password"
        rules={[{ required: true, message: 'Please enter your password!' }]}
      >
        <Input.Password
          prefix={<LockOutlined />}
          placeholder="Enter your password"
          size="large"
          autoComplete="current-password"
          iconRender={visible => (visible ? <EyeTwoToneOutlined /> : <EyeInvisibleOutlined />)}
        />
      </Form.Item>

      <Form.Item>
        <div className="form-options">
          <Form.Item name="rememberMe" valuePropName="checked" noStyle>
            <Checkbox>Remember me</Checkbox>
          </Form.Item>
          <Link to="/forgot-password?method=phone" className="forgot-password">
            Forgot password?
          </Link>
        </div>
      </Form.Item>

      <Form.Item>
        <Button
          type="primary"
          htmlType="submit"
          size="large"
          loading={loading}
          block
          className="login-button"
        >
          Sign In with Phone
        </Button>
      </Form.Item>
    </Form>
  );

  // Render Social Login Buttons
  const renderSocialLogin = () => (
    <div className="social-login-container">
      <div className="social-login-buttons">
        <Button
          size="large"
          icon={<GoogleOutlined />}
          onClick={() => handleSocialLogin('google')}
          className="social-button google"
          block
        >
          Continue with Google
        </Button>
        
        <Button
          size="large"
          icon={<AppleOutlined />}
          onClick={() => handleSocialLogin('apple')}
          className="social-button apple"
          block
        >
          Continue with Apple
        </Button>
        
        <Button
          size="large"
          icon={<FacebookOutlined />}
          onClick={() => handleSocialLogin('facebook')}
          className="social-button facebook"
          block
        >
          Continue with Facebook
        </Button>
        
        <Button
          size="large"
          icon={<LinkedinOutlined />}
          onClick={() => handleSocialLogin('linkedin')}
          className="social-button linkedin"
          block
        >
          Continue with LinkedIn
        </Button>
      </div>
      
      <Divider>or continue with</Divider>
    </div>
  );

  // 2FA Modal
  const TwoFactorModal = () => (
    <Modal
      title={
        <div className="two-factor-header">
          <SafetyOutlined style={{ color: '#1890ff', marginRight: 8 }} />
          Two-Factor Authentication
        </div>
      }
      visible={showTwoFactorModal}
      onCancel={() => setShowTwoFactorModal(false)}
      footer={null}
      centered
      className="two-factor-modal"
    >
      <Steps current={verificationStep} className="verification-steps">
        <Step title="Verify Identity" />
        <Step title="Enter Code" />
        <Step title="Complete" />
      </Steps>
      
      {verificationStep === 0 && (
        <div className="verification-step">
          <Alert
            message="Additional Security Required"
            description="For your security, we need to verify your identity. Choose how you want to receive your verification code."
            type="info"
            showIcon
          />
          
          <div className="verification-options">
            <Button
              type="primary"
              icon={<MailOutlined />}
              onClick={() => handleSendVerification(user?.email, 'email')}
              block
              size="large"
            >
              Send code via Email
            </Button>
            
            <Button
              type="default"
              icon={<PhoneOutlined />}
              onClick={() => handleSendVerification(user?.phone, 'phone')}
              block
              size="large"
            >
              Send code via SMS
            </Button>
          </div>
        </div>
      )}
      
      {verificationStep === 1 && (
        <div className="verification-step">
          <Form onFinish={handleTwoFactorVerify}>
            <Form.Item
              name="code"
              rules={[
                { required: true, message: 'Please enter the verification code!' },
                { pattern: /^\d{6}$/, message: 'Code must be 6 digits' }
              ]}
            >
              <Input.OTP length={6} />
            </Form.Item>
            
            <Form.Item>
              <Button type="primary" htmlType="submit" block loading={loading}>
                Verify Code
              </Button>
            </Form.Item>
          </Form>
          
          <div className="resend-code">
            Didn't receive a code?{' '}
            <Button type="link" onClick={() => setVerificationStep(0)}>
              Send again
            </Button>
          </div>
        </div>
      )}
    </Modal>
  );

  return (
    <div className="auth-container">
      <Row justify="center" align="middle" style={{ minHeight: '100vh' }}>
        <Col xs={24} sm={20} md={16} lg={12} xl={8}>
          <Card className="auth-card">
            <div className="auth-header">
              <h2>Welcome Back</h2>
              <p>Sign in to your White Caves Real Estate account</p>
            </div>
            
            {renderSocialLogin()}
            
            <Tabs 
              activeKey={activeTab} 
              onChange={setActiveTab}
              className="auth-tabs"
            >
              <TabPane tab={<span><MailOutlined /> Email</span>} key="email">
                {renderEmailLoginForm()}
              </TabPane>
              <TabPane tab={<span><PhoneOutlined /> Phone</span>} key="phone">
                {renderPhoneLoginForm()}
              </TabPane>
            </Tabs>
            
            <div className="auth-footer">
              <p>
                Don't have an account?{' '}
                <Link to="/register" className="auth-link">
                  Sign up here
                </Link>
              </p>
              
              <div className="quick-actions">
                <Link to="/demo-request" className="demo-link">
                  Request a Demo
                </Link>
                <span className="divider">|</span>
                <Link to="/contact" className="contact-link">
                  Contact Support
                </Link>
              </div>
            </div>
          </Card>
          
          {/* Security Notice */}
          <Alert
            message="Security Notice"
            description="We use industry-standard encryption to protect your data. Never share your password with anyone."
            type="info"
            showIcon
            className="security-notice"
          />
        </Col>
      </Row>
      
      <TwoFactorModal />
    </div>
  );
};

export default Login;
```

### **Step 8.5: Advanced Signup Component**
**File:** `client/src/components/auth/Signup.js`

```javascript
import React, { useState } from 'react';
import { 
  Form, 
  Input, 
  Button, 
  Card, 
  Row, 
  Col, 
  Steps, 
  Select, 
  Radio,
  Check
## **âœ… PHASE 9: TESTING & QUALITY ASSURANCE**

### **Step 9.1: Complete Testing Setup**

#### **Root Testing Configuration**
**File:** `jest.config.js` (Root Directory)
```javascript
module.exports = {
  projects: [
    {
      displayName: 'server',
      testEnvironment: 'node',
      roots: ['<rootDir>/server'],
      setupFilesAfterEnv: ['<rootDir>/server/tests/setup.js'],
      testMatch: ['**/tests/**/*.test.js'],
      collectCoverageFrom: [
        'server/**/*.js',
        '!server/node_modules/**',
        '!server/tests/**',
        '!server/coverage/**'
      ],
      coverageDirectory: '<rootDir>/server/coverage',
      coverageThreshold: {
        global: {
          statements: 80,
          branches: 75,
          functions: 80,
          lines: 80
        }
      }
    },
    {
      displayName: 'client',
      testEnvironment: 'jsdom',
      roots: ['<rootDir>/client/src'],
      setupFilesAfterEnv: ['<rootDir>/client/src/setupTests.js'],
      moduleNameMapper: {
        '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
        '\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$':
          '<rootDir>/client/src/tests/__mocks__/fileMock.js'
      },
      transform: {
        '^.+\\.(js|jsx)$': 'babel-jest'
      },
      testMatch: ['**/__tests__/**/*.test.js', '**/*.test.js'],
      collectCoverageFrom: [
        'client/src/**/*.{js,jsx}',
        '!client/src/index.js',
        '!client/src/serviceWorker.js',
        '!client/src/reportWebVitals.js',
        '!client/src/setupTests.js',
        '!client/src/tests/**'
      ],
      coverageDirectory: '<rootDir>/client/coverage',
      coverageThreshold: {
        global: {
          statements: 70,
          branches: 65,
          functions: 70,
          lines: 70
        }
      }
    }
  ],
  verbose: true,
  collectCoverage: true,
  coverageReporters: ['text', 'lcov', 'html'],
  reporters: [
    'default',
    ['jest-junit', {
      outputDirectory: 'test-results',
      outputName: 'junit.xml'
    }]
  ]
};
```

#### **Client Testing Setup**
**File:** `client/src/setupTests.js`
```javascript
import '@testing-library/jest-dom';
import { TextEncoder, TextDecoder } from 'util';

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: jest.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: jest.fn(),
    removeListener: jest.fn(),
    addEventListener: jest.fn(),
    removeEventListener: jest.fn(),
    dispatchEvent: jest.fn(),
  })),
});

// Mock ResizeObserver
global.ResizeObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn(),
}));

// Mock IntersectionObserver
global.IntersectionObserver = jest.fn().mockImplementation(() => ({
  observe: jest.fn(),
  unobserve: jest.fn(),
  disconnect: jest.fn(),
}));

// Mock localStorage
const localStorageMock = {
  getItem: jest.fn(),
  setItem: jest.fn(),
  removeItem: jest.fn(),
  clear: jest.fn(),
};
global.localStorage = localStorageMock;

// Mock sessionStorage
const sessionStorageMock = {
  getItem: jest.fn(),
  setItem: jest.fn(),
  removeItem: jest.fn(),
  clear: jest.fn(),
};
global.sessionStorage = sessionStorageMock;

// Mock fetch
global.fetch = jest.fn();

// Add TextEncoder/Decoder for Node compatibility
global.TextEncoder = TextEncoder;
global.TextDecoder = TextDecoder;

// Mock axios
jest.mock('axios', () => ({
  get: jest.fn(),
  post: jest.fn(),
  put: jest.fn(),
  delete: jest.fn(),
  create: jest.fn(() => ({
    get: jest.fn(),
    post: jest.fn(),
    put: jest.fn(),
    delete: jest.fn(),
  })),
  defaults: {
    headers: {
      common: {},
    },
  },
}));

// Mock Ant Design icons
jest.mock('@ant-design/icons', () => {
  const icons = {};
  const iconList = [
    'MailOutlined',
    'PhoneOutlined',
    'LockOutlined',
    'GoogleOutlined',
    'AppleOutlined',
    // Add more icons as needed
  ];
  
  iconList.forEach(iconName => {
    icons[iconName] = () => <span data-testid={`icon-${iconName}`}>{iconName}</span>;
  });
  
  return icons;
});

// Clear all mocks after each test
afterEach(() => {
  jest.clearAllMocks();
});

// Reset localStorage mocks
beforeEach(() => {
  localStorageMock.getItem.mockClear();
  localStorageMock.setItem.mockClear();
  localStorageMock.removeItem.mockClear();
  localStorageMock.clear.mockClear();
  
  sessionStorageMock.getItem.mockClear();
  sessionStorageMock.setItem.mockClear();
  sessionStorageMock.removeItem.mockClear();
  sessionStorageMock.clear.mockClear();
  
  fetch.mockClear();
});
```

#### **Server Testing Setup**
**File:** `server/tests/setup.js`
```javascript
const mongoose = require('mongoose');
const { MongoMemoryServer } = require('mongodb-memory-server');

let mongoServer;

// Setup before all tests
beforeAll(async () => {
  mongoServer = await MongoMemoryServer.create();
  const mongoUri = mongoServer.getUri();
  
  await mongoose.connect(mongoUri, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  });
});

// Clear database before each test
beforeEach(async () => {
  const collections = mongoose.connection.collections;
  
  for (const key in collections) {
    const collection = collections[key];
    await collection.deleteMany();
  }
});

// Disconnect after all tests
afterAll(async () => {
  await mongoose.disconnect();
  await mongoServer.stop();
});

// Mock environment variables
process.env.JWT_SECRET = 'test-jwt-secret-min-32-characters-long';
process.env.JWT_EXPIRE = '1h';
process.env.NODE_ENV = 'test';
process.env.MONGODB_URI = 'mongodb://localhost:27017/test-db';

// Mock external services
jest.mock('../services/whatsappService', () => ({
  sendMessage: jest.fn().mockResolvedValue({ success: true }),
  processIncomingMessage: jest.fn().mockReturnValue(null),
}));

jest.mock('../services/googleService', () => ({
  verifyGoogleToken: jest.fn().mockResolvedValue({
    providerId: 'google-test-id',
    email: 'test@example.com',
    name: 'Test User',
  }),
}));

jest.mock('axios', () => ({
  post: jest.fn(),
  get: jest.fn(),
  put: jest.fn(),
  delete: jest.fn(),
}));

// Helper functions for tests
global.TestHelpers = {
  createTestUser: async (userData = {}) => {
    const User = require('../models/User');
    return await User.create({
      email: 'test@example.com',
      phone: '+971501234567',
      profile: {
        firstName: 'Test',
        lastName: 'User',
      },
      role: 'client',
      status: 'active',
      ...userData,
    });
  },
  
  createTestProperty: async (propertyData = {}) => {
    const Property = require('../models/Property');
    return await Property.create({
      propertyCode: 'TEST001',
      emirate: 'Dubai',
      specifications: {
        propertyType: 'Apartment',
        bedrooms: 2,
        bathrooms: 2,
        builtUpArea: 1200,
      },
      pricing: {
        amount: 1500000,
        currency: 'AED',
        type: 'sale',
      },
      status: {
        current: 'available',
      },
      ...propertyData,
    });
  },
  
  generateAuthToken: (user) => {
    const jwt = require('jsonwebtoken');
    return jwt.sign(
      {
        userId: user._id,
        email: user.email,
        role: user.role,
      },
      process.env.JWT_SECRET,
      { expiresIn: '1h' }
    );
  },
};
```

### **Step 9.2: Testing Scripts & Commands**
**Update Root `package.json`:**
```json
{
  "scripts": {
    // ... existing scripts ...
    
    "test": "npm run test:server && npm run test:client",
    "test:server": "cd server && npm test -- --coverage --verbose",
    "test:client": "cd client && npm test -- --coverage --verbose",
    "test:watch": "concurrently \"npm run test:server:watch\" \"npm run test:client:watch\"",
    "test:server:watch": "cd server && npm test -- --watch",
    "test:client:watch": "cd client && npm test -- --watch",
    "test:e2e": "cd tests/e2e && npm test",
    "test:integration": "npm run test:server:integration && npm run test:client:integration",
    "test:server:integration": "cd server && npm run test:integration",
    "test:client:integration": "cd client && npm run test:integration",
    "test:coverage": "npm run test:server:coverage && npm run test:client:coverage",
    "test:server:coverage": "cd server && npm test -- --coverage --coverageReporters=text-lcov > coverage.lcov",
    "test:client:coverage": "cd client && npm test -- --coverage --coverageReporters=text-lcov > coverage.lcov",
    "test:ci": "npm run lint && npm run test:coverage && npm run test:e2e",
    "test:security": "npm run audit && npm run snyk:test",
    "test:performance": "npm run lighthouse",
    
    "lint": "npm run lint:server && npm run lint:client",
    "lint:server": "cd server && npx eslint . --ext .js --fix",
    "lint:client": "cd client && npx eslint . --ext .js,.jsx --fix",
    
    "audit": "npm audit --production",
    "snyk:test": "snyk test",
    "lighthouse": "lhci autorun"
  }
}
```

### **Step 9.3: Server Test Examples**

#### **Authentication Tests**
**File:** `server/tests/auth.test.js`
```javascript
const request = require('supertest');
const app = require('../app');
const User = require('../models/User');
const mongoose = require('mongoose');

describe('Authentication API', () => {
  let testUser;
  let authToken;

  beforeEach(async () => {
    // Create test user
    testUser = await User.create({
      email: 'auth-test@example.com',
      phone: '+971501234567',
      localAuth: {
        password: 'Test@1234',
      },
      profile: {
        firstName: 'Auth',
        lastName: 'Test',
      },
      role: 'client',
      status: 'active',
      verificationLevel: 'verified',
    });

    // Generate token
    const jwt = require('jsonwebtoken');
    authToken = jwt.sign(
      {
        userId: testUser._id,
        email: testUser.email,
        role: testUser.role,
      },
      process.env.JWT_SECRET,
      { expiresIn: '1h' }
    );
  });

  describe('POST /api/auth/register/email', () => {
    it('should register a new user with email', async () => {
      const response = await request(app)
        .post('/api/auth/register/email')
        .send({
          email: 'newuser@example.com',
          password: 'Password@123',
          firstName: 'New',
          lastName: 'User',
          phone: '+971501234568',
        })
        .expect(201);

      expect(response.body).toHaveProperty('success', true);
      expect(response.body.user).toHaveProperty('email', 'newuser@example.com');
      expect(response.body.user.profile.firstName).toBe('New');
    });

    it('should reject duplicate email registration', async () => {
      await request(app)
        .post('/api/auth/register/email')
        .send({
          email: 'auth-test@example.com',
          password: 'Password@123',
          firstName: 'Duplicate',
          lastName: 'User',
        })
        .expect(400);
    });

    it('should validate email format', async () => {
      const response = await request(app)
        .post('/api/auth/register/email')
        .send({
          email: 'invalid-email',
          password: 'Password@123',
        })
        .expect(400);

      expect(response.body.message).toContain('valid email');
    });

    it('should validate password strength', async () => {
      const response = await request(app)
        .post('/api/auth/register/email')
        .send({
          email: 'weakpass@example.com',
          password: '123',
        })
        .expect(400);

      expect(response.body.message).toContain('password');
    });
  });

  describe('POST /api/auth/login/email', () => {
    it('should login with valid credentials', async () => {
      const response = await request(app)
        .post('/api/auth/login/email')
        .send({
          email: 'auth-test@example.com',
          password: 'Test@1234',
        })
        .expect(200);

      expect(response.body).toHaveProperty('token');
      expect(response.body).toHaveProperty('user');
      expect(response.body.user.email).toBe('auth-test@example.com');
    });

    it('should reject invalid credentials', async () => {
      await request(app)
        .post('/api/auth/login/email')
        .send({
          email: 'auth-test@example.com',
          password: 'WrongPassword',
        })
        .expect(401);
    });

    it('should handle non-existent user', async () => {
      await request(app)
        .post('/api/auth/login/email')
        .send({
          email: 'nonexistent@example.com',
          password: 'Password@123',
        })
        .expect(401);
    });
  });

  describe('POST /api/auth/login/phone', () => {
    it('should login with valid phone credentials', async () => {
      const response = await request(app)
        .post('/api/auth/login/phone')
        .send({
          phone: '+971501234567',
          password: 'Test@1234',
        })
        .expect(200);

      expect(response.body).toHaveProperty('token');
      expect(response.body.user.phone).toBe('+971501234567');
    });

    it('should validate UAE phone format', async () => {
      await request(app)
        .post('/api/auth/login/phone')
        .send({
          phone: 'invalid-phone',
          password: 'Test@1234',
        })
        .expect(400);
    });
  });

  describe('POST /api/auth/login/google', () => {
    it('should authenticate with Google token', async () => {
      const mockGoogleData = {
        providerId: 'google-123',
        email: 'google-user@example.com',
        name: 'Google User',
      };

      const { verifyGoogleToken } = require('../services/googleService');
      verifyGoogleToken.mockResolvedValue(mockGoogleData);

      const response = await request(app)
        .post('/api/auth/login/google')
        .send({
          token: 'mock-google-token',
        })
        .expect(200);

      expect(response.body).toHaveProperty('token');
      expect(response.body.user.email).toBe('google-user@example.com');
    });

    it('should handle invalid Google token', async () => {
      const { verifyGoogleToken } = require('../services/googleService');
      verifyGoogleToken.mockRejectedValue(new Error('Invalid token'));

      await request(app)
        .post('/api/auth/login/google')
        .send({
          token: 'invalid-token',
        })
        .expect(401);
    });
  });

  describe('GET /api/auth/profile', () => {
    it('should get user profile with valid token', async () => {
      const response = await request(app)
        .get('/api/auth/profile')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('email', 'auth-test@example.com');
      expect(response.body.profile.firstName).toBe('Auth');
    });

    it('should reject request without token', async () => {
      await request(app)
        .get('/api/auth/profile')
        .expect(401);
    });

    it('should reject invalid token', async () => {
      await request(app)
        .get('/api/auth/profile')
        .set('Authorization', 'Bearer invalid-token')
        .expect(401);
    });
  });

  describe('PUT /api/auth/profile', () => {
    it('should update user profile', async () => {
      const updateData = {
        profile: {
          firstName: 'Updated',
          lastName: 'Name',
          preferredLanguage: 'ar',
        },
      };

      const response = await request(app)
        .put('/api/auth/profile')
        .set('Authorization', `Bearer ${authToken}`)
        .send(updateData)
        .expect(200);

      expect(response.body.user.profile.firstName).toBe('Updated');
      expect(response.body.user.profile.preferredLanguage).toBe('ar');
    });

    it('should validate profile data', async () => {
      await request(app)
        .put('/api/auth/profile')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          profile: {
            firstName: '', // Invalid empty name
          },
        })
        .expect(400);
    });
  });

  describe('POST /api/auth/logout', () => {
    it('should logout user and invalidate token', async () => {
      await request(app)
        .post('/api/auth/logout')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      // Try to access protected route with same token
      await request(app)
        .get('/api/auth/profile')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(401);
    });
  });

  describe('POST /api/auth/password/forgot', () => {
    it('should send password reset for valid email', async () => {
      await request(app)
        .post('/api/auth/password/forgot')
        .send({ email: 'auth-test@example.com' })
        .expect(200);
    });

    it('should handle non-existent email gracefully', async () => {
      await request(app)
        .post('/api/auth/password/forgot')
        .send({ email: 'nonexistent@example.com' })
        .expect(200); // Should still return 200 for security
    });
  });

  describe('POST /api/auth/verify/email/send', () => {
    it('should send verification email', async () => {
      await request(app)
        .post('/api/auth/verify/email/send')
        .send({ email: 'auth-test@example.com' })
        .expect(200);
    });
  });

  describe('Rate Limiting', () => {
    it('should rate limit login attempts', async () => {
      const loginAttempts = Array.from({ length: 6 }, (_, i) => 
        request(app)
          .post('/api/auth/login/email')
          .send({
            email: 'auth-test@example.com',
            password: `WrongPassword${i}`,
          })
      );

      const responses = await Promise.all(loginAttempts);
      
      // Last attempt should be rate limited
      expect(responses[5].status).toBe(429);
    });
  });

  afterEach(async () => {
    await User.deleteMany({});
  });
});
```

#### **Property Management Tests**
**File:** `server/tests/property.test.js`
```javascript
const request = require('supertest');
const app = require('../app');
const Property = require('../models/Property');
const User = require('../models/User');

describe('Property Management API', () => {
  let testUser;
  let authToken;
  let testProperty;

  beforeEach(async () => {
    // Create test user
    testUser = await User.create({
      email: 'agent@example.com',
      phone: '+971501234567',
      role: 'agent',
      status: 'active',
      profile: {
        firstName: 'Agent',
        lastName: 'Test',
      },
    });

    // Generate token
    const jwt = require('jsonwebtoken');
    authToken = jwt.sign(
      {
        userId: testUser._id,
        email: testUser.email,
        role: testUser.role,
      },
      process.env.JWT_SECRET,
      { expiresIn: '1h' }
    );

    // Create test property
    testProperty = await Property.create({
      propertyCode: 'TEST001',
      emirate: 'Dubai',
      specifications: {
        propertyType: 'Apartment',
        bedrooms: 2,
        bathrooms: 2,
        builtUpArea: 1200,
      },
      pricing: {
        amount: 1500000,
        currency: 'AED',
        type: 'sale',
      },
      status: {
        current: 'available',
      },
      listedBy: testUser._id,
    });
  });

  describe('GET /api/properties', () => {
    it('should get all properties', async () => {
      const response = await request(app)
        .get('/api/properties')
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.length).toBeGreaterThan(0);
    });

    it('should filter properties by emirate', async () => {
      const response = await request(app)
        .get('/api/properties?emirate=Dubai')
        .expect(200);

      expect(response.body.every(p => p.emirate === 'Dubai')).toBe(true);
    });

    it('should filter properties by type', async () => {
      const response = await request(app)
        .get('/api/properties?type=Apartment')
        .expect(200);

      expect(response.body.every(p => 
        p.specifications.propertyType === 'Apartment'
      )).toBe(true);
    });

    it('should filter properties by price range', async () => {
      const response = await request(app)
        .get('/api/properties?minPrice=1000000&maxPrice=2000000')
        .expect(200);

      expect(response.body.every(p => 
        p.pricing.amount >= 1000000 && p.pricing.amount <= 2000000
      )).toBe(true);
    });

    it('should paginate results', async () => {
      // Create more properties for pagination
      for (let i = 0; i < 15; i++) {
        await Property.create({
          propertyCode: `PAGETEST${i}`,
          emirate: 'Dubai',
          specifications: { propertyType: 'Apartment' },
          pricing: { amount: 1000000, currency: 'AED', type: 'sale' },
          status: { current: 'available' },
        });
      }

      const response = await request(app)
        .get('/api/properties?page=2&limit=10')
        .expect(200);

      expect(response.body.length).toBeLessThanOrEqual(10);
    });
  });

  describe('GET /api/properties/:id', () => {
    it('should get property by ID', async () => {
      const response = await request(app)
        .get(`/api/properties/${testProperty._id}`)
        .expect(200);

      expect(response.body).toHaveProperty('propertyCode', 'TEST001');
      expect(response.body.emirate).toBe('Dubai');
    });

    it('should return 404 for non-existent property', async () => {
      const fakeId = new require('mongoose').Types.ObjectId();
      await request(app)
        .get(`/api/properties/${fakeId}`)
        .expect(404);
    });

    it('should increment view count', async () => {
      const initialViews = testProperty.views || 0;
      
      await request(app)
        .get(`/api/properties/${testProperty._id}`)
        .expect(200);

      const updatedProperty = await Property.findById(testProperty._id);
      expect(updatedProperty.views).toBe(initialViews + 1);
    });
  });

  describe('POST /api/properties', () => {
    it('should create new property with valid data', async () => {
      const newProperty = {
        propertyCode: 'NEW001',
        emirate: 'Abu Dhabi',
        specifications: {
          propertyType: 'Villa',
          bedrooms: 4,
          bathrooms: 3,
          builtUpArea: 3000,
          plotArea: 5000,
        },
        pricing: {
          amount: 3500000,
          currency: 'AED',
          type: 'sale',
        },
        legalDetails: {
          dldNumber: 'DLD12345',
          titleDeed: 'TD67890',
        },
      };

      const response = await request(app)
        .post('/api/properties')
        .set('Authorization', `Bearer ${authToken}`)
        .send(newProperty)
        .expect(201);

      expect(response.body).toHaveProperty('propertyCode', 'NEW001');
      expect(response.body.emirate).toBe('Abu Dhabi');
      expect(response.body.listedBy).toBe(testUser._id.toString());
    });

    it('should validate required fields', async () => {
      await request(app)
        .post('/api/properties')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          // Missing required fields
          propertyCode: 'INVALID',
        })
        .expect(400);
    });

    it('should enforce unique property code', async () => {
      await request(app)
        .post('/api/properties')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          propertyCode: 'TEST001', // Already exists
          emirate: 'Dubai',
          specifications: { propertyType: 'Apartment' },
          pricing: { amount: 1000000, currency: 'AED', type: 'sale' },
        })
        .expect(400);
    });

    it('should validate emirate enum', async () => {
      await request(app)
        .post('/api/properties')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          propertyCode: 'ENUMTEST',
          emirate: 'InvalidEmirate',
          specifications: { propertyType: 'Apartment' },
          pricing: { amount: 1000000, currency: 'AED', type: 'sale' },
        })
        .expect(400);
    });
  });

  describe('PUT /api/properties/:id', () => {
    it('should update property', async () => {
      const updateData = {
        pricing: {
          amount: 1600000,
        },
        specifications: {
          bedrooms: 3,
        },
        status: {
          current: 'reserved',
          notes: 'Property reserved for viewing',
        },
      };

      const response = await request(app)
        .put(`/api/properties/${testProperty._id}`)
        .set('Authorization', `Bearer ${authToken}`)
        .send(updateData)
        .expect(200);

      expect(response.body.pricing.amount).toBe(1600000);
      expect(response.body.specifications.bedrooms).toBe(3);
      expect(response.body.status.current).toBe('reserved');
      expect(response.body.status.history).toHaveLength(1);
    });

    it('should prevent unauthorized updates', async () => {
      const otherUser = await User.create({
        email: 'other@example.com',
        role: 'client',
      });

      const otherToken = jwt.sign(
        {
          userId: otherUser._id,
          role: otherUser.role,
        },
        process.env.JWT_SECRET,
        { expiresIn: '1h' }
      );

      await request(app)
        .put(`/api/properties/${testProperty._id}`)
        .set('Authorization', `Bearer ${otherToken}`)
        .send({ pricing: { amount: 1 } })
        .expect(403);
    });
  });

  describe('DELETE /api/properties/:id', () => {
    it('should delete property', async () => {
      await request(app)
        .delete(`/api/properties/${testProperty._id}`)
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      const deletedProperty = await Property.findById(testProperty._id);
      expect(deletedProperty).toBeNull();
    });

    it('should soft delete property (change status)', async () => {
      const response = await request(app)
        .delete(`/api/properties/${testProperty._id}`)
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body.status.current).toBe('off_market');
    });
  });

  describe('GET /api/properties/search/advanced', () => {
    it('should perform advanced search', async () => {
      // Create properties with different attributes
      await Property.create([
        {
          propertyCode: 'SEARCH1',
          emirate: 'Dubai',
          specifications: {
            propertyType: 'Apartment',
            bedrooms: 1,
            bathrooms: 1,
            builtUpArea: 800,
          },
          pricing: {
            amount: 800000,
            currency: 'AED',
            type: 'sale',
          },
          status: { current: 'available' },
        },
        {
          propertyCode: 'SEARCH2',
          emirate: 'Abu Dhabi',
          specifications: {
            propertyType: 'Villa',
            bedrooms: 5,
            bathrooms: 4,
            builtUpArea: 4000,
            plotArea: 8000,
          },
          pricing: {
            amount: 5000000,
            currency: 'AED',
            type: 'sale',
          },
          status: { current: 'available' },
        },
      ]);

      const searchCriteria = {
        emirates: ['Dubai', 'Abu Dhabi'],
        propertyTypes: ['Apartment', 'Villa'],
        minBedrooms: 3,
        maxPrice: 6000000,
      };

      const response = await request(app)
        .post('/api/properties/search/advanced')
        .send(searchCriteria)
        .expect(200);

      expect(response.body.length).toBeGreaterThan(0);
      expect(response.body.every(p => 
        searchCriteria.emirates.includes(p.emirate) &&
        p.specifications.bedrooms >= searchCriteria.minBedrooms &&
        p.pricing.amount <= searchCriteria.maxPrice
      )).toBe(true);
    });
  });

  afterEach(async () => {
    await Property.deleteMany({});
    await User.deleteMany({});
  });
});
```

### **Step 9.4: Client Test Examples**

#### **Authentication Component Tests**
**File:** `client/src/components/auth/__tests__/Login.test.js`
```javascript
import React from 'react';
import { render, screen, fireEvent, waitFor, act } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import { message } from 'antd';
import Login from '../Login';
import { AuthProvider } from '../../../contexts/AuthContext';
import axios from 'axios';

// Mock dependencies
jest.mock('antd', () => ({
  ...jest.requireActual('antd'),
  message: {
    success: jest.fn(),
    error: jest.fn(),
    info: jest.fn(),
  },
}));

jest.mock('axios');
jest.mock('../../../contexts/AuthContext', () => ({
  AuthProvider: ({ children }) => children,
  useAuth: () => ({
    login: jest.fn(),
    user: null,
    loading: false,
    authMethods: [],
    twoFactorRequired: false,
    verifyTwoFactor: jest.fn(),
    sendVerificationCode: jest.fn(),
  }),
  useGoogleAuth: () => ({ googleLogin: jest.fn() }),
  useAppleAuth: () => ({ appleLogin: jest.fn() }),
}));

jest.mock('react-router-dom', () => ({
  ...jest.requireActual('react-router-dom'),
  useNavigate: () => jest.fn(),
  useLocation: () => ({ state: null }),
  useSearchParams: () => [new URLSearchParams(), jest.fn()],
  Link: ({ children, ...props }) => <a {...props}>{children}</a>,
}));

describe('Login Component', () => {
  const mockLogin = jest.fn();
  const mockNavigate = jest.fn();

  beforeEach(() => {
    jest.clearAllMocks();
    // Reset mocks
    require('../../../contexts/AuthContext').useAuth.mockReturnValue({
      login: mockLogin,
      user: null,
      loading: false,
      authMethods: [],
      twoFactorRequired: false,
      verifyTwoFactor: jest.fn(),
      sendVerificationCode: jest.fn(),
    });

    require('react-router-dom').useNavigate.mockReturnValue(mockNavigate);
  });

  const renderLogin = () => {
    return render(
      <BrowserRouter>
        <AuthProvider>
          <Login />
        </AuthProvider>
      </BrowserRouter>
    );
  };

  it('renders login form correctly', () => {
    renderLogin();
    
    expect(screen.getByText('Welcome Back')).toBeInTheDocument();
    expect(screen.getByText('Sign in to your White Caves Real Estate account')).toBeInTheDocument();
    
    // Check for social login buttons
    expect(screen.getByText('Continue with Google')).toBeInTheDocument();
    expect(screen.getByText('Continue with Apple')).toBeInTheDocument();
    
    // Check for email tab
    expect(screen.getByLabelText('Email Address')).toBeInTheDocument();
    expect(screen.getByLabelText('Password')).toBeInTheDocument();
  });

  it('switches between email and phone tabs', () => {
    renderLogin();
    
    // Initially email tab is active
    expect(screen.getByLabelText('Email Address')).toBeInTheDocument();
    
    // Click phone tab
    fireEvent.click(screen.getByText('Phone'));
    
    // Now phone input should be visible
    expect(screen.getByPlaceholderText('Enter UAE phone number')).toBeInTheDocument();
  });

  it('handles email login form submission', async () => {
    mockLogin.mockResolvedValue({ success: true });
    
    renderLogin();
    
    // Fill form
    fireEvent.change(screen.getByLabelText('Email Address'), {
      target: { value: 'test@example.com' },
    });
    
    fireEvent.change(screen.getByLabelText('Password'), {
      target: { value: 'Password@123' },
    });
    
    // Submit form
    fireEvent.click(screen.getByText('Sign In with Email'));
    
    await waitFor(() => {
      expect(mockLogin).toHaveBeenCalledWith(
        {
          email: 'test@example.com',
          password: 'Password@123',
          rememberMe: true,
        },
        'email'
      );
    });
  });

  it('handles login errors', async () => {
    const errorMessage = 'Invalid credentials';
    mockLogin.mockRejectedValue({
      response: { data: { message: errorMessage } },
    });
    
    renderLogin();
    
    // Fill form
    fireEvent.change(screen.getByLabelText('Email Address'), {
      target: { value: 'test@example.com' },
    });
    
    fireEvent.change(screen.getByLabelText('Password'), {
      target: { value: 'WrongPassword' },
    });
    
    // Submit form
    fireEvent.click(screen.getByText('Sign In with Email'));
    
    await waitFor(() => {
      expect(message.error).toHaveBeenCalledWith(errorMessage);
    });
  });

  it('handles social login buttons', () => {
    const { useGoogleAuth, useAppleAuth } = require('../../../contexts/AuthContext');
    const mockGoogleLogin = jest.fn();
    const mockAppleLogin = jest.fn();
    
    useGoogleAuth.mockReturnValue({ googleLogin: mockGoogleLogin });
    useAppleAuth.mockReturnValue({ appleLogin: mockAppleLogin });
# **WHITE CAVES REAL ESTATE - COMPLETE IMPLEMENTATION GUIDE**

## **ðŸ“‹ PROJECT OVERVIEW**
**Project:** White Caves Real Estate LLC Web Application  
**Tech Stack:** MERN (MongoDB, Express, React, Node.js)  
**Location:** Dubai, UAE  
**Special Features:** AI Chatbot, WhatsApp Integration, Multi-language Support

---

## **âœ… PHASE-BY-PHASE IMPLEMENTATION GUIDE**

### **ðŸ“ PHASE 1: PROJECT SETUP & ENVIRONMENT**
**Estimated Time:** 1-2 hours

#### **Step 1.1: Create Project Structure**
```bash
# Create main project folder
mkdir white-caves-realestate
cd white-caves-realestate

# Create folder structure
mkdir client server shared scripts tests
mkdir client/public client/src client/src/components client/src/styles
mkdir server/models server/routes server/controllers server/middleware server/services

# Initialize git
git init
```

#### **Step 1.2: Set Up Environment Files**
1. Create `.env.template` in root directory
2. Create `.gitignore` in root directory
3. Create `client/.env.production.local`
4. Create `server/.env`

**Critical:**
- Update MongoDB connection string
- Add JWT secret (min 32 characters)
- Configure WhatsApp API credentials
- Add Google OAuth credentials

#### **Step 1.3: Initialize Package Files**
1. Create root `package.json`
2. Create `client/package.json`
3. Create `server/package.json`

**Installation Command:**
```bash
# Run this in project root
npm run setup
```

---

### **ðŸ“ PHASE 2: DATABASE & CORE SCHEMAS**
**Estimated Time:** 2-3 hours

#### **Step 2.1: Set Up MongoDB**
1. Create MongoDB Atlas account
2. Create database: `whitecaves_realestate`
3. Add connection string to `.env`
4. Implement connection in `server/db.js`

#### **Step 2.2: Create Core Models**
Create these files in `server/models/`:

1. **`Property.js`** - Real estate properties schema
2. **`User.js`** - Multi-strategy authentication schema
3. **`Contract.js`** - Tenancy contract workflow
4. **`Agent.js`** - Real estate agent profiles
5. **`Lead.js`** - Customer leads management

#### **Step 2.3: Implement Bilingual System**
1. Create `client/src/utils/languageConfig.js`
2. Create `client/src/utils/i18n.js`
3. Add language toggle component

---

### **ðŸ“ PHASE 3: BACKEND API DEVELOPMENT**
**Estimated Time:** 4-6 hours

#### **Step 3.1: Set Up Express Server**
1. Create `server/app.js`
2. Configure middleware (CORS, body-parser, helmet)
3. Set up error handling middleware
4. Configure static file serving

#### **Step 3.2: Create API Routes**
Create these routes in `server/routes/`:

1. **`auth.routes.js`** - Authentication endpoints
2. **`property.routes.js`** - Property CRUD operations
3. **`agent.routes.js`** - Agent management
4. **`dashboard.routes.js`** - Analytics endpoints
5. **`chatbot.routes.js`** - AI chatbot API
6. **`whatsapp.routes.js`** - WhatsApp webhooks

#### **Step 3.3: Implement Controllers**
Create corresponding controllers in `server/controllers/`

---

### **ðŸ“ PHASE 4: FRONTEND DEVELOPMENT**
**Estimated Time:** 6-8 hours

#### **Step 4.1: React Application Setup**
```bash
cd client
npx create-react-app .
```

#### **Step 4.2: Install Dependencies**
```bash
# Core dependencies
npm install axios react-router-dom @reduxjs/toolkit react-redux

# UI Components
npm install antd @ant-design/icons styled-components

# Utilities
npm install moment react-phone-number-input

# Authentication
npm install @react-oauth/google jwt-decode
```

#### **Step 4.3: Create Core Components**
1. **`App.js`** - Main application component
2. **`AuthContext.js`** - Authentication context
3. **`ThemeProvider.js`** - Theme management
4. **`LanguageProvider.js`** - Language management

#### **Step 4.4: Create Layout Components**
1. **`Layout.js`** - Main layout wrapper
2. **`Header.js`** - Navigation header
3. **`Sidebar.js`** - Navigation sidebar
4. **`Footer.js`** - Page footer

---

### **ðŸ“ PHASE 5: AUTHENTICATION SYSTEM**
**Estimated Time:** 3-4 hours

#### **Step 5.1: Implement Multi-Strategy Auth**
1. Complete `User.js` schema with all auth methods
2. Implement `authService.js` with:
   - JWT token generation/verification
   - Google OAuth integration
   - Phone verification
   - 2FA setup

#### **Step 5.2: Create Auth Components**
1. **`Login.js`** - Multi-method login page
2. **`Signup.js`** - Registration with validation
3. **`ForgotPassword.js`** - Password reset flow
4. **`VerifyAccount.js`** - Email/phone verification

#### **Step 5.3: Implement Protected Routes**
1. Create `PrivateRoute.js` component
2. Implement role-based access control
3. Add session management

---

### **ðŸ“ PHASE 6: PROPERTY MANAGEMENT**
**Estimated Time:** 4-5 hours

#### **Step 6.1: Property Listing Components**
1. **`PropertyList.js`** - Grid/list view of properties
2. **`PropertyCard.js`** - Individual property card
3. **`PropertyFilters.js`** - Advanced filtering
4. **`PropertySearch.js`** - Search functionality

#### **Step 6.2: Property Details**
1. **`PropertyDetail.js`** - Full property view
2. **`ImageGallery.js`** - Property images
3. **`ContactAgent.js`** - Agent contact form
4. **`ScheduleViewing.js`** - Viewing scheduler

#### **Step 6.3: Admin Property Management**
1. **`AddProperty.js`** - Add new property form
2. **`EditProperty.js`** - Edit existing property
3. **`PropertyStatus.js`** - Status management

---

### **ðŸ“ PHASE 7: AI & AUTOMATION FEATURES**
**Estimated Time:** 3-4 hours

#### **Step 7.1: AI Chatbot Implementation**
1. Create `ChatbotService.js` with NLP processing
2. Implement `Chatbot.js` React component
3. Add training data in `chatbotTraining.js`

#### **Step 7.2: WhatsApp Integration**
1. Set up Meta Business account
2. Implement `whatsappService.js`
3. Create webhook handlers
4. Build WhatsApp chat interface

#### **Step 7.3: Agent Assignment Engine**
1. Complete `agentAssignment.js`
2. Implement scoring algorithm
3. Create agent recommendation system

---

### **ðŸ“ PHASE 8: DASHBOARD & ANALYTICS**
**Estimated Time:** 3-4 hours

#### **Step 8.1: Dashboard Components**
1. **`AdminDashboard.js`** - Super admin view
2. **`OwnerDashboard.js`** - Company owner view
3. **`AgentDashboard.js`** - Agent performance view
4. **`ClientDashboard.js`** - Client portal

#### **Step 8.2: Analytics Implementation**
1. Create analytics service
2. Implement real-time charts
3. Add export functionality
4. Set up notifications

---

### **ðŸ“ PHASE 9: STYLING & THEMING**
**Estimated Time:** 2-3 hours

#### **Step 9.1: Global Styles**
1. Create `global.css` with RTL support
2. Implement theme configuration
3. Add responsive design

#### **Step 9.2: Component Styling**
1. Style all components consistently
2. Add animations and transitions
3. Ensure accessibility compliance

---

### **ðŸ“ PHASE 10: TESTING & QUALITY ASSURANCE**
**Estimated Time:** 3-4 hours

#### **Step 10.1: Set Up Testing Environment**
```bash
# Install testing dependencies
npm install --save-dev jest @testing-library/react @testing-library/jest-dom

# Configure Jest
npx jest --init
```

#### **Step 10.2: Write Unit Tests**
1. Test all utility functions
2. Test React components
3. Test API endpoints
4. Test database models

#### **Step 10.3: Integration Testing**
1. Test user authentication flow
2. Test property CRUD operations
3. Test WhatsApp integration
4. Test AI chatbot responses

---

### **ðŸ“ PHASE 11: DEPLOYMENT**
**Estimated Time:** 1-2 hours

#### **Step 11.1: Vercel Deployment**
1. Connect GitHub repository to Vercel
2. Configure environment variables
3. Set up custom domain
4. Configure build settings

#### **Step 11.2: Production Configuration**
1. Enable SSL/TLS
2. Configure CORS
3. Set up CDN
4. Implement caching

---

## **ðŸš€ ADVANCED FEATURES IMPLEMENTATION**

### **âœ¨ Feature 1: Real-time Notifications**
**Implementation Steps:**

1. **Set up WebSocket Server:**
```javascript
// server/services/socketService.js
const WebSocket = require('ws');
const wss = new WebSocket.Server({ port: 8080 });

wss.on('connection', (ws) => {
  ws.on('message', (message) => {
    // Handle real-time messages
  });
});
```

2. **Create Notification Service:**
```javascript
// server/services/notificationService.js
class NotificationService {
  async sendNotification(userId, type, data) {
    // Send push notifications
    // Send email notifications
    // Send WhatsApp messages
  }
}
```

3. **React Notification Component:**
```javascript
// client/src/components/notifications/NotificationBell.js
import React, { useState, useEffect } from 'react';
import { Badge, Dropdown, List } from 'antd';
import { BellOutlined } from '@ant-design/icons';

const NotificationBell = () => {
  const [notifications, setNotifications] = useState([]);
  
  // Connect to WebSocket
  useEffect(() => {
    const ws = new WebSocket('ws://localhost:8080');
    
    ws.onmessage = (event) => {
      const notification = JSON.parse(event.data);
      setNotifications(prev => [notification, ...prev]);
    };
  }, []);
  
  return (
    <Dropdown overlay={notificationList} trigger={['click']}>
      <Badge count={notifications.length}>
        <BellOutlined style={{ fontSize: '20px' }} />
      </Badge>
    </Dropdown>
  );
};
```

### **âœ¨ Feature 2: Advanced Search with ElasticSearch**
**Implementation Steps:**

1. **Set up ElasticSearch:**
```bash
# Install ElasticSearch
docker run -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" docker.elastic.co/elasticsearch/elasticsearch:7.17.0
```

2. **Create Search Service:**
```javascript
// server/services/searchService.js
const { Client } = require('@elastic/elasticsearch');

class SearchService {
  constructor() {
    this.client = new Client({ node: 'http://localhost:9200' });
  }
  
  async indexProperty(property) {
    await this.client.index({
      index: 'properties',
      id: property._id.toString(),
      body: property
    });
  }
  
  async searchProperties(query, filters) {
    const result = await this.client.search({
      index: 'properties',
      body: {
        query: {
          bool: {
            must: [
              {
                multi_match: {
                  query: query,
                  fields: ['title^3', 'description', 'location']
                }
              }
            ],
            filter: this.buildFilters(filters)
          }
        }
      }
    });
    
    return result.hits.hits;
  }
}
```

### **âœ¨ Feature 3: AI-Powered Property Valuation**
**Implementation Steps:**

1. **Collect Training Data:**
```javascript
// server/services/valuationService.js
class ValuationService {
  async trainModel() {
    // Collect historical property data
    // Include: location, size, amenities, market trends
    // Train ML model (TensorFlow.js or external API)
  }
  
  async estimateValue(property) {
    // Use trained model to estimate value
    // Consider market conditions
    // Provide confidence score
  }
}
```

2. **Integration with Property Forms:**
```javascript
// client/src/components/properties/AddProperty.js
const AddProperty = () => {
  const [estimatedValue, setEstimatedValue] = useState(null);
  
  const calculateEstimate = async (propertyData) => {
    const response = await axios.post('/api/valuation/estimate', propertyData);
    setEstimatedValue(response.data);
  };
  
  return (
    <Form onValuesChange={calculateEstimate}>
      {/* Form fields */}
      {estimatedValue && (
        <Alert
          message={`Estimated Value: AED ${estimatedValue.value.toLocaleString()}`}
          description={`Confidence: ${estimatedValue.confidence}%`}
          type="info"
        />
      )}
    </Form>
  );
};
```

### **âœ¨ Feature 4: Virtual Property Tours**
**Implementation Steps:**

1. **Integrate 360Â° Tour Service:**
```javascript
// client/src/components/properties/VirtualTour.js
import React, { useRef, useEffect } from 'react';
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';

const VirtualTour = ({ images }) => {
  const mountRef = useRef(null);
  
  useEffect(() => {
    // Three.js setup for virtual tour
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    
    // Load 360 images
    const texture = new THREE.TextureLoader().load(images[0]);
    const sphere = new THREE.Mesh(
      new THREE.SphereGeometry(500, 60, 40),
      new THREE.MeshBasicMaterial({ map: texture })
    );
    
    scene.add(sphere);
    
    // Add controls
    const controls = new OrbitControls(camera, renderer.domElement);
    
    // Animation loop
    const animate = () => {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    };
    
    animate();
    
    return () => {
      // Cleanup
    };
  }, [images]);
  
  return <div ref={mountRef} style={{ width: '100%', height: '500px' }} />;
};
```

---

## **ðŸ”§ ERROR PREVENTION & CODE QUALITY**

### **âœ… Step 1: ESLint & Prettier Configuration**
**File:** `.eslintrc.json`
```json
{
  "env": {
    "browser": true,
    "es2021": true,
    "node": true
  },
  "extends": [
    "eslint:recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended"
  ],
  "parserOptions": {
    "ecmaFeatures": {
      "jsx": true
    },
    "ecmaVersion": "latest",
    "sourceType": "module"
  },
  "plugins": ["react", "react-hooks"],
  "rules": {
    "react/prop-types": "off",
    "react/react-in-jsx-scope": "off",
    "no-unused-vars": "warn",
    "no-console": "warn",
    "react-hooks/rules-of-hooks": "error",
    "react-hooks/exhaustive-deps": "warn"
  },
  "settings": {
    "react": {
      "version": "detect"
    }
  }
}
```

**File:** `.prettierrc`
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false
}
```

### **âœ… Step 2: TypeScript Migration (Optional but Recommended)**
1. **Install TypeScript:**
```bash
cd client
npm install --save typescript @types/node @types/react @types/react-dom
```

2. **Create `tsconfig.json`:**
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noFallthroughCasesInSwitch": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx"
  },
  "include": ["src"]
}
```

### **âœ… Step 3: Error Boundary Implementation**
**File:** `client/src/components/ErrorBoundary.js`
```javascript
import React from 'react';

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null, errorInfo: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    this.setState({
      error: error,
      errorInfo: errorInfo
    });
    
    // Log error to monitoring service
    console.error('Error caught by boundary:', error, errorInfo);
    
    // Send to error tracking service
    if (process.env.NODE_ENV === 'production') {
      // Send to Sentry/LogRocket/etc.
    }
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="error-boundary">
          <h2>Something went wrong.</h2>
          <details style={{ whiteSpace: 'pre-wrap' }}>
            {this.state.error && this.state.error.toString()}
            <br />
            {this.state.errorInfo && this.state.errorInfo.componentStack}
          </details>
          <button onClick={() => window.location.reload()}>
            Reload Page
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;
```

### **âœ… Step 4: Centralized Error Handling**
**File:** `client/src/utils/errorHandler.js`
```javascript
class ErrorHandler {
  static handleAPIError(error) {
    if (error.response) {
      // Server responded with error
      switch (error.response.status) {
        case 400:
          return 'Invalid request. Please check your input.';
        case 401:
          return 'Session expired. Please login again.';
        case 403:
          return 'You do not have permission for this action.';
        case 404:
          return 'Resource not found.';
        case 500:
          return 'Server error. Please try again later.';
        default:
          return error.response.data?.message || 'An error occurred.';
      }
    } else if (error.request) {
      // Request made but no response
      return 'Network error. Please check your connection.';
    } else {
      // Error setting up request
      return 'An unexpected error occurred.';
    }
  }

  static logError(error, context = {}) {
    const errorLog = {
      timestamp: new Date().toISOString(),
      error: error.toString(),
      stack: error.stack,
      context: context,
      userAgent: navigator.userAgent,
      url: window.location.href
    };

    // Log to console in development
    if (process.env.NODE_ENV === 'development') {
      console.error('Error logged:', errorLog);
    }

    // Send to error tracking service in production
    if (process.env.NODE_ENV === 'production') {
      this.sendToMonitoringService(errorLog);
    }
  }

  static sendToMonitoringService(errorLog) {
    // Implementation for Sentry/LogRocket/etc.
    // Example with Sentry:
    // Sentry.captureException(new Error(errorLog.error), {
    //   extra: errorLog.context
    // });
  }
}

export default ErrorHandler;
```

### **âœ… Step 5: Input Validation & Sanitization**
**File:** `server/utils/validator.js`
```javascript
const validator = require('validator');
const { body, validationResult } = require('express-validator');

const validateProperty = [
  body('propertyCode')
    .notEmpty().withMessage('Property code is required')
    .isLength({ min: 3, max: 20 }).withMessage('Property code must be 3-20 characters')
    .matches(/^[A-Z0-9-]+$/).withMessage('Property code can only contain uppercase letters, numbers, and hyphens'),
  
  body('pricing.amount')
    .isFloat({ min: 0 }).withMessage('Price must be a positive number'),
  
  body('specifications.bedrooms')
    .optional()
    .isInt({ min: 0, max: 50 }).withMessage('Bedrooms must be between 0 and 50'),
  
  body('email')
    .optional()
    .isEmail().withMessage('Invalid email address')
    .normalizeEmail(),
  
  body('phone')
    .optional()
    .custom((value) => {
      if (!validator.isMobilePhone(value, 'any')) {
        throw new Error('Invalid phone number');
      }
      return true;
    }),
  
  body('description')
    .optional()
    .trim()
    .escape(), // Prevent XSS
  
  (req, res, next) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    next();
  }
];

module.exports = { validateProperty };
```

### **âœ… Step 6: Database Index Optimization**
**File:** `server/models/Property.js` (Add indexes)
```javascript
// Add these indexes for performance
PropertySchema.index({ propertyCode: 1 }, { unique: true });
PropertySchema.index({ emirate: 1, 'status.current': 1 });
PropertySchema.index({ 'pricing.amount': 1, 'pricing.type': 1 });
PropertySchema.index({ 
  'specifications.propertyType': 1,
  'specifications.bedrooms': 1,
  'specifications.bathrooms': 1 
});
PropertySchema.index({ createdAt: -1 }); // For recent properties
PropertySchema.index({ location: '2dsphere' }); // For geospatial queries
```

### **âœ… Step 7: Performance Optimization**
**File:** `client/src/utils/performance.js`
```javascript
// Lazy loading components
const PropertyList = React.lazy(() => import('../components/properties/PropertyList'));
const Dashboard = React.lazy(() => import('../components/dashboard/Dashboard'));

// Image optimization
const optimizedImage = (url, width = 800) => {
  if (url.includes('cloudinary')) {
    return url.replace('/upload/', `/upload/w_${width},q_auto,f_auto/`);
  }
  return url;
};

// Debounce for search
const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};
```

### **âœ… Step 8: Security Audit Checklist**
```javascript
// File: scripts/security-audit.js
const securityChecks = {
  envVariables: [
    'JWT_SECRET', // Should be 32+ chars
    'MONGODB_URI', // Should have proper auth
    'WHATSAPP_API_KEY', // Should be encrypted
  ],
  
  headers: [
    'X-Frame-Options: DENY',
    'X-Content-Type-Options: nosniff',
    'X-XSS-Protection: 1; mode=block',
    'Strict-Transport-Security: max-age=31536000; includeSubDomains',
  ],
  
  dependencies: {
    audit: 'npm audit',
    outdated: 'npm outdated',
    vulnerabilities: 'npx snyk test'
  }
};
```

---

## **ðŸš¨ COMMON ERRORS & SOLUTIONS**

### **Error 1: MongoDB Connection Failed**
**Symptoms:** `MongooseServerSelectionError: connect ECONNREFUSED`
**Solution:**
```javascript
// server/db.js
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      serverSelectionTimeoutMS: 5000, // Timeout after 5s
      socketTimeoutMS: 45000, // Close sockets after 45s
    });
    console.log('MongoDB connected successfully');
  } catch (error) {
    console.error('MongoDB connection error:', error);
    // Retry logic
    setTimeout(connectDB, 5000);
  }
};

mongoose.connection.on('error', err => {
  console.error('MongoDB connection error:', err);
});

mongoose.connection.on('disconnected', () => {
  console.log('MongoDB disconnected');
});

module.exports = connectDB;
```

### **Error 2: CORS Issues**
**Symptoms:** `Access-Control-Allow-Origin` errors
**Solution:**
```javascript
// server/app.js
const cors = require('cors');

const corsOptions = {
  origin: process.env.NODE_ENV === 'production' 
    ? ['https://whitecaves.com', 'https://www.whitecaves.com']
    : 'http://localhost:3000',
  credentials: true,
  optionsSuccessStatus: 200
};

app.use(cors(corsOptions));
```

### **Error 3: JWT Token Expired**
**Solution: Implement token refresh**
```javascript
// client/src/services/authService.js
const refreshToken = async () => {
  try {
    const response = await axios.post('/api/auth/refresh', {}, {
      withCredentials: true
    });
    
    localStorage.setItem('auth_token', response.data.token);
    axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`;
    
    return response.data.token;
  } catch (error) {
    // Redirect to login if refresh fails
    window.location.href = '/login';
  }
};

// Axios interceptor for token refresh
axios.interceptors.response.use(
  response => response,
  async error => {
    const originalRequest = error.config;
    
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      
      const newToken = await refreshToken();
      originalRequest.headers['Authorization'] = `Bearer ${newToken}`;
      
      return axios(originalRequest);
    }
    
    return Promise.reject(error);
  }
);
```

### **Error 4: React State Update on Unmounted Component**
**Solution: Use cleanup function**
```javascript
useEffect(() => {
  let isMounted = true;
  
  const fetchData = async () => {
    try {
      const data = await api.fetchProperties();
      if (isMounted) {
        setProperties(data);
      }
    } catch (error) {
      if (isMounted) {
        setError(error.message);
      }
    }
  };
  
  fetchData();
  
  return () => {
    isMounted = false;
  };
}, []);
```

### **Error 5: Memory Leaks in useEffect**
**Solution: Clean up event listeners and intervals**
```javascript
useEffect(() => {
  const handleResize = () => {
    setWindowSize({
      width: window.innerWidth,
      height: window.innerHeight
    });
  };
  
  window.addEventListener('resize', handleResize);
  
  const interval = setInterval(() => {
    // Periodic updates
  }, 30000);
  
  // Cleanup
  return () => {
    window.removeEventListener('resize', handleResize);
    clearInterval(interval);
  };
}, []);
```

---

## **ðŸ“Š DEPLOYMENT CHECKLIST**

### **Pre-Deployment:**
- [ ] All tests passing (`npm test`)
- [ ] Linting clean (`npm run lint`)
- [ ] Security audit clean (`npm audit`)
- [ ] Environment variables configured
- [ ] Build successful (`npm run build`)
- [ ] No console errors in development

### **Post-Deployment:**
- [ ] SSL certificate active
- [ ] DNS propagation complete
- [ ] Database backups configured
- [ ] Monitoring alerts set up
- [ ] Error tracking integrated

---

## **ðŸ” DEBUGGING COMMANDS**

```bash
# Check for dependency vulnerabilities
npm audit
npx snyk test

# Check for outdated packages
npm outdated

# Run linter
npm run lint

# Run tests with coverage
npm test -- --coverage

# Check bundle size
cd client
npx source-map-explorer build/static/js/*.js

# Performance audit
npx lighthouse https://whitecaves.com --view
```

---

## **ðŸ“ˆ MONITORING & MAINTENANCE**

### **Weekly Tasks:**
1. Check server logs for errors
2. Monitor database performance
3. Review user feedback
4. Update dependencies
5. Backup database

### **Monthly Tasks:**
1. Security audit
2. Performance optimization
3. Update documentation
4. Review analytics
5. Plan new features

---

## **ðŸŽ¯ SUCCESS METRICS**

- **Performance:** Page load < 3s
- **Uptime:** 99.9% availability
- **Errors:** < 0.1% error rate
- **User Satisfaction:** > 4.5/5 rating
- **Conversion Rate:** > 5% lead conversion

---
Here is a logical, step-by-step implementation guide for your White Caves Real Estate MERN application, integrating UAE Pass and incorporating software engineering best practices.

### **Comprehensive Implementation Guide**

**1. Project Foundation & Environment**
    1.  Create the project structure (`mkdir client server ...`).
    2.  Set up critical environment files:
        *   `.env.template` (root): Template with all necessary keys (MongoDB, JWT, API keys).
        *   `.gitignore` (root): Exclude `.env`, `node_modules`, build artifacts.
        *   `.env.production.local` (client): Production API URLs for Vercel.
    3.  Configure the root `package.json` with scripts for development (`dev`), building (`build`), testing, and deployment.

**2. Core Database & Business Logic**
    1.  Implement the **Property Schema** (`server/models/Property.js`) with UAE-specific fields (DLD, Ejari, DEWA numbers), pricing, status tracking, and performance indexes.
    2.  Implement the comprehensive **User Schema** (`server/models/User.js`) supporting multiple auth strategies (local, Google, UAE Pass) and granular roles.
    3.  Create supporting schemas: `Contract.js` for tenancy workflow and `Agent.js`.
    4.  Implement the bilingual system (`client/src/utils/languageConfig.js`) with RTL support for Arabic.

**3. Backend API & Service Layer**
    1.  Set up the Express server (`server/app.js`) with middleware (CORS, security, body-parser).
    2.  Create route files for all modules: `auth.routes.js`, `property.routes.js`, `agent.routes.js`, `dashboard.routes.js`.
    3.  Implement corresponding controller logic for each route.
    4.  Build core services: `agentAssignment.js` (AI scoring), `whatsappService.js`, and `chatbotService.js`.

**4. Frontend Architecture & Core UI**
    1.  Create the React app and install core dependencies (React Router, Axios, Ant Design, etc.).
    2.  Implement the **Application Contexts**: `AuthContext.js` for state management, `ThemeProvider.js`, `LanguageProvider.js`.
    3.  Build the **Layout Components**: `Layout.js`, `Header.js` (with language toggle), `Sidebar.js`, `Footer.js`.
    4.  Establish the global theme (`client/src/styles/theme.js`) and styles with RTL support (`global.css`).

**5. Advanced Authentication System**
    1.  Complete the `User.js` schema and `authService.js` to handle JWT, Google OAuth, and 2FA.
    2.  **Integrate UAE Pass Login:**
        *   **Register as a Service Provider (SP)** with UAE Pass to obtain `client_id` and `client_secret` for production.
        *   **Configure Environment Variables:** Add `UAEPASS_CLIENT_ID`, `UAEPASS_CLIENT_SECRET`, and endpoints for staging (`https://stg-id.uaepass.ae/idshub/`) and production (`https://id.uaepass.ae/idshub/`).
        *   **Implement UAE Pass Auth Service:** Create `server/services/uaepassService.js` to manage the OAuth 2.0 flow: generating the authorization URL, exchanging the code for an access token, and fetching user info (Emirates ID, name, email, mobile).
        *   **Create UAE Pass Login Component:** Build `client/src/components/auth/UaePassLogin.js` to handle the redirection flow. For mobile, implement logic to detect the UAE Pass app and use deep linking (`uaepass://`).
        *   **Link to User Account:** Map the verified Emirates ID (`idn` claim) from UAE Pass to your local user model, creating or linking accounts.
    3.  Build auth UI components: `Login.js` (multi-tab), `Signup.js`, `ForgotPassword.js`.
    4.  Implement `PrivateRoute.js` for role-based access control (Super Admin, Agent, Client, etc.).

**6. Property Management Module**
    1.  Build the `PropertyList.js` and `PropertyCard.js` components for browsing.
    2.  Create `PropertyFilters.js` for advanced search by emirate, type, price, etc.
    3.  Develop the detailed `PropertyDetail.js` view with image gallery.
    4.  Implement agent-facing components: `AddProperty.js` and `EditProperty.js`.

**7. AI, Automation & Dashboard**
    1.  Finalize the AI **Chatbot** component and connect it to the NLP service.
    2.  Complete the **WhatsAppService** webhook integration for lead capture.
    3.  Build the **Dashboard** components (`AdminDashboard.js`, `AgentDashboard.js`) with real-time charts and stats.
    4.  Implement the **Agent Assignment Engine** in the backend and expose its API.

**8. Testing, Security & Deployment**
    1.  Set up the testing framework (Jest, React Testing Library). Write unit tests for utilities, components, and API endpoints.
    2.  Implement comprehensive security: input validation/sanitization, rate limiting, and Helmet.js headers.
    3.  Configure **Vercel Deployment:** Set up `vercel.json`, connect the Git repository, and configure environment variables in the Vercel dashboard.
    4.  Establish monitoring, error tracking (e.g., Sentry), and a database backup strategy.

### Key UAE Pass Integration Details
- **Official UAE Pass Integration Guide** includes both browser-based and mobile-specific flows.
- **API Endpoints:** You will work with Authorization, Token, Userinfo, and Logout endpoints.
- **User Data:** Upon successful authentication, you receive a verified user profile containing their Emirates ID (`idn`), name in Arabic and English, email, and mobile number.
- **Staging vs. Production:** Use the staging environment (`sandbox_stage` credentials) for development. For production, you must register your application and obtain live credentials.

I hope this structured guide provides a clear roadmap for your development team. For a more detailed breakdown of a specific phase, such as the exact API call sequence for UAE Pass, please let me know.


**Remember:** Always test thoroughly before deploying to production. Keep backups of both code and database. Monitor performance metrics regularly and address issues promptly.


# **COMPREHENSIVE STEP-BY-STEP IMPLEMENTATION GUIDE**
## **White Caves Real Estate LLC - Dubai, UAE**

## **ðŸŽ¯ PROJECT OVERVIEW**
**Tech Stack:** MERN (MongoDB, Express, React, Node.js)
**Key Features:** AI Chatbot, WhatsApp Integration, UAE Pass Authentication, Bilingual (EN/AR), Multi-User Roles

---

## **ðŸ“‹ IMPLEMENTATION ROADMAP (14 Phases)**

### **PHASE 1: PROJECT FOUNDATION SETUP (2-3 hours)**
```bash
# Step 1.1: Create Project Structure
mkdir white-caves-realestate
cd white-caves-realestate
mkdir client server shared scripts tests docs
mkdir client/public client/src client/src/components client/src/styles
mkdir server/models server/routes server/controllers server/middleware server/services server/utils

# Step 1.2: Initialize Git Repository
git init
echo "# White Caves Real Estate Platform" >> README.md

# Step 1.3: Create Environment Files
touch .env.template .gitignore .dockerignore .eslintrc.json .prettierrc
touch client/.env.production.local server/.env

# Step 1.4: Initialize Package Files
npm init -y
cd client && npm init -y && cd ..
cd server && npm init -y && cd ..
```

### **PHASE 2: ENVIRONMENT CONFIGURATION (1 hour)**
1. **Configure `.env.template`** with all required variables:
   - MongoDB Atlas connection string
   - JWT secrets (32+ characters)
   - UAE Pass credentials (Client ID/Secret)
   - WhatsApp Business API credentials
   - Google OAuth credentials
   - Email SMTP settings

2. **Set up `.gitignore`** to exclude:
   - Environment files
   - Node modules
   - Build artifacts
   - IDE files

3. **Create root `package.json`** with scripts:
   - `npm run setup` - Full project setup
   - `npm run dev` - Concurrent client/server dev
   - `npm run build` - Production build
   - `npm run test` - Run all tests
   - `npm run deploy` - Deploy to Vercel

### **PHASE 3: DATABASE SCHEMAS DESIGN (3-4 hours)**
**File Structure:**
```
server/models/
â”œâ”€â”€ User.js              # Multi-strategy authentication
â”œâ”€â”€ Property.js          # Real estate properties with UAE fields
â”œâ”€â”€ Agent.js             # Agent profiles & performance
â”œâ”€â”€ Contract.js          # Tenancy contract workflow
â”œâ”€â”€ Lead.js              # Customer leads
â”œâ”€â”€ Transaction.js       # Financial transactions
â””â”€â”€ AuditLog.js          # System audit trail
```

**Key Features to Implement:**
1. **User Schema** with support for:
   - Multiple authentication methods (local, Google, UAE Pass)
   - Role-based permissions (5 roles)
   - UAE-specific fields (Emirates ID validation)
   - 2FA support

2. **Property Schema** with UAE-specific fields:
   - DLD number, Ejari number, DEWA number
   - 7 Emirates support with validation
   - Status tracking with history
   - Multi-language descriptions

### **PHASE 4: BACKEND API DEVELOPMENT (6-8 hours)**
**Step 4.1: Express Server Setup**
```javascript
// server/app.js
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const mongoose = require('./config/database');
const errorHandler = require('./middleware/errorHandler');
```

**Step 4.2: Create API Routes Structure:**
```
server/routes/
â”œâ”€â”€ auth.routes.js           # Authentication endpoints
â”œâ”€â”€ property.routes.js       # Property CRUD operations
â”œâ”€â”€ agent.routes.js          # Agent management
â”œâ”€â”€ dashboard.routes.js      # Analytics & reports
â”œâ”€â”€ chatbot.routes.js        # AI chatbot API
â”œâ”€â”€ whatsapp.routes.js       # WhatsApp webhooks
â”œâ”€â”€ contract.routes.js       # Contract management
â””â”€â”€ uaepass.routes.js        # UAE Pass integration
```

**Step 4.3: Implement Controllers** for each route with:
- Input validation
- Error handling
- Logging
- Response formatting

### **PHASE 5: UAE PASS INTEGRATION (3-4 hours)**
**Step 5.1: UAE Pass Service Provider Registration**
1. **Register at UAE Pass Portal:**
   - Go to https://uaepass.ae/business/
   - Create service provider account
   - Submit company documents (Trade License)
   - Request API credentials for staging & production

2. **Environment Variables for UAE Pass:**
```env
# UAE Pass Integration
UAEPASS_CLIENT_ID=your_client_id_here
UAEPASS_CLIENT_SECRET=your_client_secret_here
UAEPASS_REDIRECT_URI=https://your-domain.vercel.app/api/auth/uaepass/callback
UAEPASS_AUTH_URL=https://stg-id.uaepass.ae/idshub/authorize   # Staging
# UAEPASS_AUTH_URL=https://id.uaepass.ae/idshub/authorize      # Production
UAEPASS_TOKEN_URL=https://stg-id.uaepass.ae/idshub/token      # Staging
UAEPASS_USERINFO_URL=https://stg-id.uaepass.ae/idshub/userinfo # Staging
```

**Step 5.2: Implement UAE Pass Service**
```javascript
// server/services/uaepassService.js
const axios = require('axios');
const qs = require('querystring');

class UaePassService {
  constructor() {
    this.clientId = process.env.UAEPASS_CLIENT_ID;
    this.clientSecret = process.env.UAEPASS_CLIENT_SECRET;
    this.redirectUri = process.env.UAEPASS_REDIRECT_URI;
    this.authUrl = process.env.UAEPASS_AUTH_URL;
    this.tokenUrl = process.env.UAEPASS_TOKEN_URL;
    this.userInfoUrl = process.env.UAEPASS_USERINFO_URL;
  }

  // Generate UAE Pass authorization URL
  getAuthorizationUrl(state, nonce, mobile = false) {
    const params = {
      client_id: this.clientId,
      redirect_uri: this.redirectUri,
      response_type: 'code',
      scope: 'urn:uae:digitalid:profile:general',
      state: state,
      nonce: nonce,
      acr_values: mobile 
        ? 'urn:digitalid:authentication:flow:mobile'
        : 'urn:digitalid:authentication:flow:web',
      ui_locales: 'en' // or 'ar' for Arabic interface
    };

    return `${this.authUrl}?${qs.stringify(params)}`;
  }

  // Exchange authorization code for tokens
  async getTokens(code) {
    const data = qs.stringify({
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: this.redirectUri,
      client_id: this.clientId,
      client_secret: this.clientSecret
    });

    try {
      const response = await axios.post(this.tokenUrl, data, {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json'
        }
      });
      
      return response.data;
    } catch (error) {
      console.error('UAE Pass token error:', error.response?.data || error.message);
      throw new Error('Failed to exchange code for tokens');
    }
  }

  // Get user info with access token
  async getUserInfo(accessToken) {
    try {
      const response = await axios.get(this.userInfoUrl, {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Accept': 'application/json'
        }
      });
      
      // UAE Pass returns verified user information
      return {
        emiratesId: response.data.idn, // Verified Emirates ID
        firstNameEN: response.data.firstname_en,
        lastNameEN: response.data.lastname_en,
        firstNameAR: response.data.firstname_ar,
        lastNameAR: response.data.lastname_ar,
        fullNameEN: response.data.name_en,
        fullNameAR: response.data.name_ar,
        email: response.data.email,
        mobile: response.data.mobile,
        nationalityEN: response.data.nationality_en,
        nationalityAR: response.data.nationality_ar,
        gender: response.data.gender,
        dateOfBirth: response.data.dateofbirth,
        verified: true // All UAE Pass data is government-verified
      };
    } catch (error) {
      console.error('UAE Pass userinfo error:', error.response?.data || error.message);
      throw new Error('Failed to fetch user information');
    }
  }

  // Mobile app deep linking (for UAE Pass app)
  getMobileDeepLink(state, nonce) {
    return `uaepass://authorize?${qs.stringify({
      client_id: this.clientId,
      redirect_uri: this.redirectUri,
      response_type: 'code',
      scope: 'urn:uae:digitalid:profile:general',
      state: state,
      nonce: nonce,
      acr_values: 'urn:digitalid:authentication:flow:mobile'
    })}`;
  }
}

module.exports = UaePassService;
```

**Step 5.3: UAE Pass Authentication Routes**
```javascript
// server/routes/uaepass.routes.js
const express = require('express');
const router = express.Router();
const UaePassService = require('../services/uaepassService');
const crypto = require('crypto');
const User = require('../models/User');
const jwt = require('jsonwebtoken');

const uaePassService = new UaePassService();

// Step 1: Initiate UAE Pass login
router.get('/initiate', (req, res) => {
  try {
    const state = crypto.randomBytes(16).toString('hex');
    const nonce = crypto.randomBytes(16).toString('hex');
    
    // Store state and nonce in session for verification
    req.session.uaepassState = state;
    req.session.uaepassNonce = nonce;
    
    // Check if request is from mobile
    const userAgent = req.headers['user-agent'] || '';
    const isMobile = /mobile|android|iphone|ipad|ipod/i.test(userAgent.toLowerCase());
    
    const authUrl = uaePassService.getAuthorizationUrl(state, nonce, isMobile);
    
    // For mobile, check if UAE Pass app is installed
    if (isMobile) {
      const deepLink = uaePassService.getMobileDeepLink(state, nonce);
      
      return res.json({
        success: true,
        auth_url: authUrl,
        deep_link: deepLink,
        state: state,
        nonce: nonce,
        is_mobile: true
      });
    }
    
    res.json({
      success: true,
      auth_url: authUrl,
      state: state,
      nonce: nonce,
      is_mobile: false
    });
  } catch (error) {
    console.error('UAE Pass initiation error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to initiate UAE Pass login'
    });
  }
});

// Step 2: UAE Pass callback handler
router.get('/callback', async (req, res) => {
  try {
    const { code, state, error, error_description } = req.query;
    
    // Verify state to prevent CSRF
    if (!state || state !== req.session.uaepassState) {
      return res.status(400).json({
        success: false,
        message: 'Invalid state parameter'
      });
    }
    
    if (error) {
      return res.status(400).json({
        success: false,
        message: error_description || 'UAE Pass authentication failed'
      });
    }
    
    if (!code) {
      return res.status(400).json({
        success: false,
        message: 'Authorization code missing'
      });
    }
    
    // Exchange code for tokens
    const tokens = await uaePassService.getTokens(code);
    
    // Get user information
    const userInfo = await uaePassService.getUserInfo(tokens.access_token);
    
    // Find or create user based on Emirates ID
    let user = await User.findOne({ 
      'uaeDetails.emiratesId': userInfo.emiratesId 
    });
    
    if (!user) {
      // Create new user with UAE Pass verified data
      user = new User({
        email: userInfo.email,
        phone: userInfo.mobile,
        profile: {
          firstName: userInfo.firstNameEN,
          lastName: userInfo.lastNameEN,
          fullName: userInfo.fullNameEN,
          arabicName: userInfo.fullNameAR,
          preferredLanguage: 'en'
        },
        uaeDetails: {
          emiratesId: userInfo.emiratesId,
          passportNumber: userInfo.passportNumber,
          nationality: userInfo.nationalityEN,
          dateOfBirth: userInfo.dateOfBirth,
          gender: userInfo.gender,
          verified: true
        },
        authMethods: [{
          provider: 'uaepass',
          providerId: userInfo.emiratesId,
          verified: true,
          primary: true,
          lastUsed: new Date()
        }],
        role: 'client', // Default role
        status: 'active',
        verificationLevel: 'fully_verified' // UAE Pass provides highest verification
      });
      
      await user.save();
      
      // Log the registration
      console.log(`New user registered via UAE Pass: ${userInfo.emiratesId}`);
    } else {
      // Update existing user's UAE Pass auth method
      const uaePassMethod = user.authMethods.find(m => m.provider === 'uaepass');
      
      if (uaePassMethod) {
        uaePassMethod.lastUsed = new Date();
        uaePassMethod.verified = true;
      } else {
        user.authMethods.push({
          provider: 'uaepass',
          providerId: userInfo.emiratesId,
          verified: true,
          primary: true,
          lastUsed: new Date()
        });
      }
      
      // Update verification level
      user.verificationLevel = 'fully_verified';
      user.status = 'active';
      
      await user.save();
    }
    
    // Generate JWT token for the user
    const token = jwt.sign(
      {
        userId: user._id,
        email: user.email,
        role: user.role,
        verificationLevel: user.verificationLevel,
        emiratesId: user.uaeDetails.emiratesId
      },
      process.env.JWT_SECRET,
      { expiresIn: process.env.JWT_EXPIRE || '7d' }
    );
    
    // Clear session data
    delete req.session.uaepassState;
    delete req.session.uaepassNonce;
    
    // Redirect to frontend with token
    const redirectUrl = `${process.env.CLIENT_URL}/auth/callback?token=${token}&emiratesId=${userInfo.emiratesId}`;
    res.redirect(redirectUrl);
    
  } catch (error) {
    console.error('UAE Pass callback error:', error);
    
    // Redirect to error page
    const errorUrl = `${process.env.CLIENT_URL}/auth/error?message=${encodeURIComponent(error.message)}`;
    res.redirect(errorUrl);
  }
});

// Step 3: Get UAE Pass user status
router.get('/status', async (req, res) => {
  try {
    const { emiratesId } = req.query;
    
    if (!emiratesId) {
      return res.status(400).json({
        success: false,
        message: 'Emirates ID is required'
      });
    }
    
    const user = await User.findOne({ 
      'uaeDetails.emiratesId': emiratesId,
      'authMethods.provider': 'uaepass'
    }).select('profile role status verificationLevel');
    
    if (!user) {
      return res.json({
        success: false,
        message: 'User not found'
      });
    }
    
    res.json({
      success: true,
      user: {
        name: user.profile.fullName,
        role: user.role,
        status: user.status,
        verificationLevel: user.verificationLevel,
        hasUaePass: true
      }
    });
  } catch (error) {
    console.error('UAE Pass status error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to get UAE Pass status'
    });
  }
});

module.exports = router;
```

**Step 5.4: UAE Pass React Component**
```javascript
// client/src/components/auth/UaePassLogin.js
import React, { useState, useEffect } from 'react';
import { Button, message, Modal, Steps } from 'antd';
import { IdcardOutlined, MobileOutlined, DesktopOutlined, CheckCircleOutlined } from '@ant-design/icons';
import axios from 'axios';

const { Step } = Steps;

const UaePassLogin = ({ onSuccess, onClose }) => {
  const [loading, setLoading] = useState(false);
  const [authUrl, setAuthUrl] = useState('');
  const [deepLink, setDeepLink] = useState('');
  const [isMobile, setIsMobile] = useState(false);
  const [showMobileOptions, setShowMobileOptions] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);

  useEffect(() => {
    // Detect if user is on mobile
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const mobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
    setIsMobile(mobile);
  }, []);

  const initiateUaePassLogin = async (useMobileApp = false) => {
    try {
      setLoading(true);
      setCurrentStep(1);
      
      const response = await axios.get('/api/auth/uaepass/initiate');
      
      if (response.data.success) {
        setAuthUrl(response.data.auth_url);
        
        if (response.data.is_mobile && useMobileApp) {
          setDeepLink(response.data.deep_link);
          setCurrentStep(2);
          
          // Try to open UAE Pass app
          window.location.href = response.data.deep_link;
          
          // Fallback to web after delay
          setTimeout(() => {
            window.location.href = response.data.auth_url;
          }, 2000);
        } else {
          // Direct web flow
          window.location.href = response.data.auth_url;
        }
      }
    } catch (error) {
      console.error('Failed to initiate UAE Pass:', error);
      message.error('Failed to initiate UAE Pass login');
      setLoading(false);
      setCurrentStep(0);
    }
  };

  const handleWebLogin = () => {
    initiateUaePassLogin(false);
  };

  const handleMobileAppLogin = () => {
    initiateUaePassLogin(true);
  };

  const handleMobileSMSLogin = () => {
    // Alternative: Send SMS with UAE Pass link
    message.info('SMS login option coming soon');
  };

  return (
    <div className="uaepass-login-container">
      <div className="uaepass-header">
        <IdcardOutlined style={{ fontSize: '48px', color: '#1a365d' }} />
        <h2>Login with UAE Pass</h2>
        <p>Government-verified digital identity for secure access</p>
      </div>

      <Steps current={currentStep} className="uaepass-steps">
        <Step title="Choose Method" />
        <Step title="Authenticate" />
        <Step title="Verified" />
      </Steps>

      {currentStep === 0 && (
        <div className="login-methods">
          {isMobile ? (
            <>
              <Button
                type="primary"
                size="large"
                icon={<MobileOutlined />}
                onClick={() => setShowMobileOptions(true)}
                block
                style={{ marginBottom: '16px' }}
              >
                Continue on Mobile
              </Button>
              
              <Button
                type="default"
                size="large"
                icon={<DesktopOutlined />}
                onClick={handleWebLogin}
                block
              >
                Continue on Web
              </Button>
            </>
          ) : (
            <Button
              type="primary"
              size="large"
              icon={<DesktopOutlined />}
              onClick={handleWebLogin}
              block
              loading={loading}
            >
              Continue with UAE Pass
            </Button>
          )}
        </div>
      )}

      {currentStep === 1 && (
        <div className="authenticating">
          <p>Redirecting to UAE Pass authentication...</p>
          <p>Please complete the verification in the UAE Pass app or website.</p>
        </div>
      )}

      {currentStep === 2 && (
        <div className="verification-complete">
          <CheckCircleOutlined style={{ fontSize: '64px', color: '#52c41a' }} />
          <h3>Verification Complete!</h3>
          <p>You have been successfully verified with UAE Pass.</p>
        </div>
      )}

      {/* Mobile Options Modal */}
      <Modal
        title="Choose Mobile Login Method"
        visible={showMobileOptions}
        onCancel={() => setShowMobileOptions(false)}
        footer={null}
        centered
      >
        <div className="mobile-options">
          <Button
            type="primary"
            size="large"
            icon={<MobileOutlined />}
            onClick={handleMobileAppLogin}
            block
            style={{ marginBottom: '12px' }}
          >
            Open UAE Pass App
          </Button>
          
          <Button
            type="default"
            size="large"
            icon={<DesktopOutlined />}
            onClick={handleWebLogin}
            block
            style={{ marginBottom: '12px' }}
          >
            Use Mobile Browser
          </Button>
          
          <Button
            type="default"
            size="large"
            icon={<IdcardOutlined />}
            onClick={handleMobileSMSLogin}
            block
          >
            Receive SMS Link
          </Button>
        </div>
      </Modal>

      <div className="uaepass-footer">
        <p className="disclaimer">
          <small>
            UAE Pass provides government-verified identity. 
            Your Emirates ID and personal information are securely verified.
          </small>
        </p>
        
        <div className="benefits">
          <h4>Benefits of UAE Pass:</h4>
          <ul>
            <li>âœ… Government-verified identity</li>
            <li>âœ… No need for multiple passwords</li>
            <li>âœ… Secure and encrypted</li>
            <li>âœ… Fast and convenient</li>
          </ul>
        </div>
      </div>
    </div>
  );
};

export default UaePassLogin;
```

**Step 5.5: UAE Pass Callback Handler (Frontend)**
```javascript
// client/src/components/auth/UaePassCallback.js
import React, { useEffect } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { Spin, Alert, Result, Button } from 'antd';
import { CheckCircleOutlined, CloseCircleOutlined } from '@ant-design/icons';
import { useAuth } from '../../contexts/AuthContext';
import axios from 'axios';

const UaePassCallback = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { completeLogin } = useAuth();
  
  const token = searchParams.get('token');
  const emiratesId = searchParams.get('emiratesId');
  const error = searchParams.get('error');

  useEffect(() => {
    const handleCallback = async () => {
      if (error) {
        console.error('UAE Pass authentication error:', error);
        return;
      }

      if (token && emiratesId) {
        try {
          // Store the token
          localStorage.setItem('auth_token', token);
          axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
          
          // Get user profile
          const response = await axios.get('/api/auth/profile');
          const userData = response.data;
          
          // Store user data
          localStorage.setItem('user_data', JSON.stringify(userData));
          
          // Update auth context
          completeLogin(token, userData);
          
          // Redirect to dashboard after delay
          setTimeout(() => {
            navigate('/dashboard');
          }, 1500);
          
        } catch (error) {
          console.error('Failed to complete UAE Pass login:', error);
        }
      }
    };

    handleCallback();
  }, [token, emiratesId, error, navigate, completeLogin]);

  if (error) {
    return (
      <div style={{ padding: '50px', textAlign: 'center' }}>
        <Result
          status="error"
          title="UAE Pass Authentication Failed"
          subTitle={error || 'An unknown error occurred'}
          extra={[
            <Button type="primary" key="retry" onClick={() => navigate('/login')}>
              Try Again
            </Button>,
            <Button key="home" onClick={() => navigate('/')}>
              Go Home
            </Button>
          ]}
        />
      </div>
    );
  }

  if (token) {
    return (
      <div style={{ padding: '50px', textAlign: 'center' }}>
        <Result
          icon={<CheckCircleOutlined style={{ color: '#52c41a' }} />}
          title="UAE Pass Verified Successfully!"
          subTitle="You are being redirected to your dashboard..."
          extra={<Spin size="large" />}
        />
      </div>
    );
  }

  return (
    <div style={{ padding: '50px', textAlign: 'center' }}>
      <Spin size="large" />
      <p>Processing UAE Pass authentication...</p>
    </div>
  );
};

export default UaePassCallback;
```

### **PHASE 6: FRONTEND APPLICATION ARCHITECTURE (4-5 hours)**
**Step 6.1: Create React Application Structure**
```bash
cd client
npx create-react-app .
```

**Step 6.2: Install Required Dependencies:**
```bash
# Core dependencies
npm install axios react-router-dom @reduxjs/toolkit react-redux

# UI Components
npm install antd @ant-design/icons styled-components

# Authentication
npm install @react-oauth/google jwt-decode

# Utilities
npm install moment react-phone-number-input react-i18next

# Development
npm install --save-dev eslint prettier eslint-config-prettier
```

**Step 6.3: Create Application Contexts:**
1. **`AuthContext.js`** - User authentication state
2. **`ThemeProvider.js`** - Theme management
3. **`LanguageProvider.js`** - Bilingual support (EN/AR)
4. **`NotificationContext.js`** - System notifications

**Step 6.4: Implement Core Layout Components:**
1. **`Layout.js`** - Main application layout
2. **`Header.js`** - Navigation with language toggle
3. **`Sidebar.js`** - Role-based navigation
4. **`Footer.js`** - Application footer

**Step 6.5: Set Up Routing:**
```javascript
// client/src/App.js
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { AuthProvider } from './contexts/AuthContext';
import PrivateRoute from './components/routing/PrivateRoute';

function App() {
  return (
    <AuthProvider>
      <Router>
        <Routes>
          <Route path="/" element={<HomePage />} />
          <Route path="/login" element={<Login />} />
          <Route path="/register" element={<Register />} />
          <Route path="/auth/uaepass/callback" element={<UaePassCallback />} />
          
          {/* Protected Routes */}
          <Route path="/dashboard" element={
            <PrivateRoute>
              <Dashboard />
            </PrivateRoute>
          } />
          
          <Route path="/properties" element={
            <PrivateRoute>
              <PropertyList />
            </PrivateRoute>
          } />
        </Routes>
      </Router>
    </AuthProvider>
  );
}
```

### **PHASE 7: AUTHENTICATION SYSTEM (4-5 hours)**
**Step 7.1: Complete Multi-Strategy Authentication:**
1. **Local Authentication** (Email/Password)
2. **Phone Authentication** (UAE numbers)
3. **Google OAuth Integration**
4. **UAE Pass Integration** (from Phase 5)
5. **Two-Factor Authentication** (Optional)

**Step 7.2: Create Authentication Components:**
1. **`Login.js`** - Multi-method login page
2. **`Register.js`** - User registration with validation
3. **`ForgotPassword.js`** - Password reset flow
4. **`VerifyAccount.js`** - Email/phone verification

**Step 7.3: Implement Protected Routes:**
```javascript
// client/src/components/routing/PrivateRoute.js
import { Navigate, useLocation } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';

const PrivateRoute = ({ children, roles = [] }) => {
  const { isAuthenticated, user, hasRole } = useAuth();
  const location = useLocation();

  if (!isAuthenticated) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  if (roles.length > 0 && !roles.some(role => hasRole(role))) {
    return <Navigate to="/unauthorized" replace />;
  }

  return children;
};
```

### **PHASE 8: PROPERTY MANAGEMENT MODULE (5-6 hours)**
**Step 8.1: Property Listing Components:**
1. **`PropertyList.js`** - Grid/list view with pagination
2. **`PropertyCard.js`** - Individual property card
3. **`PropertyFilters.js`** - Advanced filtering by:
   - Emirates (7 UAE emirates)
   - Property type (8 types)
   - Price range
   - Bedrooms/bathrooms
   - Amenities

**Step 8.2: Property Detail View:**
1. **`PropertyDetail.js`** - Full property details
2. **`ImageGallery.js`** - Property images with zoom
3. **`VirtualTour.js`** - 360Â° virtual tour integration
4. **`ContactAgent.js`** - Agent contact form
5. **`ScheduleViewing.js`** - Viewing scheduler

**Step 8.3: Admin Property Management:**
1. **`AddProperty.js`** - Add new property with UAE-specific fields
2. **`EditProperty.js`** - Edit existing property
3. **`PropertyStatus.js`** - Status management (available, reserved, sold)

### **PHASE 9: AI & AUTOMATION FEATURES (4-5 hours)**
**Step 9.1: AI Chatbot Implementation:**
1. **`ChatbotService.js`** - NLP processing service
2. **`Chatbot.js`** - React chatbot component
3. **`chatbotTraining.js`** - Training data with Arabic/English support

**Step 9.2: WhatsApp Business Integration:**
1. **Set up Meta Business Account**
2. **Configure WhatsApp Business API**
3. **Implement webhook handlers**
4. **Create chat interface**

**Step 9.3: Agent Assignment Engine:**
1. **Complete `agentAssignment.js`**
2. **Implement scoring algorithm** (expertise, availability, performance)
3. **Create recommendation system**

### **PHASE 10: DASHBOARD & ANALYTICS (3-4 hours)**
**Step 10.1: Dashboard Components:**
1. **`AdminDashboard.js`** - Super admin view
2. **`OwnerDashboard.js`** - Company owner view
3. **`AgentDashboard.js`** - Agent performance dashboard
4. **`ClientDashboard.js`** - Client portal

**Step 10.2: Analytics Implementation:**
1. **Real-time property views**
2. **Lead conversion tracking**
3. **Revenue analytics**
4. **Market trends**
5. **Export functionality**

### **PHASE 11: STYLING & THEMING (2-3 hours)**
**Step 11.1: Global Styles:**
```css
/* client/src/styles/global.css */
/* Base styles with RTL support for Arabic */
```

**Step 11.2: Theme Configuration:**
```javascript
// client/src/styles/theme.js
// UAE-themed color palette
```

**Step 11.3: Responsive Design:**
- Mobile-first approach
- Tablet optimization
- Desktop experience
- Touch-friendly interfaces

### **PHASE 12: TESTING & QUALITY ASSURANCE (3-4 hours)**
**Step 12.1: Set Up Testing Environment:**
```bash
npm install --save-dev jest @testing-library/react @testing-library/jest-dom
```

**Step 12.2: Write Unit Tests:**
1. **Utility functions**
2. **React components**
3. **API endpoints**
4. **Database models**

**Step 12.3: Integration Testing:**
1. **Authentication flow** (including UAE Pass)
2. **Property CRUD operations**
3. **WhatsApp integration**
4. **AI chatbot responses**

**Step 12.4: Security Testing:**
1. **Input validation**
2. **XSS protection**
3. **SQL injection prevention**
4. **Rate limiting**

### **PHASE 13: DEPLOYMENT CONFIGURATION (2-3 hours)**
**Step 13.1: Vercel Deployment Setup:**
1. **Connect GitHub repository**
2. **Configure environment variables**
3. **Set up custom domain** (whitecaves.com)
4. **Configure build settings**

**Step 13.2: Production Configuration:**
1. **Enable SSL/TLS**
2. **Configure CORS**
3. **Set up CDN**
4. **Implement caching**

**Step 13.3: Database Deployment:**
1. **MongoDB Atlas configuration**
2. **Database backups**
3. **Index optimization**
4. **Performance monitoring**

### **PHASE 14: MONITORING & MAINTENANCE (Ongoing)**
**Step 14.1: Set Up Monitoring:**
1. **Error tracking** (Sentry/LogRocket)
2. **Performance monitoring**
3. **User analytics**
4. **Uptime monitoring**

**Step 14.2: Regular Maintenance:**
1. **Weekly:** Check server logs, monitor performance
2. **Monthly:** Security updates, dependency updates
3. **Quarterly:** Code refactoring, performance optimization

**Step 14.3: Backup Strategy:**
1. **Daily:** Database backups
2. **Weekly:** Full system backups
3. **Monthly:** Off-site backups

---

## **ðŸš€ QUICK START COMMANDS**

```bash
# 1. Clone and setup (if starting fresh)
git clone <repository-url>
cd white-caves-realestate
npm run setup

# 2. Development mode
npm run dev

# 3. Run tests
npm test

# 4. Build for production
npm run build

# 5. Deploy to Vercel
npm run deploy
```

---

## **ðŸ”‘ UAE PASS INTEGRATION CHECKLIST**

- [ ] Register as UAE Pass Service Provider
- [ ] Obtain staging credentials for testing
- [ ] Configure environment variables
- [ ] Implement UAE Pass service layer
- [ ] Create authentication routes
- [ ] Build React components
- [ ] Test staging environment
- [ ] Request production credentials
- [ ] Deploy with production UAE Pass

---

## **âš ï¸ CRITICAL SECURITY CHECKS**

1. **Environment Variables:**
   - Never commit `.env` files
   - Use strong JWT secrets (32+ characters)
   - Rotate API keys regularly

2. **Database Security:**
   - Enable MongoDB Atlas encryption
   - Use strong passwords
   - Implement IP whitelisting

3. **API Security:**
   - Validate all inputs
   - Implement rate limiting
   - Use HTTPS everywhere
   - Add CORS protection

---

## **ðŸ“ž SUPPORT & TROUBLESHOOTING**

**Common Issues & Solutions:**

1. **MongoDB Connection Failed:**
   - Check network connectivity
   - Verify IP whitelist in MongoDB Atlas
   - Confirm connection string format

2. **UAE Pass Authentication Issues:**
   - Verify credentials with UAE Pass support
   - Check redirect URI configuration
   - Test in staging environment first

3. **WhatsApp Webhook Errors:**
   - Verify Meta Business setup
   - Check webhook URL accessibility
   - Validate request signatures

---

## **ðŸŽ¯ SUCCESS METRICS & KPIs**

- **Performance:** Page load < 3 seconds
- **Uptime:** 99.9% availability
- **User Authentication:** < 2% failure rate
- **Property Views:** > 1000 daily
- **Lead Conversion:** > 5%
- **Agent Productivity:** 20% increase

---

This comprehensive implementation guide provides a step-by-step roadmap for developing the White Caves Real Estate platform. Each phase builds upon the previous one, ensuring a solid foundation and systematic development approach.

**Key Recommendations:**
1. Start with Phase 1-3 to establish the foundation
2. Implement UAE Pass integration early (Phase 5)
3. Focus on core property management (Phase 8)
4. Test thoroughly before deployment
5. Monitor performance continuously

The platform is designed to scale from 50 to 500+ users and handle 10,000+ property listings with appropriate infrastructure scaling.

**For UAE Pass Production:**
Contact UAE Pass support at support@uaepass.ae for production credential approval after successful staging testing.




This comprehensive catalog provides a complete overview of all modules, features, user roles, and scalability options for your White Caves Real Estate project.
This is a better way to help in software development and architecture with all software engineering best practices.

Please if any module or feature is already added and implemented then remove the duplication and ignore that instruction.

rearrange this again in all listed instructions in logically numbered items.


Please analyze all your text and create a logical, step-by-step instruction guide for the Replit agent. give the structured breakdown:

can you please add an extra part on the instructions list regarding the

